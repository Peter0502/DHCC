<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="01100000000000000000000000000000" TITLE="4615        本代他柜面存款确认"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
}"
</COMMSEND>
<COMMRECV>"{
}"
</COMMRECV>

<USERFUN NAME="saveprint">
"{      
        //用于补打凭证
       	dim @file as file;
       	dim @swtraceno as string;
       	dim @traceno as string;
       	dim @line as string;
  	dim @txamt as string;
  	dim @bal as string;
  	dim @bal2 as string;
  	dim @txtime  as string;
  	dim @txfee as string;
  	dim @feeamt as number;
  	dim @yz37 as string;  //检索参考号
  	@feeamt=val(substr($FD88,1,8),0.01);
       	
       	//写文件，用于补打流水
        @txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);  	
       	@swtraceno = substr($FD52,6,6);
       	@traceno = $FD4; 
       	@txamt = ltrim(comma(itoa(#TXAMT,'%15.2f'),16));
       	@txfee = ltrim(comma(itoa(@feeamt,'%8.2f'),16));
       	@bal = ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16));
       	@bal2 = ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16));
	@file=openfile('../dat/YYHZ_'+$HDATE+'_'+$TLRNO+'_'+@swtraceno+'.dat','ab');
	@line = '7615';
	writeline(@file, @line);
	@line = @swtraceno + '|' + @traceno + '|' + #SBANKCODE + '|' + #CARDNO + '|' + #CZTYPE + '|' + #CUSTNAME + '|' + @txamt + '|' + @txfee + '|' + @bal + '|' + @bal2 + '|'+ @txtime + '|';
	writeline(@file, @line);
       	
	closefile(@file);	
				
}"
</USERFUN>

<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(4615                    本代他柜面存款确认)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=7615)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  <!-- 本代他卡折存款确认输入项显示 -->


  <ITEM LINE="5"   COL="15" TYPE="%-12s" FUNCTIONS="T(原核心流水:)"/>
  <ITEM LINE="6"   COL="15" TYPE="%-12s" FUNCTIONS="T(卡折  标志:!)"/>
  <ITEM LINE="7"   COL="15" TYPE="%-12s" FUNCTIONS="T(开户  行号:)"/>
  <ITEM LINE="8"   COL="15" TYPE="%-12s" FUNCTIONS="T(卡折  号码:)"/>
  <ITEM LINE="9"   COL="15" TYPE="%-12s" FUNCTIONS="T(原操  作员:)"/>
  <ITEM LINE="10"  COL="15" TYPE="%-12s" FUNCTIONS="T(原平台流水:)"/>
  <ITEM LINE="11"  COL="15" TYPE="%-12s" FUNCTIONS="T(存入  金额:)"/>

  <ITEM TYPE="%16s"  NAME="#JJEE"  FUNCTIONS=""/>
  <ITEM TYPE="%19s"  NAME="#ZZHH"  FUNCTIONS=""/>
  <ITEM LINE="5" COL="27" NAME="#OTRACENO" TYPE="%6d" DEVICE="KEYBOARD" FUNCTIONS="T()V(NB)">
  <ONLOSTFOCUS>
  "{
	dim @txno_bak as string;
	dim @tota as string;
	@txno_bak=$TXNO;
	$FD43=#OTRACENO;
	$TXNO='9218';
	commsend_001();
	@tota=callserver(); 

	if($FD12 == 'S045')
	{
		showmsg('该流水号不存在,此交易无法继续');
		return(false);			  
	}
	else if($FD12 != '0000')
	{
		showmsg(geterror());
		return(false);
	}
	$TXNO=@txno_bak;
	    
   }"
  </ONLOSTFOCUS>
  </ITEM> 

  <ITEM LINE="6" COL="27" NAME="#CZFLAG" TYPE="%1d" DEVICE="KEYBOARD" FUNCTIONS="T(0)V(NB)">
    <SELECT LINE="6" COL="29">
	<OPTION VALUE="0" TITLE="有卡"/>
	<OPTION VALUE="1" TITLE="有折"/>
	<OPTION VALUE="2" TITLE="无卡"/>
	<OPTION VALUE="3" TITLE="无折"/>
    </SELECT>
   </ITEM> 
   <ITEM NAME="#CZTYPE" TYPE="%-4s"  FUNCTIONS="S(#CZFLAG,#CZFLAG)"/> 

  <ITEM NAME="#STEP1"  TYPE="%-1s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
	dim @txno_bak as string;
	dim @tota as string;
	initfd();
	@txno_bak=$TXNO;
	$TXNO='7605';
	$FD22='08';
	commsend_001();
	@tota=callagn(); 
	if($FD12 != '0000')
	{
		showmsg(geterror());
		return(false);
	}
	$TXNO=@txno_bak;
	setsel(#BANKCODE,@tota,'o5t20o1v8o2');  
	$MSR2='';    
   }"
  </ONLOSTFOCUS>
  </ITEM>   
  
    <ITEM LINE="7" COL="27" NAME="#BANKCODE" TYPE="%8d" DEVICE="KEYBOARD" FUNCTIONS="T(03090000)V(NB)">
  <SELECT>
	<OPTION VALUE="03090000" TITLE="兴业银行"/>
	</SELECT>
  </ITEM>
  
   <ITEM LINE="8" COL="27" NAME="#CARDNO1" TYPE="%-19s"  DEVICE="MSR" FUNCTIONS="V(NB)M($MSR2,1)">
  <ONLOSTFOCUS>
  "{
	dim @txno_bak as string;
	dim @tota as string;
	initfd();
	@txno_bak=$TXNO;
	
	if( #CZFLAG=='2' or #CZFLAG=='3'   )
	{
		#CARDNO=#CARDNO1;
	}	
	else
	{
		$FD67=#CZFLAG;
		$FD47=#BANKCODE;
		if($MSR2=='')
		{
		  showmsg('请使用读卡器!');
		  //return(false);
		}
		$FD75=$MSR2;
		$FD76=$MSR3;
		$FD22='08';
		$TXNO='7606';
	
		commsend_001();
		@tota=callagn(); 
		if($FD12 != '0000')
		{
			showmsg(geterror());
			return(false);
		}
		
		#CARDNO=$FD33;
		#CARDNO1=$FD33;
		$TXNO=@txno_bak;
		#OTLRNO=$FD7;
	}
   }"
  </ONLOSTFOCUS>
  </ITEM>
<!--  <ITEM LINE="8" COL="25" NAME="#CARDNO" TYPE="%-19s" INPUT="TEXT" FUNCTIONS=""/> -->
  <!--
  <ITEM LINE="8" COL="25" NAME="#CARDNO" TYPE="%-19s" DEVICE="MSR" FUNCTIONS="m($MSR2,1,18)"/>
  -->
  <ITEM LINE="9" COL="27" NAME="#OTLRNO" TYPE="%-6s" INPUT="LABEL" FUNCTIONS="T($TLRNO)"/>
  <ITEM LINE="10" COL="27" NAME="#OYYTRACENO" TYPE="%12d" DEVICE="KEYBOARD" FUNCTIONS="T()V(NB)"/>
  <ITEM LINE="11" COL="27" NAME="#TXAMT" TYPE="%13.2f" DEVICE="KEYBOARD" FUNCTIONS="V(000000000100,999999999999)"/>
  <ITEM NAME="#XTXAMT"  TYPE="%-16s" FUNCTIONS="X(#TXAMT)"/>
  <ITEM NAME="#SBANKCODE" TYPE="%-40s"  FUNCTIONS="S(#BANKCODE,#BANKCODE)"/> 

  <ITEM LINE="21" COL="59" TYPE="%-6s" NAME="#SUBMIT" FUNCTIONS="T(确  定)" INPUT="BUTTON" >
   	<ONCLICK>
   	"{
		dim @tota as string;
		initfd();
		$TXNO='7615';
		$FD67=#CZFLAG;
		$FD30=#CARDNO;
		$FD22='08';
		$FD39=itoa(#TXAMT*100,'%012.0f');
		$FD52 = #OYYTRACENO;
		$FD47=#BANKCODE;
		$FD85=#OTLRNO;

		   $FD75=$MSR2;
		   $FD76=$MSR3;

		commsend_001();            
		@tota=callagn(); 
		#JJEE = $FD39;
		#ZZHH = $FD30;
		// showmsg(#JJEE);added by wanglg  存款确认：如果乱输入数据,会得到正确的金额和账号  哈哈
		// showmsg(#ZZHH);
		
		if($FD12!='0000')
		{
		    showmsg(geterror());
		    return(false);
		}	
		saveprint();
		runoutput(@tota);	
		return(true);	 			 	
		  }"
   	</ONCLICK>
  </ITEM>

  </VARIABLE>

<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="SCREEN" DESC="本代他存款确认">
	NOTHING
</PACKAGE>
	<PRINT> 
	"{
	 	print( 3,27,'本代他存款确认成功!');
		print( 5,10,'帐    号:[19]',#ZZHH);
		print( 6,10,'户    名:[50]',$FD25);
		print( 7,10,'原平台流水:[12]',#OYYTRACENO);
		print( 8,10,'存入金额:[50]',delspace(comma(itoa(val(#JJEE)/100,'%.2f'))));
		if(#CZFLAG=='0' or #CZFLAG=='1' )  //无卡折存款可能是他人存,不显余额
		{
		   	print( 9,10,'账面余额:[16]',ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16)));
		   	print( 10,10,'可用余额:[16]',ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%15.2f'),16)));
    		}
    		print( 11,10,'平台流水:[12]',substr($FD52,6,6));
    
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="PRINTER" LINESPACE="12" DESC="请打印储蓄存款凭证"  CHECK="$FD12=0000">
	NOTHING
</PACKAGE>
	<PRINT> 
	"{  			
	$KINDNO='00';
	dim @txtime  as string;
  	dim @feetype as string;
  	@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
  	dim @feeamt as number;
	    @feeamt=val(substr($FD88,1,8),0.01);
	if($REPRINT=='true')
	{
		reprint_nx();
	}
  	print( 5, 15,' 114      银银合作本代他存款确认 账户行补账成功！请客户本人确认后签名！          4615');
	print( 7, 6,'开户行名:[20]    卡折标志:[16]  受理行:[5][20]      [8]',#SBANKCODE,#CZTYPE,$KINBR,$BRNAME,$HDATE);
	//print( 9, 6,'帐    号:[20]    户    名:[16]  操作员:[25]',#CARDNO,$FD25,$FD7);
	print( 9, 6,'帐    号:[20]    户    名:[16]  操作员:[25]',#ZZHH,$FD25,$FD7);
	//print(11, 6,'存入金额:[20]    账户余额:[16]可用余额:[23] [20] ',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)),ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16)),ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16)),#CARDNO);
	print(11, 6,'存入金额:[20]    账户余额:[16]可用余额:[23] [20] ',delspace(comma(itoa(val(#JJEE)/100,'%.2f'))),ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16)),ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16)),#CARDNO);
	print(13, 6,'平台流水:[20]    ',substr($FD52,6,6));
	print(15, 6,'交易日期:[8] [11]  ',$HDATE,@txtime,);
	print(15, 6,'交易日期:[8] [11]  行内记账手续费:[10]',$HDATE,@txtime,ltrim(comma(itoa(@feeamt,'%8.2f'),16)));

	//print(20,103,'[20]',$FD25);
		
		
	//print(26,103,'[21]',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)));
	//print(26,103,'[21]',delspace(comma(itoa(val(#JJEE)/100,'%.2f'))));
  	
  	}"
  	
	</PRINT>
</RESPONSE>

</TRANSACTION>
