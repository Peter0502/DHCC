<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11000000" TITLE="3706  IC卡账户圈提"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>
 "{
    dim @shuju as string ;
    dim @update as string ;
    initfd();
    commsend_001();
    $FD30=#CARD_NO;
    $FD75=#TRACK2;
    $FD76=#TRACK3;
    $FD35='1';//圈提方式
    $FD36=#CCY ;//币种
    $FD39=#ICLAVBAL*100;//电子现金余额
    //showmsg('电子现金余额='+$FD39);
    $FD40 =#QT_AMT*100; //圈存金额 
    //showmsg('$FD40:'+$FD40);
    $FD45=#ZJZL ;//
    $FD46 = #ZJHM ;
    $FD31=#CARD_NO_IN;
    $FD16 = '7709' ;
    @shuju= initiccard();
    #IC_ATC=strfld(@shuju,'|',2);
    #IC_AC=strfld(@shuju,'|',3);
    #CARD_SEQ_ID=strfld(@shuju,'|',4);
    $FD47 = #IC_ATC ;
    $FD43=#IC_AC ;
    $FD23 =#CARD_SEQ_ID;//IC卡序列号
    if (isTxContinue() == false )
    {
      showmsg('交易过程中不能拔出卡');
      return(false);
    }
    showmsg('请勿拔卡');
    callagn();
    if($FD12!='0000')
    {
      showmsg(geterror());
      return (false);
    }
    #CARD_TRACENO_TRAN=$FD75;
    #CARD_TRACENO_TRAN1=substr($FD43,1,15);
    @update=updateiccard($FD108);
     //showmsg('$FD108='+$FD108);
    if (@update != '9000')
    {
     showmsg('脚本执行错误！@update='+@update);
    }
    //showmsg('脚本执行成功！@update='+@update);
    <!--脚本处理结果通知   -->
    initfd();
    commsend_001();
    $FD16='7767';
    $FD21='1';
    $FD12=@update;
    $FD39=getitems('#QT_AMT');
    $FD43=#CARD_TRACENO_TRAN;
    //showmsg('$FD43='+$FD43);
    callagn();
    if($FD12!='0000')
     {
       showmsg('脚本执行结果返回错误！！！');
       return (false);
     }
    if(($FD12=='0000') and(@update != '9000'))
     {
       showmsg('脚本执行错误，处理通知正常返回，退出交易！！！');
       return (false);
     }
    //showmsg('脚本执行结果返回成功！！！');
    <!--    进核心   -->
    initfd();
    commsend_001();
    $FD16='3706';
    $FD40=getitems('#QT_AMT');   // 交易金额  
    <!--若下方被注起，表示在测试-->   
    $FD64=#ACCNO;                //电子钱包账户记账科目
    $FD67='1';  //圈提标志
    $FD31=delspace(#CARD_NO_IN);
    $FD32=#IN_AC_NO;
   }"
</COMMSEND>
<COMMRECV>
  "{
  
       dim @tmpFD12 as string;   
       @tmpFD12=$FD12;           
     if($FD12=='0000')
      {
        //showmsg('核心成功!');
      }
     else
      {
        //showmsg('核心处理失败，发起撤销交易!');
        dim @tagvalue as string;
        dim @shuju as string;
        dim @update as string;
        @tagvalue= ictagvalue('9f79');
        if(strfld(@tagvalue,'|',0)!='9000')
         {
           showmsg('函数ictagvalue的返回值有误!');
           return(false);
         }
        //showmsg(strfld(@tagvalue,'|',0));      
        @tagvalue= strfld(@tagvalue,'|',1);
        //showmsg('电子现金@tagvalue='+delspace(val(@tagvalue,0.01)));
        initfd();
        commsend_001();
        $FD16='7111';
        $FD30=#CARD_NO;
        $FD75=#TRACK2;
        $FD76=#TRACK3; //三磁     
        $FD21=#CCY;  //$FD21=substr($FD101,140,2);  当前默认只识别RMB
        $FD39=getitems('#QT_AMT');  // 交易金额
        //showmsg('交易金额$FD39='+ $FD39);
        $FD42=itoa(@tagvalue,'%016.2f');    //电子现金卡上的余额
        $FD79=#PASSWORD;
        $FD43=#CARD_TRACENO_TRAN1;   //原交易流水
        //应用交易计数器 IC_ATC 和 应用密文 IC_AC
        @shuju=initiccard();
        #IC_ATC=strfld(@shuju,'|',2);  
        #IC_AC=strfld(@shuju,'|',3);
        #CARD_SEQ_ID=strfld(@shuju,'|',4); 
        $FD34 =#IC_ATC ; //应用计数器
        $FD33 =#IC_AC ;//应用密文
        $FD23 =#CARD_SEQ_ID;//IC卡序列号
        //showmsg('应用JSQ='+$FD34 );       
        //showmsg('应用密文#ICMW='+$FD33);
        //showmsg('IC卡序列号#ICSEQID='+$FD23);
       if(isTxContinue() == false )
       {
         showmsg('交易过程中不能拔出IC卡');
         return(false);
        }
       callagn();
       if($FD12!='0000')
       {
         showmsg(geterror());
         return (false);
       }
       #CARD_TRACENO_TRAN2=$FD75;  
       @update=updateiccard($FD108);
       //showmsg('SYS108='+$FD108);
       if (@update != '9000')
        {
           showmsg('失败@update='+@update);
        }
       //showmsg('@update='+@update);
       //showmsg('开始发脚本处理结果通知!');
       <!--    脚本处理结果通知   -->
    
       initfd();
       commsend_001();
       $FD16='7767';
       $FD21='1';
       $FD12=@update;
       $FD39=getitems('#AMT');
       $FD43=#CARD_TRACENO_TRAN2;
       //showmsg('$FD43='+$FD43);
       callagn();
       if($FD12!='0000')
       {
         showmsg('脚本执行结果返回错误！！！');
         return (false);
        }
        $FD12=@tmpFD12;   
       //showmsg('电子现金撤销交易成功！');
     }
  }"
</COMMRECV>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-54s" FUNCTIONS=
   "T(3706                          IC卡账户圈提)"/>
  <ITEM LINE="4"  COL="3" TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>   
  <ITEM NAME="#TXNO"      TYPE="%-4s"  FUNCTIONS="T($TXNO=3706)"/>
  <ITEM NAME="#MSGTYPE"   TYPE="%-5s"  FUNCTIONS="T($MSGTYPE=03001)"/>
  <ITEM NAME="#TXNAME"    TYPE="%-20s" FUNCTIONS="T(IC卡账户圈提)"/>
  <ITEM NAME="#OPEN_AC_ID"   LINE="4" COL="49" TYPE="%-5s"  VISABLE="false"  FUNCTIONS=""/>
  <PAGE NAME="DEFAULT">
    <ITEM LINE="6" COL="5" TYPE="%-10s"  FUNCTIONS="T(IC卡   号:)"/> 
    <ITEM LINE="6" COL="15" TYPE="%-19s" NAME="#CARD_NO" INPUT="TEXT"  DEVICE="FIXICC"  FUNCTIONS="V(NB)M($MSR2,1)">
      <ONLOSTFOCUS>
      "{
         dim @tota as string;
         dim @tagvalue as string;
         #TRACK2=$MSR2;
         #TRACK3=$MSR3;
         $MSR2='';
         $MSR3='';
         if(len(rtrim(#CARD_NO))!=19)
         {
           showmsg('卡号长度不正确，请重新输入!');
           return(false);
         }
         if(substr(#CARD_NO,0,6) != #CARDBIN1 and substr(#CARD_NO,0,6) != #CARDBIN2)
         {
           showmsg('卡号的前6位必须为'+#CARDBIN1 +'或'+#CARDBIN2);
           return(false);
         }
         initfd();
         commsend_001();
         $FD62=rtrim(#CARD_NO) ;
         $FD16='1717' ;//查询账户信息
         callserver();
         if($FD12!='0000')
         {
           showmsg(geterror());
           return(false);
         }
         
         //设置输入卡号隐藏
         
         enable(#KH_NAME,false);
         showblock('IC_QTKH_INFO',true);
         #KH_NAME=$FD26;//户名
         #OPEN_AC_ID = substr($FD44,3,5);//户名
         @tagvalue= ictagvalue('9f79');
          if(strfld(@tagvalue,'|',0)!='9000')
          {
            showmsg('函数ictagvalue的返回值有误!');
            return(false);
          }
          //showmsg(' 取静态数据返回状态：'+strfld(@tagvalue,'|',0));      
          @tagvalue= strfld(@tagvalue,'|',1);
          //showmsg('电子现金#ICLAVBAL='+delspace(val(@tagvalue,0.01)));
          #ICLAVBAL=val(@tagvalue,0.01);
          enable(#ICLAVBAL,false);
          #ICLAV_ACNO=delspace($FD30);
        }"
      </ONLOSTFOCUS>
    </ITEM>
    <ITEM LINE="6" COL="44"  TYPE="%-22s" FUNCTIONS="T(业务种类: 电子钱包账户)"/> 
    <ITEM LINE="7"  COL="44"   TYPE="%-10s"  FUNCTIONS="T(照    片:)"/> 
    <ITEM LINE="7"  COL="54"   LINES="160"   FUNCTIONS="" COLS="120" NAME="#PIC" TYPE="%-10s" VISABLE="FALSE" />
    <!-- 显示图片信息 start-->
    <ITEM NAME="#LYACNO" TYPE="%-19s" FUNCTIONS="" /> <!---卡号 call_96641用到--->
    <ITEM NAME="#SETPIC" TYPE="%-10s" FUNCTIONS="" >   <!---图片设置--->
      <ONLOSTFOCUS>
       "{
          #LYACNO=#CARD_NO;
          //call_96641(); //根据账卡号获取客户信息
       }"
      </ONLOSTFOCUS>
    </ITEM>	
    <ITEM LINE="8"   COL="5"  TYPE="%-16s" FUNCTIONS="T(【圈出账户信息】)" VISABLE="TRUE" />
    <ITEM LINE="9"  COL="5"   TYPE="%-70s" FUNCTIONS=
    "T(----------------------------------------------------------------------)"/>
    <IMPORT>IC_QTKH_INFO.IMP</IMPORT>
    <ITEM NAME="#IN_AC_NO"        TYPE="%-20s"  FUNCTIONS=""/>  <!---IC卡电子现金内部账户--->
    <ITEM NAME="#ACCNO"           TYPE="%-7s"   FUNCTIONS="">
    <ONLOSTFOCUS>
    "{
      initfd();
      commsend_001();
      $FD31=#CARD_NO;
      $FD16='9162';
      callserver();
      if($FD12!='0000')
      {
        showmsg(geterror());
        return(false);
      }
      #ACCNO=$FD64;//电子钱包账户记账科目 
      #IN_AC_NO=$FD30;
    }"
    </ONLOSTFOCUS>
    </ITEM>
    <ITEM NAME="#ICLAV_ACNO"        TYPE="%-20s"  FUNCTIONS=""/>	
    <ITEM NAME="#CARDBIN1"          TYPE="%-6s"   FUNCTIONS="T(621223)"/>  <!--卡bin1-->
    <ITEM NAME="#CARDBIN2"          TYPE="%-6s"   FUNCTIONS="T(621780)"/>  <!--卡bin2--> 
    <ITEM NAME="#TRACK2"            TYPE="%-37s"  FUNCTIONS="T()"/>        <!--卡二磁-->
    <ITEM NAME="#TRACK3"            TYPE="%-104s" FUNCTIONS="T()"/>	       <!--卡三磁-->
    <ITEM NAME="#CCY"               TYPE="%-3s"   FUNCTIONS="T(1)"/>     <!--交易币种-->
    <ITEM NAME="#CARD_SEQ_ID"       TYPE="%-3s"   FUNCTIONS=""/>           <!--IC卡序列号-->
    <ITEM NAME="#IC_ATC"            TYPE="%-4s"   FUNCTIONS="T()"/>        <!--应用交易计数器-->
    <ITEM NAME="#IC_AC"             TYPE="%-16s"  FUNCTIONS="T()"/>        <!--应用密文-->
    <ITEM NAME="#CARD_TRACENO_TRAN1" TYPE="%-16s" FUNCTIONS=""/>          <!--记录卡系统流水，核心错误撤销时用-->
    <ITEM NAME="#CARD_TRACENO_TRAN2" TYPE="%-16s" FUNCTIONS=""/>          <!--记录原发起撤销交易系统流水用于撤销交易的脚本处理结果通知交易-->
    <ITEM NAME="#CARD_TRACENO_TRAN" TYPE="%-16s"  FUNCTIONS=""/>           <!--记录原发起流水用于脚本处理结果通知交易-->
    <ITEM NAME="#RESP_CODE"         TYPE="%-4s"   FUNCTIONS=""/>
    <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
    <ITEM NAME="#PASSWD" TYPE="%-6s" FUNCTIONS="T()"/>
    <ITEM NAME="#AUCODE" TYPE="%-1s" FUNCTIONS="T(#AUCODE)"/><!---授权标志--->	
    <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>
    </PAGE>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="SCREEN"  DESC="交易完成">
NOTHING
</PACKAGE>
  <PRINT>
  "{
     print(8,25,'操 作 成 功!');
   }"
  </PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(IC卡账户圈出凭证)">
NOTHING
</PACKAGE>
  <PRINT>
  "{
     dim @txday  as string;
     dim @txtime as string;
     @txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
     @txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
     print( 5, 20,'机构名称:[30]',$BRNAME);
     print( 5,  2,'代码:3706');
     print( 5, 13,'交易:IC卡圈提');
     
     print( 7,30,'\L0电子现金圈提\L1');  
     print( 9,20,'开 户 行:[5    ]                  交 易 行:[7]',#OPEN_AC_ID,$FD3);
     print(10, 20,'IC卡 号:[20                    ]    户    名:[20                    ]',#CARD_NO,#KH_NAME);
     print(11, 20,'账户类型:[20                    ]   交易类型:[20                    ]','电子现金账户','转账圈提');
     print(13, 20,'交易金额:[21  ]  电子现金余额:[21                       ]',#QT_AMT,#ICLAVBAL_PZ);
     <!--
     print( 8,20,'圈出账号:[20]',#CARD_NO);
     print( 8,30,'圈出卡客户姓名:[20]',#KH_NAME);
     print( 10,20,'转入账号:[20]',#CARD_NO);
     print( 10,30,'转入卡客户姓名:[20]',#ZR_NAME);
     -->
     print_sq(); 
     print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
     print(21,80,'客户签名:_____________________'); 
	
     print(23,20,'备注:');
     print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
     print(23,5,'柜员:[4]',$FD7);
     print(23,5,'流水号:[6]',$FD4);
  }"
  </PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(电子现金账户圈入凭证)">
NOTHING
</PACKAGE>
  <PRINT>
  "{
     dim @txday  as string;
     dim @txtime as string;
     @txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
     @txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
     print( 5, 20,'机构名称:[30]',$BRNAME);
     print( 5,  2,'代码:3706');
     print( 5, 13,'交易:IC卡圈提');
     
     print( 7,30,'\L0账户存款凭条\L1');  
     print( 9,20,'开 户 行:[5    ]                  交 易 行:[7]',#OPEN_AC_ID,$FD3);
     print(10, 20,'IC卡 号:[20                    ]    户    名:[20                    ]',#CARD_NO_IN,#ZR_NAME);
     print(11, 20,'账户类型:[20                    ]   交易类型:[20                    ]','IC卡活期账户','转账圈提');
     print(13, 20,'交易金额:[21  ]  账户余额:[21                       ]',#QT_AMT,#ICLAVBAL_PZ1);
     <!--
     print( 8,20,'圈出账号:[20]',#CARD_NO);
     print( 8,30,'圈出卡客户姓名:[20]',#KH_NAME);
     print( 10,20,'转入账号:[20]',#CARD_NO);
     print( 10,30,'转入卡客户姓名:[20]',#ZR_NAME);
     -->
     
      print_sq(); 
     print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
     print(21,80,'客户签名:_____________________'); 
	
     print(23,20,'备注:');
     print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
     print(23,5,'柜员:[4]',$FD7);
     print(23,5,'流水号:[6]',$FD4);
  }"
  </PRINT>
</RESPONSE>

</TRANSACTION>

