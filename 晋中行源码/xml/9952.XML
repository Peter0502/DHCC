<?xml version="1.0"  encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111011100000000000001100010" TITLE="绑定/签约状态查询"
xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<VARIABLE>
  <ITEM LINE="3" COL="3"   TYPE="%-70s"    FUNCTIONS="T(9952                        绑定/签约状态查询)"/>
  <ITEM LINE="4" COL="3"   TYPE="%-70s"    FUNCTIONS="T(────────────────────────────────────────)"/>
  <ITEM NAME="#TXNO"       TYPE="%-4s"     FUNCTIONS="T($TXNO=6609)"/>
  <ITEM NAME="#MSGTYPE"    TYPE="%-5s"     FUNCTIONS="T($MSGTYPE=03001)"/>

  <ITEM LINE="6" COL="6"  TYPE="%-12s" NAME="#LSEL_MODE" FUNCTIONS="T(查询方式: )"/>
  <ITEM LINE="6" COL="15" TYPE="%-2s"  NAME="#SEL_MODE"  INPUT="SELECT"   FUNCTIONS="V(NB)T(1)">
    <SELECT>
      <OPTION VALUE="1" TITLE="银行卡"/>
      <OPTION VALUE="2" TITLE="行业用户"/>
    </SELECT>
    <ONLOSTFOCUS>"{
    	if(#SEL_MODE == '1'){
        show(#LBIDQFS,true);
      	enable(#BIDQFS,true);
        show(#BIDQFS,true);
        show(#LBIACTNO,true);

        show(#LAGENT_TYPE,false);
      	enable(#AGENT_TYPE,false);
        show(#AGENT_TYPE,false);
        show(#LCARD_TYPE,false);
      	enable(#CARD_TYPE,false);
        show(#CARD_TYPE,false);
        show(#LYHNAME,false);
      	enable(#YHNAME,false);
        show(#YHNAME,false);
        show(#LADDRESS,false);
      	enable(#ADDRESS,false);
        show(#ADDRESS,false);
        show(#LUSERID,false);
      	enable(#USERID,false);
        show(#USERID,false);
        show(#LCARDCONT,false);
      	enable(#CARDCONT1,false);
        show(#CARDCONT1,false);
      	enable(#CARDCONT,false);
        show(#LBIACTNO1,false);
      	enable(#BIACTNO1,false);
        show(#BIACTNO1,false);
        show(#LBIACNAME,false);
      	enable(#BIACNAME,false);
        show(#BIACNAME,false);
      	enable(#USERQUERY,false);
      }else{
        show(#LAGENT_TYPE,true);
      	enable(#AGENT_TYPE,true);
        show(#AGENT_TYPE,true);
        show(#LCARD_TYPE,true);
      	enable(#CARD_TYPE,true);
        show(#CARD_TYPE,true);
        show(#LYHNAME,true);
      	enable(#YHNAME,true);
        show(#YHNAME,true);
        show(#LADDRESS,true);
      	enable(#ADDRESS,true);
        show(#ADDRESS,true);
        show(#LBIACTNO1,false);
      	enable(#BIACTNO1,true);
        show(#BIACTNO1,true);
        show(#LBIACNAME,false);
      	enable(#BIACNAME,true);
        show(#BIACNAME,true);
      	enable(#USERQUERY,true);

        show(#LBIDQFS,false);
      	enable(#BIDQFS,false);
        show(#BIDQFS,false);
        show(#LBIACTNO,false);
        enable(#ACTNO3,false);
        enable(#ACTNO4,false);
        show(#ACTNO3,false);
        show(#ACTNO4,false);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="8" COL="6"  TYPE="%-10s" NAME="#LBIDQFS"  VISABLE="FALSE"  INPUT="LABEL"  FUNCTIONS="T(读取方式: )"/>
  <ITEM LINE="8" COL="15" TYPE="%-1s"  NAME="#BIDQFS"   VISABLE="FALSE"  INPUT="SELECT" FUNCTIONS="V(NB)T(1)">
    <SELECT>
      <OPTION VALUE="0" TITLE="读取磁条方式"/>
      <OPTION VALUE="1" TITLE="读取芯片方式"/>
    </SELECT>
    <ONLOSTFOCUS>"{
      if(#BIDQFS=='1')
      {
        enable(#ACTNO3,false);
        enable(#ACTNO4,true);
        show(#ACTNO3,false);
        show(#ACTNO4,true);
      }
      if(#BIDQFS=='0')
      {
        enable(#ACTNO3,true);
        enable(#ACTNO4,false);
        show(#ACTNO3,true);
        show(#ACTNO4,false);
      }
      refresh();
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="8" COL="35" NAME="#LBIACTNO" TYPE="%-10s"  VISABLE="FALSE"  INPUT="LABEL"  FUNCTIONS="T(绑定账号:)" />

  <ITEM NAME="#MSR2BAK" TYPE="%-37s"   FUNCTIONS=""/>
  <ITEM NAME="#MSR3BAK" TYPE="%-104s"  FUNCTIONS=""/>
  <ITEM LINE="8" COL="44" TYPE="%-19s"  NAME="#ACTNO3" DEVICE="MSR" INPUT="TEXT" FUNCTIONS="V(NB)M($MSR2,1)" VISABLE="FALSE" >
    <ONLOSTFOCUS>
    "{
      #AC_NO=#ACTNO3;
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="8" COL="44" TYPE="%-19s"  NAME="#ACTNO4" DEVICE="ICC" INPUT="TEXT" FUNCTIONS="V(NB)M($MSR2,1)" VISABLE="FALSE">
    <ONLOSTFOCUS>
    "{
      #AC_NO=#ACTNO4;
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#AC_NO"        TYPE="%-19s"  FUNCTIONS=""/>

  <ITEM LINE="8" COL="6"  TYPE="%-12s" NAME="#LAGENT_TYPE"  VISABLE="FALSE"  FUNCTIONS="T(代收费类型: )"/>
  <ITEM LINE="8" COL="15" TYPE="%-2s"  NAME="#AGENT_TYPE"  INPUT="SELECT"  VISABLE="FALSE"   FUNCTIONS="V(NB)T(01)">
    <SELECT>
      <OPTION VALUE="01" TITLE="晋中燃气"/> 
      <OPTION VALUE="02" TITLE="国新洁源天然气"/>
      <OPTION VALUE="03" TITLE="晋中供水"/>
      <OPTION VALUE="04" TITLE="瑞阳供热"/>
      <OPTION VALUE="07" TITLE="国网晋中供电"/>
    </SELECT>
	  <ONLOSTFOCUS>"{			
	  		if(#AGENT_TYPE == '02')
	   	{
	   		enable(#LCARD_TYPE,true);
	   		enable(#CARD_TYPE,true);
	   	  #CARD_TYPE='02';
	   	}else
	   	{
				#CARD_TYPE = '01';
	   	}
	  }"
	  </ONLOSTFOCUS>
  </ITEM>


  <ITEM LINE="10"   COL="6"  TYPE="%-14s" NAME="#LCARD_TYPE"   VISABLE="FALSE"   FUNCTIONS="T(用户介质类型:)"/>
  <ITEM LINE="10"   COL="17" TYPE="%-2s"  NAME="#CARD_TYPE"    VISABLE="FALSE"   INPUT="SELECT"   FUNCTIONS="V(NB)T()">
    <SELECT>
      <OPTION VALUE="01" TITLE="无卡普表"/>
      <OPTION VALUE="02" TITLE="行业IC卡"/>
     <!-- <OPTION VALUE="03" TITLE="射频卡"/>-->
      <OPTION VALUE="04" TITLE="代码表"/> 
    </SELECT>
    <ONLOSTFOCUS>"{
    	
    	if(#AGENT_TYPE=='02' and #CARD_TYPE=='01')
			{
				showmsg('国新洁源天然气没有普表用户');
				return(false);
			}
			if( #AGENT_TYPE=='04' and #CARD_TYPE=='04')
			{
				showmsg('瑞阳供热没有代码表用户');
				return(false);
			}
			if(#AGENT_TYPE=='07' and #CARD_TYPE!='01')
			{
				showmsg('国网晋中供电只有普表用户');
				return(false);
			}
      if(#CARD_TYPE == '01' or #CARD_TYPE == '04')
      {
        show(#LCARDCONT,false);
        show(#CARDCONT1,false);
        enable(#CARDCONT1,false);
        enable(#CARDCONT,false);

        show(#LUSERID,true);
        show(#USERID,true);
        enable(#USERID,true);
        
      }else{
        enable(#USERID,false);
        show(#LUSERID,false);
        show(#USERID,false);
				
				if(#AGENT_TYPE=='04')
				{
					show(#LCARDCONT,false);
        	show(#CARDCONT1,false);
        	enable(#CARDCONT1,false);
        	enable(#CARDCONT,false);
				}
				else
				{
					show(#LCARDCONT,true);
        	show(#CARDCONT1,true);
        	enable(#CARDCONT1,true);
        	enable(#CARDCONT,true);
				}
				
				//瑞阳专用读卡  begin
			if(#AGENT_TYPE=='04' and #CARD_TYPE == '02')
			{
				if(#AGENT_TYPE ==  '04')
				{
					#RYGRCARD=readheatcard();
					//showmsg('#RYGRCARD='+#RYGRCARD);
					#CARDCONT = #RYGRCARD;
					//showmsg('#CARDCONT='+#CARDCONT);
				}
			}
			//   end
				
      }
      
    }"
    </ONLOSTFOCUS>
  </ITEM>


  <ITEM LINE="10"   COL="33" TYPE="%-22s"  NAME="#LUSERID"  VISABLE="FALSE"  FUNCTIONS="T(用户号/代码表号:)"/>
  <ITEM LINE="10"   COL="46" TYPE="%-20s"  NAME="#USERID"   VISABLE="FALSE"  INPUT="TEXT"   FUNCTIONS="T()V(NB)"/>

  <ITEM LINE="11" COL="6"    TYPE="%-14s"   NAME="#LCARDCONT"  VISABLE="FALSE"  FUNCTIONS="T(用户介质信息:)"/>
  <ITEM LINE="11" COL="17"   TYPE="%-20s"  NAME="#CARDCONT1"   VISABLE="FALSE"  INPUT="TEXT"  DEVICE="SMARTCARD"  FUNCTIONS="V(NB)M($MSR2,1)">
    <ONLOSTFOCUS>"{
      #CARDCONT = $MSR3;
      $MSR2='';
      $MSR3='';
      showmsg('ka内信息：'+#CARDCONT);
      if(len(#CARDCONT) == 0){
        showmsg('没有读到卡信息');
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#CARD_NO"     TYPE="%-30s"      FUNCTIONS="" />
  <ITEM NAME="#CARDCONT"     TYPE="%-512s" FUNCTIONS="" />
  	<ITEM NAME="#RYGRCARD"  TYPE="%-48s" FUNCTIONS="T()"/>

  <ITEM NAME="#USERQUERY"     FUNCTIONS="T()">
    <ONLOSTFOCUS>
    "{
      if(#SEL_MODE == '2'){
        initfd();
        commsend_001();
        $FD16='6601';             //平台用户查询接口
        $FD60='AGENT';            //平台交易类型
        $FD21='01';               //柜面发起标志
        $FD22=#AGENT_TYPE;        //代收费类型
        $FD67='2';                //查询模式 用户唯一标识
        $FD76=#USERID;            //查询内容 用户唯一标识
        $FD23=#CARD_TYPE;         //用户介质类型
        $FD95=#CARDCONT;          //用户介质信息
        $FD38='100';
        
        //瑞阳专用   begin
	if(#AGENT_TYPE == '04' and #CARD_TYPE == '02')
	{
		$FD20='1';   //士达卡标识  1 有卡  0  无卡
	}
	else
	{
		$FD20='0';
	}

        callagnpt();
				if(#AGENT_TYPE!='02' and #AGENT_TYPE!='03' and #AGENT_TYPE!='04' and $FD12!='0000' )
				{
					showmsg(geterror());
					return(false);
				}
				//国新洁源天然气本次购气量不是100/1000的倍数 报0802错误 但此种情况不卡
				if(#AGENT_TYPE=='02' and $FD12!='0802' and $FD12!='0000' )
				{
					showmsg(geterror());
					return(false);
				}
				//自来水欠费超过10W 报0006错误 但此种情况不卡
				if(#AGENT_TYPE=='03' and $FD12!='0006' and $FD12!='0000' )
				{
					showmsg(geterror());
					return(false);
				}
				//瑞阳供热 报0020错误 但此种情况不卡
			if(#AGENT_TYPE=='04' and  $FD12!='0020' and $FD12!='0000')
			{
				showmsg(geterror());
				return(false);
			}
			if(#AGENT_TYPE=='04' and  $FD12=='0020')
			{
			    	#USERID=delspace($FD30);           //用户唯一标识
				#YHNAME=delspace($FD25);         //用户姓名
				#ADDRESS=delspace($FD26);          //用户地址
			}
			else
			{
				#USERID=delspace($FD30);		//用户唯一标识
			    	#CARD_NO=delspace($FD37);
			    	#YHNAME=delspace($FD25);         //用户姓名
			    	#ADDRESS=delspace($FD96);        //用户地址
			}
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="13"  COL="6" NAME="#LYHNAME"   TYPE="%-12s"  VISABLE="FALSE"     FUNCTIONS="T(用户姓名:)"/>
  <ITEM LINE="13"  COL="17" NAME="#YHNAME"   TYPE="%-40s"   VISABLE="FALSE"    INPUT="LABEL" FUNCTIONS="T()"/>
  <ITEM LINE="14"  COL="6"  NAME="#LADDRESS" TYPE="%-12s"   VISABLE="FALSE"    FUNCTIONS="T(地    址:)"/>
  <ITEM LINE="14"  COL="17" NAME="#ADDRESS"  TYPE="%-64s"   VISABLE="FALSE"    INPUT="LABEL" FUNCTIONS="T()"/>

  <ITEM LINE="15" COL="3"  NAME="#L_LINE"  TYPE="%-110s"  VISABLE="FALSE" FUNCTIONS="T(----------------------------------------------------------------------------------------------------------)"/>

  <ITEM LINE="16" COL="6" NAME="#LBIACTNO1" TYPE="%-10s"  VISABLE="FALSE"  INPUT="LABEL"  FUNCTIONS="T(绑定账号:)" />
  <ITEM LINE="16" COL="17" NAME="#BIACTNO1"  INPUT="LABEL" TYPE="%-19s"  VISABLE="FALSE" FUNCTIONS="V(NB)"/>
  <ITEM LINE="16" COL="41" NAME="#LBIACNAME"  INPUT="LABEL" TYPE="%-10s" VISABLE="FALSE"  FUNCTIONS="T(户名:)"/>
  <ITEM LINE="16" COL="51" NAME="#BIACNAME"   INPUT="LABEL" TYPE="%-60s"  VISABLE="FALSE"  FUNCTIONS="V(NB)"/>

  <ITEM LINE="17" COL="6"  NAME="#LBI_DATE" INPUT="LABEL" TYPE="%-14s" VISABLE="FALSE" FUNCTIONS="T(用户绑定日期:)"/>
  <ITEM LINE="17" COL="17" NAME="#BI_DATE"  INPUT="LABEL" TYPE="%-8s"  VISABLE="FALSE" FUNCTIONS="V(NB)"/>
  <ITEM LINE="17" COL="41" NAME="#LBI_TEL"  INPUT="LABEL" TYPE="%-14s" VISABLE="FALSE"  FUNCTIONS="T(绑定操作柜员:)"/>
  <ITEM LINE="17" COL="52" NAME="#BI_TEL"   INPUT="LABEL" TYPE="%-4s"  VISABLE="FALSE"  FUNCTIONS="V(NB)"/>

  <ITEM NAME="#AG_STS"   INPUT="LABEL" TYPE="%-2s" />
  <ITEM NAME="#AG_DATE"  INPUT="LABEL" TYPE="%-8s" />

  <ITEM LINE="18" COL="6"  NAME="#LAG_Q_DATE" INPUT="LABEL" TYPE="%-16s" VISABLE="FALSE" FUNCTIONS="T(代扣签约日期:)" />
  <ITEM LINE="18" COL="17" NAME="#AG_Q_DATE"  INPUT="LABEL" TYPE="%-8s" VISABLE="FALSE" FUNCTIONS="V(NB)"/>
  <ITEM LINE="18" COL="41" NAME="#LAG_Q_TEL"  INPUT="LABEL" TYPE="%-17s" VISABLE="FALSE" FUNCTIONS="T(签约操作柜员:)" />
  <ITEM LINE="18" COL="52" NAME="#AG_Q_TEL"   INPUT="LABEL" TYPE="%-4s"  VISABLE="FALSE" FUNCTIONS="V(NB)"/>

  <ITEM LINE="18" COL="6"  NAME="#LAG_J_DATE" INPUT="LABEL" TYPE="%-16s" VISABLE="FALSE" FUNCTIONS="T(代扣解约日期:)" />
  <ITEM LINE="18" COL="17" NAME="#AG_J_DATE"  INPUT="LABEL" TYPE="%-8s" VISABLE="FALSE" FUNCTIONS="V(NB)"/>
  <ITEM LINE="18" COL="41" NAME="#LAG_J_TEL"  INPUT="LABEL" TYPE="%-17s" VISABLE="FALSE" FUNCTIONS="T(解约操作柜员:)" />
  <ITEM LINE="18" COL="52" NAME="#AG_J_TEL"   INPUT="LABEL" TYPE="%-4s"  VISABLE="FALSE" FUNCTIONS="V(NB)"/>

   <ITEM  NAME="#BTN" LINE="21"  COL="63" TYPE="%-6s"    FUNCTIONS="T(确  定)" INPUT="BUTTON">
     <ONCLICK>"{
       if(#SEL_MODE == '1'){
         dim @tota as string;
         dim @selid as number;
         initfd();
         commsend_001();
         $FD16='6609';             //平台用户交易明细查询接口
         $FD60='AGENT';            //平台交易类型
         $FD21='1';                //柜面发起标志
         $FD31=#AC_NO;             //账号

         @tota=callagnpt();
         if($FD12!='0000'){
           showmsg(geterror());
           return(false);
         }
         @tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
         if(@tota==''){
           showmsg('未找到该用户记录!');
           rerun();
           return(false);
         }
         autolist(@tota);
         @selid=list_work();
         rerun();
       }
       else{
         show(#L_LINE,true);
         initfd();
         commsend_001();
         $FD16='6608';             //平台绑定及代扣状态查询接口
         $FD60='AGENT';            //平台交易类型
         $FD21='01';               //柜面发起标志
         $FD22=#AGENT_TYPE;        //代收费类型
         $FD30=#USERID;            //用户唯一标识
         if(#AGENT_TYPE == '04')
         {
         	$FD23='01';         //用户介质类型
         }
         else
         {
         	$FD23=#CARD_TYPE;         //用户介质类型
         }
         $FD37=#CARD_NO;           //用户介质号

         callagnpt();
         if($FD12!='0000'){
           showmsg(geterror());
           return(false);
         }
         /*显示绑定信息*/
         #BIACTNO1=delspace($FD31);
         #BI_DATE=delspace($FD44);  //用户绑定日期
         #BI_TEL=delspace($FD64);   //绑定操作柜员
         /*显示签约信息*/
         #AG_STS=delspace($FD70);   //代扣签/解约状态
         #AG_DATE=delspace($FD29);  //代扣签/解约日期

         if(#AG_STS=='0'){
           #AG_Q_DATE=delspace($FD45);  //代扣签约日期
           #AG_Q_TEL=delspace($FD65);   //代扣签约操作柜员
         }else{
           #AG_J_DATE=delspace($FD45);  //代扣解约日期
           #AG_J_TEL=delspace($FD65);   //代扣解约操作柜员
         }
         if(#AG_STS=='' and #AG_DATE=='') //第一次绑定时默认解约不显示
         {
           show(#LAG_Q_DATE,false);
           show(#AG_Q_DATE,false);
           show(#LAG_Q_TEL,false);
           show(#AG_Q_TEL,false);
           show(#LAG_J_DATE,false);
           show(#AG_J_DATE,false);
           show(#LAG_J_TEL,false);
           show(#AG_J_TEL,false);
         }
         else{
           if(#AG_STS=='0'){
             show(#LAG_Q_DATE,true);
             show(#AG_Q_DATE,true);
             show(#LAG_Q_TEL,true);
             show(#AG_Q_TEL,true);
           }
           else{
             show(#LAG_J_DATE,true);
             show(#AG_J_DATE,true);
             show(#LAG_J_TEL,true);
             show(#AG_J_TEL,true);
           }
         }

		    //代收账号查询
		    initfd();
		    commsend_001();
		    $FD16='6600';             //平台代收账号查询接口
		    $FD60='AGENT';            //平台交易类型
		    $FD21='01';               //柜面发起标志
		    $FD22=#AGENT_TYPE;        //代收费类型
		    $FD31=#BIACTNO1;          //账号
		    $FD49='1';                //不校验账户状态

		    callagnpt();
		    if($FD12!='0000'){
		      showmsg(geterror());
		      return(false);
		    }
		    #BIACNAME=delspace($FD26);

        show(#LBIACTNO1,true);
        show(#BIACTNO1,true);
        show(#LBIACNAME,true);
        show(#BIACNAME,true);
        show(#LBI_DATE,true);
        show(#BI_DATE,true);
        show(#LBI_TEL,true);
        show(#BI_TEL,true);
	      showmsg('查询成功!!!');

	      runoutput();
        rerun();
       }
     }"
    </ONCLICK>
  </ITEM>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
</RESPONSE>
<OUTPUT>
</OUTPUT>
</TRANSACTION>
