<?xml version="1.0"  encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111011100000000000001100010" TITLE="用户交易明细查询"
xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<VARIABLE>
  <ITEM LINE="3" COL="3"   TYPE="%-70s"    FUNCTIONS="T(9955                        用户交易明细查询)"/>
  <ITEM LINE="4" COL="3"   TYPE="%-70s"    FUNCTIONS="T(────────────────────────────────────────)"/>
  <ITEM NAME="#TXNO"       TYPE="%-4s"     FUNCTIONS="T($TXNO=6606)"/>
  <ITEM NAME="#MSGTYPE"    TYPE="%-5s"     FUNCTIONS="T($MSGTYPE=03001)"/>

  <ITEM LINE="6" COL="6"  TYPE="%-12s" NAME="#LAGENT_TYPE" FUNCTIONS="T(代收费类型: )"/>
  <ITEM LINE="6" COL="15" TYPE="%-2s"  NAME="#AGENT_TYPE"  INPUT="SELECT"   FUNCTIONS="V(NB)T(02)">
    <SELECT>
      <OPTION VALUE="01" TITLE="燃气"/>
      <OPTION VALUE="02" TITLE="天然气"/>
	    <OPTION VALUE="03" TITLE="自来水"/>
    </SELECT>
  </ITEM>

  <ITEM LINE="7" COL="6"  TYPE="%-10s" NAME="#LBIFS" FUNCTIONS="T(绑定方式: )"/>
  <ITEM LINE="7" COL="15" TYPE="%-1s"  NAME="#BIFS"  INPUT="SELECT" FUNCTIONS="V(NB)T(0)">
    <SELECT>
      <OPTION VALUE="0" TITLE="已绑定用户代码"/>
      <OPTION VALUE="1" TITLE="未绑定用户代码"/>
    </SELECT>
    <ONLOSTFOCUS>"{
      if(#BIFS=='0')
      {
        show(#LBIDQFS,true);
        show(#BIDQFS,true);
        show(#LBIACTNO,true);
        show(#LACNAME,true);
        show(#AC_NAME,true);
        enable(#BIUSER_NO,true);
        show(#BIUSER_NO,true);
        enable(#BI_CARDTYPE,true);
        enable(#BI_CARDNO,true);
        enable(#USER_NO,false);
        show(#USER_NO,false);
        enable(#USER_NO1,false);
        show(#USER_NO1,false);
        show(#LCARDTYPE,false);
        show(#CARDTYPE,false);
        enable(#CARDTYPE,false);
        show(#LCARDCONT,false);
        enable(#CARDNO,false);
        show(#CARDNO,false);
      }
      if(#BIFS=='1')
      {
        show(#LBIDQFS,false);
        show(#BIDQFS,false);
        show(#LBIACTNO,false);
        enable(#ACTNO3,false);
        enable(#ACTNO4,false);
        show(#ACTNO3,false);
        show(#ACTNO4,false);
        show(#LACNAME,false);
        show(#AC_NAME,false);
        show(#LBI_CARDTYPE,false);
        show(#BI_CARDTYPE,false);
        enable(#BI_CARDTYPE,false);
        show(#LBI_CARDCONT,false);
        show(#BI_CARDNO,false);
        enable(#BI_CARDNO,false);
        enable(#BIUSER_NO,false);
        show(#BIUSER_NO,false);
        show(#LCARDTYPE,true);
        show(#CARDTYPE,true);
        enable(#CARDTYPE,true);
        show(#CARDCONT,true);
        enable(#CARDCONT,true);
        enable(#USER_NO,false);
        show(#USER_NO,false);
        enable(#USER_NO1,false);
        show(#USER_NO1,false);
      }
     }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="8" COL="6"  TYPE="%-10s" NAME="#LBIDQFS" VISABLE="FALSE"  INPUT="LABEL"  FUNCTIONS="T(读取方式: )"/>
  <ITEM LINE="8" COL="15" TYPE="%-1s"  NAME="#BIDQFS"  VISABLE="FALSE"  INPUT="SELECT" FUNCTIONS="V(NB)T(1)">
    <SELECT>
      <OPTION VALUE="0" TITLE="读取磁条方式"/>
      <OPTION VALUE="1" TITLE="读取芯片方式"/>
    </SELECT>
    <ONLOSTFOCUS>"{
      if(#BIDQFS=='1')
      {
        enable(#ACTNO3,false);
        enable(#ACTNO4,true);
        show(#ACTNO3,false);
        show(#ACTNO4,true);
      }
      if(#BIDQFS=='0')
      {
        enable(#ACTNO3,true);
        enable(#ACTNO4,false);
        show(#ACTNO3,true);
        show(#ACTNO4,false);
      }
      refresh();
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="8" COL="35" NAME="#LBIACTNO" TYPE="%-10s"  VISABLE="FALSE" INPUT="LABEL"  FUNCTIONS="T(支付账号:)" />

  <ITEM NAME="#MSR2BAK" TYPE="%-37s"   FUNCTIONS=""/>
  <ITEM NAME="#MSR3BAK" TYPE="%-104s"  FUNCTIONS=""/>
  <ITEM LINE="8" COL="44" TYPE="%-19s"  NAME="#ACTNO3" DEVICE="MSR" INPUT="TEXT" FUNCTIONS="V(NB)M($MSR2,1)" VISABLE="FALSE" >
    <ONLOSTFOCUS>
    "{
      #AC_NO=#ACTNO3;
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="8" COL="44" TYPE="%-19s"  NAME="#ACTNO4" DEVICE="ICC" INPUT="TEXT" FUNCTIONS="V(NB)M($MSR2,1)" VISABLE="FALSE">
    <ONLOSTFOCUS>
    "{
      #AC_NO=#ACTNO4;
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="8"   COL="6"  TYPE="%-14s"   NAME="#LBI_CARDTYPE"  VISABLE="FALSE"  FUNCTIONS="T(用户介质类型:)"/>
  <ITEM LINE="8"   COL="17" TYPE="%-10s"   NAME="#BI_CARDTYPE"   VISABLE="FALSE"  INPUT="LABEL"   FUNCTIONS="V(NB)"/>

  <ITEM LINE="8"   COL="6"  TYPE="%-14s" NAME="#LCARDTYPE"   VISABLE="FALSE"  FUNCTIONS="T(用户介质类型:)"/>
  <ITEM LINE="8"   COL="17" TYPE="%-2s"  NAME="#CARDTYPE"    VISABLE="FALSE" INPUT="SELECT"   FUNCTIONS="V(NB)T(01)">
    <SELECT>
      <OPTION VALUE="01" TITLE="无卡普表"/>
      <OPTION VALUE="02" TITLE="IC卡"/>
      <OPTION VALUE="03" TITLE="射频卡"/>
      <OPTION VALUE="04" TITLE="代码表"/>
    </SELECT>
    <ONLOSTFOCUS>"{
      if(#CARDTYPE == '01' or #CARDTYPE == '04')
      {
        show(#LCARDCONT,false);
        show(#CARDNO,false);
        enable(#CARDNO,false);
        enable(#USER_NO1,false);
        show(#USER_NO1,false);
        enable(#USER_NO,true);
        show(#USER_NO,true);
      }else{
        show(#LCARDCONT,true);
        show(#CARDNO,true);
        enable(#CARDNO,true);
        enable(#USER_NO,false);
        show(#USER_NO,false);
        enable(#USER_NO1,true);
        show(#USER_NO1,true);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="9" COL="6"   TYPE="%-14s"   NAME="#LBI_CARDCONT"  VISABLE="FALSE"  FUNCTIONS="T(用户介质信息:)"/>
	<ITEM LINE="9" COL="17"  NAME="#BI_CARDNO"  VISABLE="FALSE"  TYPE="%-30s" INPUT="TEXT" DEVICE="SMARTCARD" FUNCTIONS="V(NB)M($MSR2,1)" >
    <ONLOSTFOCUS>"{
      #BI_CARDCONT = $MSR3;
	    $MSR2='';
		  $MSR3='';
      showmsg('ka内信息：'+#BI_CARDCONT);
  }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM  TYPE="%-512s"  VISABLE="FALSE"  NAME="#BI_CARDCONT"   />

  <ITEM LINE="9" COL="6"    TYPE="%-14s"   NAME="#LCARDCONT"  VISABLE="FALSE"  FUNCTIONS="T(用户介质信息:)"/>
  <ITEM LINE="9" COL="17"   TYPE="%-20s"  NAME="#CARDNO"   VISABLE="FALSE"  INPUT="TEXT"  DEVICE="SMARTCARD"  FUNCTIONS="V(NB)M($MSR2,1)">
    <ONLOSTFOCUS>"{
      #CARDCONT = $MSR3;
	    $MSR2='';
		  $MSR3='';
      showmsg('ka内信息：'+#CARDCONT);
    }"
    </ONLOSTFOCUS>
  </ITEM>
  <ITEM  TYPE="%-512s"  VISABLE="FALSE"  NAME="#CARDCONT"   />

  <ITEM NAME="#AC_NO"        TYPE="%-19s"  FUNCTIONS=""/>
  <ITEM NAME="#BI_CARDTYPE"  TYPE="%-2s"   FUNCTIONS=""/>
  <ITEM NAME="#BI_CARD_NO"   TYPE="%-30s"  FUNCTIONS=""/>

  <ITEM  LINE="12"   COL="6" NAME="#LUSER_NO" TYPE="%-12s"  FUNCTIONS="T(用户代码:)"/>
  <ITEM  LINE="12"   COL="15"  NAME="#BIUSER_NO" INPUT="LABEL" TYPE="%-20s"  VISABLE="FALSE"  FUNCTIONS="" >
    <ONLOSTFOCUS>
    "{
      if(#BIFS=='0')
      {
        //查询该卡的账户名
        initfd();
        commsend_001();
        $FD16='6600';             //平台代收账号查询接口
        $FD60='AGENT';            //平台交易类型
        $FD21='01';               //柜面发起标志
        $FD22=#AGENT_TYPE;        //代收费类型
        $FD31=#AC_NO;             //账号
        $FD49='1';                //不校验账户状态

        callagnpt();
        if($FD12!='0000'){
          showmsg(geterror());
          return(false);
        }
        #AC_NAME=delspace($FD26);

        //查询该卡所绑定的用户代码，介质类型，介质号
        initfd();
        $FD16='6608';             //平台绑定及代扣状态查询接口
        $FD60='AGENT';            //平台交易类型
        $FD21='01';               //柜面发起标志
        $FD22=#AGENT_TYPE;        //代收费类型
        $FD31=#AC_NO;             //用户代码

        callagnpt();
        if($FD12!='0000'){
          showmsg(geterror());
          return(false);
        }

        #BIUSER_NO=delspace($FD30);       //已绑定用户代码
        #BI_CARDTYPE=delspace($FD23);     //已绑定用户介质类型
        #BI_CARD_NO=delspace($FD37);      //已绑定用户介质号
        //用户介质类型是IC卡或射频卡时需要读卡内信息
        if(#CARDTYPE=='2' or #CARDTYPE=='3'){
            show(#LBI_CARDTYPE,true);
            show(#BI_CARDTYPE,true);
            enable(#BI_CARDTYPE,true);
            show(#LBI_CARDCONT,true);
            show(#BI_CARDNO,true);
            enable(#BI_CARDNO,true);
        }
showmsg('#USERID=='+#BIUSER_NO);
showmsg('#CARDTYPE=='+#BI_CARDTYPE);
showmsg('#CARD_NO=='+#BI_CARD_NO);

        //查询该卡所绑定的用户代码对应的用户名和地址
        initfd();
        commsend_001();
        $FD16='6601';             //平台用户查询接口
        $FD60='AGENT';            //平台交易类型
        $FD21='01';               //柜面发起标志
        $FD22=#AGENT_TYPE;        //代收费类型
        $FD67='2';                //查询模式 用户唯一标识
        $FD38='0';
        $FD76=#BIUSER_NO;         //查询内容 用户唯一标识
        $FD23=#BI_CARDTYPE;       //用户介质类型
        $FD95=#BI_CARDCONT;       //用户介质信息

        callagnpt();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }

        #YHNAME=delspace($FD25);         //用户姓名
        #ADDRESS=delspace($FD96);        //用户地址

        enable(#YHNAME,false);
        enable(#ADDRESS,false);
        show(#YHNAME,true);
        show(#ADDRESS,true);
      }else{
        showmsg('交易异常,未绑定的用户不应该使用BIUSER_NO，请于科技部联系!!!!!');
        return(false);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="12"   COL="15" NAME="#USER_NO" INPUT="TEXT" TYPE="%-20s"  FUNCTIONS="V(NB)">
    <ONLOSTFOCUS>
    "{
      if(#BIFS=='1')                   //未绑定卡的普表或代码表用户代码
      {
        if(#CARDTYPE == '01' or #CARDTYPE == '04')
        {
          $FD16='6601';                  //平台用户查询接口
          $FD60='AGENT';                 //平台交易类型
          $FD21='01';                    //柜面发起标志
          $FD22=#AGENT_TYPE;             //代收费类型
          $FD67='2';                     //查询模式 用户唯一标识
          $FD76=#USER_NO;                //查询内容 用户唯一标识
          $FD38='0';
          $FD23=#CARDTYPE;               //用户介质类型
          $FD95=#CARDCONT;               //用户介质信息

          callagnpt();
          if($FD12!='0000')
          {
            showmsg(geterror());
            return(false);
          }

          #USER_NO=delspace($FD30);
          #CARD_NO=delspace($FD37);
showmsg('#USERID=='+#USER_NO);
showmsg('#CARD_NO=='+#CARD_NO);
          #YHNAME=delspace($FD25);         //用户姓名
          #ADDRESS=delspace($FD96);        //用户地址

          enable(#YHNAME,false);
          enable(#ADDRESS,false);
          show(#YHNAME,true);
          show(#ADDRESS,true);
        }else{
          showmsg('交易异常,普表或代码表的用户不应该使用USER_NO，请于科技部联系!!!!!');
          return(false);
        }
      }else{
        showmsg('交易异常,绑定的用户不应该使用USER_NO，请于科技部联系!!!!!');
        return(false);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="12"   COL="15" NAME="#USER_NO1" INPUT="LABEL" TYPE="%-20s"  FUNCTIONS="V(NB)">
    <ONLOSTFOCUS>
    "{
      if(#BIFS=='1')                   //未绑定卡的IC卡或射频卡用户代码
      {
        if(#CARDTYPE == '02' or #CARDTYPE == '03')
        {
          $FD16='6601';                  //平台用户查询接口
          $FD60='AGENT';                 //平台交易类型
          $FD21='01';                    //柜面发起标志
          $FD22=#AGENT_TYPE;             //代收费类型
          $FD67='2';                     //查询模式 用户唯一标识
          $FD76=#USER_NO1;               //查询内容 用户唯一标识
          $FD38='0';
          $FD23=#CARDTYPE;               //用户介质类型
          $FD95=#CARDCONT;               //用户介质信息

          callagnpt();
          if($FD12!='0000')
          {
            showmsg(geterror());
            return(false);
          }

          #USER_NO1=delspace($FD30);
          #CARD_NO1=delspace($FD37);
showmsg('#USERID=='+#USER_NO);
showmsg('#CARD_NO=='+#CARD_NO);
          #YHNAME=delspace($FD25);         //用户姓名
          #ADDRESS=delspace($FD96);        //用户地址

          enable(#YHNAME,false);
          enable(#ADDRESS,false);
          show(#YHNAME,true);
          show(#ADDRESS,true);
        }else{
          showmsg('交易异常,IC卡或射频卡的用户不应该使用USER_NO1，请于科技部联系!!!!!');
          return(false);
        }
      }else{
        showmsg('交易异常,绑定的用户不应该使用USER_NO1，请于科技部联系!!!!!');
        return(false);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM LINE="9" COL="6"  NAME="#LACNAME" VISABLE="FALSE"  INPUT="LABEL"  TYPE="%-10s" FUNCTIONS="T(户    名:)" />
  <ITEM LINE="9" COL="15" NAME="#AC_NAME" VISABLE="FALSE"  INPUT="LABEL"  TYPE="%-60s" FUNCTIONS="V(NB)"/>

  <ITEM LINE="10" COL="6"  TYPE="%-80s" VISABLE="TRUE" FUNCTIONS="T(-------------------------------------------------------------------------------)"/>

  <ITEM LINE="12"  COL="35" NAME="#LYHNAME"  TYPE="%-12s"    FUNCTIONS="T(用户姓名:)"/>
  <ITEM LINE="12"  COL="45" NAME="#YHNAME"   TYPE="%-40s"    INPUT="LABEL" FUNCTIONS="T()"/>
  <ITEM LINE="13"  COL="6"  NAME="#LADDRESS" TYPE="%-12s"    FUNCTIONS="T(地    址:)"/>
  <ITEM LINE="13"  COL="15" NAME="#ADDRESS"  TYPE="%-64s"    INPUT="LABEL" FUNCTIONS="T()"/>

  <ITEM LINE="15"  COL="6"  TYPE="%-14s"    FUNCTIONS="T(交易类型:)"/>
  <ITEM LINE="15"  COL="15" NAME="#TX_TYPE"  TYPE="%-1s"  INPUT="SELECT" FUNCTIONS="T(0)V(NB)">
    <SELECT>
      <OPTION VALUE="0" TITLE="0.全部"/>
      <OPTION VALUE="1" TITLE="1.记账类"/>
      <OPTION VALUE="2" TITLE="2.非记账类"/>
    </SELECT>
  </ITEM>

  <ITEM LINE="17" COL="6" TYPE="%-10s" FUNCTIONS="T(交易日期:)"/>
  <ITEM LINE="17" COL="24" TYPE="%-3s" FUNCTIONS="T( → )"/>
  <ITEM LINE="17" COL="15" NAME="#BEG_DATE" INPUT="TEXT"  TYPE="%8s" FUNCTIONS="V(00000001,99999999)"/>
  <ITEM LINE="17" COL="28" NAME="#END_DATE" INPUT="TEXT"  TYPE="%8s" FUNCTIONS="T($HDATE)V(00000001,99999999)">
    <ONLOSTFOCUS>
    "{
      if(len(delspace(#BEG_DATE))!=8 or len(delspace(#END_DATE))!=8){
        showmsg('交易日期无效，请输入8位的交易日期!!');
        return(false);
      }
    }"
    </ONLOSTFOCUS>
  </ITEM>

   <ITEM  NAME="#BTN" LINE="21"  COL="63" TYPE="%-6s"    FUNCTIONS="T(确  定)" INPUT="BUTTON">
     <ONCLICK>"{
       dim @tota as string;
       dim @selid as number;
       initfd();
       commsend_001();
       $FD16='6606';             //平台用户交易明细查询接口
       $FD60='AGENT';            //平台交易类型
       $FD21='01';               //柜面发起标志
       $FD22=#AGENT_TYPE;        //代收费类型
       if(#BIFS=='0')
       {
         #USER_NO=#BIUSER_NO;
       }
       $FD30=#USER_NO;           //用户唯一标识
       $FD31=#AC_NO;             //账号
       $FD20=#TX_TYPE;           //交易类型
       $FD28=#BEG_DATE;          //开始时间
       $FD29=#END_DATE;          //结束时间

     @tota=callagnpt();
     if($FD12!='0000'){
       showmsg(geterror());
       return(false);
     }
     @tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
     if(@tota==''){
       showmsg('未找到该用户记录!');
       rerun();
       return(false);
     }
     autolist(@tota);
     @selid=list_work();
     rerun();
   }"
   </ONCLICK>
  </ITEM>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
</RESPONSE>
<OUTPUT>
</OUTPUT>
</TRANSACTION>
