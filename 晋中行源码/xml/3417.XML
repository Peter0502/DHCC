<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11000000" TITLE="3410 更换介质"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{

	//initfd();
	commsend_001();
	$TXNO='2410';
	$FD16='2410';
	$FD14='00000000';
	$FD30=#OACTNO;
  $FD31=#NACTNO;
  $FD59=#NVOCNUM;
	$FD67=#TXTP;
	//#PASSWD=#NEW_PASSWORD;
	$FD114=space(1)+#PASS+space(6)+#PASSWD+#CERT+getitems('#CERTNO')+space(1)+#ZJLX+space(2);
	//$FD114=space(1)+'N'+space(6)+getitems('#PASSWD')+getitems('#CERT')+getitems('#CERTNO')+space(1)+#ZJLX+space(2);
	}"
</COMMSEND>
<COMMRECV>"{

}"
</COMMRECV>
<FIRSTWORK>
"{
  #PIC='';
  #PIC1='';
}"
</FIRSTWORK>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-60s" FUNCTIONS=
   "T(3410                            更换介质)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>

  <!--输入变量-->
  <ITEM LINE="7"   COL="09" TYPE="%-12s" FUNCTIONS="T(更换方式:!)"/>
  <ITEM LINE="9"   COL="09" TYPE="%-12s" FUNCTIONS="T(原账卡号:)"/>
  <ITEM LINE="9"   COL="45" TYPE="%-12s" FUNCTIONS="T(原凭证号:)"/>
  <ITEM LINE="10"  COL="09" TYPE="%-12s" FUNCTIONS="T(户    名:)"/>
  <ITEM LINE="14"     COL="09"  TYPE="%-10s" FUNCTIONS="T(照    片:)"/>
  <ITEM LINE="14"     COL="45"  TYPE="%-10s" FUNCTIONS="T(印    件:)"/>
  <ITEM NAME="#GHYY" LINE="11"  COL="09" VISABLE="FALSE" TYPE="%-12s" FUNCTIONS="T(更换原因:)" INPUT="LABEL"/>
  <ITEM NAME="#GSBH" LINE="11"  COL="45" VISABLE="FALSE" TYPE="%-12s" FUNCTIONS="T(挂失编号:)" INPUT="LABEL"/>
  <ITEM LINE="12"  COL="09" TYPE="%-12s" FUNCTIONS="T(密码支取:!)"/>
  <ITEM LINE="13"  COL="09" TYPE="%-12s" FUNCTIONS="T(证件支取:!)"/>
  <ITEM NAME="#ZQMM"  LINE="12"  COL="45" TYPE="%-12s" VISABLE="FALSE" FUNCTIONS="T(支取密码:)"  INPUT="LABEL"/>
  <ITEM NAME="#LZJLX" LINE="14"  COL="09" TYPE="%-12s" VISABLE="FALSE" FUNCTIONS="T(证件类型:!)" INPUT="LABEL"/>
  <ITEM NAME="#ZJHM"  LINE="14"  COL="45" TYPE="%-12s" VISABLE="FALSE" FUNCTIONS="T(证件号码:)"  INPUT="LABEL"/>
  <ITEM LINE="16"  COL="08" TYPE="%-18s" FUNCTIONS="T(【新介质信息栏】)"/>
  <ITEM LINE="17"  COL="09" TYPE="%-60s" FUNCTIONS="T(------------------------------------------------------------------)"/>
  <ITEM LINE="19"  COL="09" TYPE="%-12s" FUNCTIONS="T(新账卡号:)"/>
  <ITEM LINE="19"  COL="45" TYPE="%-12s" FUNCTIONS="T(新凭证号:)"/>
  <ITEM NAME="#NEW_MM" LINE="20"  COL="09" TYPE="%-12s" VISABLE="FALSE" FUNCTIONS="T(新 密 码:)"  INPUT="LABEL"/>
  <ITEM NAME="#MSR2BAK" TYPE="%-37s"  FUNCTIONS=""/><!--0501-->
  <ITEM NAME="#MSR3BAK" TYPE="%-104s"  FUNCTIONS=""/><!--0501-->
  <ITEM NAME="#ACTNO" TYPE="%-104s"  FUNCTIONS=""/><!--0501-->
  <ITEM NAME="#TEMPCERTNO" TYPE="%-20s"  FUNCTIONS=""/>
  <ITEM NAME="#CARD_TRACENO" TYPE="%-16s" FUNCTIONS=""/>
  <ITEM NAME="#RESP_CODE" TYPE="%-4s" FUNCTIONS=""/>
  <ITEM NAME="#USER_NO"   TYPE="%-6s"   FUNCTIONS=""/>  <!----燃气代收用户代码--->
  <ITEM NAME="#YHNAME"    TYPE="%-40s"  FUNCTIONS=""/>  <!----燃气代收用户姓名--->
  <ITEM NAME="#ADDRESS"   TYPE="%-64s"  FUNCTIONS=""/>  <!----燃气代收用户地址--->

  <ITEM NAME="#COST_FEE"   TYPE="%17.2f"  FUNCTIONS=""/>    <!----工本费---->
  <ITEM NAME="#TRAN_FEE"   TYPE="%17.2f"  FUNCTIONS=""/>    <!----交易手续费---->
  <ITEM NAME="#COST_FEE1"   TYPE="%17.2f"  FUNCTIONS=""/>    <!----工本费---->
  <ITEM NAME="#TRAN_FEE1"   TYPE="%17.2f"  FUNCTIONS=""/>    <!----交易手续费---->
  <ITEM NAME="#FEETLRNO" TYPE="%4s" FUNCTIONS=""/><!---授权柜员号--->
  <ITEM NAME="#FEE_PWD"  TYPE="%6s" FUNCTIONS=""/><!---授权柜员口令--->
  <ITEM NAME="#FEEFLAG"  TYPE="%1s" FUNCTIONS=""/><!---收费标志--->
  <ITEM NAME="#FEEFLAG1"  TYPE="%1s" FUNCTIONS=""/><!---收费标志--->
  <ITEM NAME="#TXNAME"      TYPE="%-20s" FUNCTIONS="T(更换卡)"/>  <!---交易名称--->
  <ITEM NAME="#TXNO"        TYPE="%-4s"  FUNCTIONS="T($TXNO=2410)"/>

   <ITEM NAME="#FLAG" TYPE="%-1s" FUNCTIONS=""/>

  <ITEM NAME="#TXTP" 	INPUT="SELECT" 	LINE="7"  COL="19	" TYPE="%-1s" 	FUNCTIONS="T(1)">
  <SELECT>
     <OPTION VALUE="1" TITLE="正常更换"/>
     <OPTION VALUE="2" TITLE="书挂更换"/>
     <!--应行里要求仅保留口挂和书挂-wangwk-20101217
     <OPTION VALUE="3" TITLE="书挂兼密挂更换"/>
     -->
  </SELECT>
  </ITEM>
  <ITEM NAME="#STXTP"  TYPE="%-14s" FUNCTIONS="S(#TXTP,#TXTP)"/>

  <ITEM NAME="#OACTNO" INPUT="TEXT"  LINE="9" COL="19" TYPE="%-19s" FUNCTIONS="V(NB)">
  <ONLOSTFOCUS>
 "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#TMP" TYPE="%-1s" FUNCTIONS="" >
	<ONLOSTFOCUS>
	{

	}
	</ONLOSTFOCUS>
	</ITEM>
  <ITEM NAME="#MEDKIND" TYPE="%-4s"     FUNCTIONS=""/><!---介质种类--->
  <!--added by liuyong 2009-9-15 显示图片信息 start-->
  <ITEM NAME="#LYACNO" TYPE="%-19s" FUNCTIONS="" />
  <ITEM LINE="14" COL="19" LINES="160" COLS="120" NAME="#PIC" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/>
  <ITEM NAME="#SETPIC" TYPE="%-10s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="14" COL="55" LINES="220" COLS="160" NAME="#PIC1" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/>
  <ITEM NAME="#SETPIC1" TYPE="%-10s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <!--added by liuyong 2009-9-15 显示图片信息 end-->
  <ITEM NAME="#OVOCNUM"	INPUT="LABEL" 	LINE="9"   COL="55" TYPE="%-16s" FUNCTIONS=""/>
  <ITEM NAME="#NAME" 	INPUT="LABEL" 	LINE="10"  COL="19" TYPE="%-50s" FUNCTIONS="T($FD25)"/>
  <ITEM NAME="#INSTEAD_REASON" 	INPUT="SELECT" 	LINE="11"  COL="19" TYPE="%-1s"	 FUNCTIONS="T(0)" ENABLE="FALSE" VISABLE="FALSE">
  <SELECT>
     <OPTION VALUE="0" TITLE="更换介质"/>
     <OPTION VALUE="1" TITLE="损坏补换介质"/>
     <OPTION VALUE="2" TITLE="挂失补发新介质"/>
  </SELECT>
  <ONLOSTFOCUS>
  "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#LOST_NO"	INPUT="TEXT" 	LINE="11"   COL="55" TYPE="%-16s" FUNCTIONS=""  VISABLE="FALSE" ENABLE="FALSE"/>
  <ITEM NAME="#PASS" 	INPUT="SELECT" 	LINE="12"  COL="19" TYPE="%-1s"	 FUNCTIONS="T(Y)" ENABLE="FALSE">
  <SELECT>
     <OPTION VALUE="Y" TITLE="是"/>
     <OPTION VALUE="N" TITLE="否"/>
  </SELECT>
	<ONLOSTFOCUS>
	"{
			if(#PASS == 'Y')
			{
				show(#PASSWD,true);
				show(#ZQMM,true);
			}else
			{
				show(#PASSWD,false);
				show(#ZQMM,false);
			}
		}"
	</ONLOSTFOCUS>

  </ITEM>

  <!--书挂兼密挂时重设密码 added by liuyong 201005 start-->
 	<!--是挂失方式去掉-wangwk-20101217
  <ITEM NAME="#SGPASSWD" INPUT="TEXT" LINE="12" COL="55" TYPE="%6d" DEVICE="PINPAD" FUNCTIONS="I()i()V(NB)" VISABLE="FALSE">
  <ONLOSTFOCUS>
  "{
       #PASSWD=#SGPASSWD;
   }"
  </ONLOSTFOCUS>
  </ITEM>
  <!--added by liuyong 20100512 end-->
  <!--按行里要求去掉密码密码验证 -->
  <ITEM NAME="#PASSWD" INPUT="TEXT"   LINE="12" COL="55" TYPE="%6d" DEVICE="PINPAD" FUNCTIONS="i()T()V(NB)" VISABLE="FALSE">
  	<ONLOSTFOCUS>"{

  }"
  </ONLOSTFOCUS>
  </ITEM>

  <ITEM NAME="#CERT"   INPUT="SELECT" LINE="13" COL="19" TYPE="%-1s" FUNCTIONS="T(0)" ENABLE="FALSE">
  <SELECT>
     <OPTION VALUE="Y" TITLE="是"/>
     <OPTION VALUE="N" TITLE="否"/>
  </SELECT>
  </ITEM>
  <ITEM NAME="#ZJLX" INPUT="SELECT"	LINE="14" COL="19" TYPE="%-1s" FUNCTIONS="" ENABLE="FALSE" VISABLE="FALSE">
  <SELECT>
	<OPTION VALUE="1" TITLE="身份证"/>
	<OPTION VALUE="2" TITLE="户口簿"/>
	<OPTION VALUE="3" TITLE="护照"/>
	<OPTION VALUE="4" TITLE="军官证"/>
	<OPTION VALUE="5" TITLE="回乡证"/>
	<OPTION VALUE="6" TITLE="居住证"/>
	<OPTION VALUE="7" TITLE="驾照"/>
  </SELECT>
  </ITEM>
  <!-- 为核查结果中文传值的变量 wudawei 20131101 -->
  <ITEM NAME="#HCJGBL"  TYPE="%-60s" />
  <ITEM NAME="#CERTNO"  INPUT="TEXT" LINE="14" COL="50" TYPE="%-20s" FUNCTIONS="V(NB)" VISABLE="FALSE">
  <ONLOSTFOCUS>
 "{

 	}"
 	</ITEM>
  <ITEM NAME="#NACTNO"  INPUT="TEXT" LINE="19" COL="19" TYPE="%-19s" FUNCTIONS="V(NB)">
  <ONLOSTFOCUS>
 "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#NVOCNUM" INPUT="TEXT" LINE="19" COL="55" TYPE="%16d"  FUNCTIONS="V(NB)">
  <ONLOSTFOCUS>
 "{

  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#NEW_PASSWORD" INPUT="TEXT"   LINE="20" COL="19" TYPE="%6d" DEVICE="PINPAD" FUNCTIONS="I()i()V(NB)" VISABLE="FALSE">
   <ONLOSTFOCUS>
 	"{
 			//新密码直接更改
 			#PASS='Y';
 			#PASSWD=#NEW_PASSWORD;
 	 }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#AVBAL"  TYPE="%17.2f" FUNCTIONS="J(#UAVBAL)"/><!---存单余额--->
  <ITEM NAME="#UAVBAL" TYPE="%-40s"  FUNCTIONS="U(#AVBAL)"/> <!---存单大写余额--->


  <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>

  </VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
	<PACKAGE DEVICE="SCREEN" DESC="更换介质成功">
      NOTHING
	</PACKAGE>
	<PRINT>"{
		$KINDNO='00';
		print( 5, 25,'更 换 介 质 成 功 !');
		print(10, 22,'新帐卡号:[24]',$FD31);
		print(11, 22,'新凭证号:[16]',#NVOCNUM);
		print(12, 22,'介质代号:[4 ]',#MEDKIND);
	}"
	</PRINT>
</RESPONSE>

<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证">
    NOTHING
    </PACKAGE>
    <PRINT>"{
		$KINDNO='00';
		dim @txtime  as string;
		@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		if(substr(#NACTNO,0,6)=='621223')
		{
			print( 5,20,'机构名称:[30]',$BRNAME);
			print( 5,2,'代码:3410');
			print( 5,13,'交易:更换凭证');
			print( 7,20,'更换  方式:[14            ]         户     名:[50]',#STXTP,#NAME);
			print( 8,20,'原帐/卡号:[20                  ]    新帐/卡号:[20]',#OACTNO,$FD31);
			print( 9,20,'原凭证 号:[16              ]        新凭证 号:[16]',#OVOCNUM,#NVOCNUM);
			print(10,20,'身份核查结果:[60] ',#HCJGBL);
			print(17,20,'\H0若原卡已签约，签约项（自助设备转账、银联认证支付）自动迁移至更换后新卡.\H1');
			print(21,80,'客户签名:_____________________');
			print_sq();
			print(24,20,'备注:');
			print(24,27,'交易日期:[8] [8]',$HDATE,@txtime);
			print(24,5,'柜员:[4]',$FD7);
			print(24,5,'流水号:[6]',$FD4);
		}
    }"
    </PRINT>
</RESPONSE>
<!--add by luolz 20091101 更换卡收取手续费打印凭证-->
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" DESC="请打印业务专用凭证(手续费)" LINESPACE="24" CHECK="#FEEFLAG1=0">
      NOTHING
	</PACKAGE>
	<PRINT>"{
		dim @txtime as string;
		dim @feetype as string;
		@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		$KINDNO='00';
		print( 5,20,'机构名称:[30]',$BRNAME);
		print( 5, 2,'交易代码: 3410');
		print( 5,13,'交易名称:[20]',#TXNAME);
		print( 7,30,'\L0更换卡交易\L1');
		print( 9,20,'原卡号:[19]    新卡号:[19]',#OACTNO,#NACTNO);
		//print(10,20,'帐户余额:[21]',#TXAMT);
		//add by luolz 20091026 begin
		switch( #FEEFLAG ) {
			case '1' :
				print(11,20,'缴费方式:现金');
				break;
			case '2' :
				print(11,20,'缴费方式:转账');
				break;
			default :
				print(11,20,'缴费方式:不收');
				break;
		}
		if( delspace(itoa(#COST_FEE1,'%16.2f')) != '0.00' )
		{
			print(12,20,'银行卡工本费:[21]',delspace(itoa(#COST_FEE1,'%16.2f')));
		}
		if( delspace(itoa(#TRAN_FEE1,'%16.2f')) != '0.00' )
		{
			print(13,20,'银行卡手续费:[21]',delspace(itoa(#TRAN_FEE1,'%16.2f')));
		}
		if( delspace(itoa((#COST_FEE1+#TRAN_FEE1),'%16.2f')) != '0.00' )
		{
			print(14,20,'收费总额:[21]',delspace(itoa((#COST_FEE1+#TRAN_FEE1),'%16.2f')));
		}

		//add by luolz 20091026 end
		printacdtl_1();
		//print_sq();
		//print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
		//print(21,80,'客户签名:_____________________');
		print(24,20,'备注:');
		print(24,27,'交易日期:[8] [8]',$HDATE,@txtime);
		print(24,5,'柜员:[4]',$FD7);
		print(24,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>

<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="27" DESC="请打印旧凭证" CHECK="#FLAG=1" >
    NOTHING
    </PACKAGE>
    <PRINT>"{

	print(5, 20,'\Z0已更换\Z1');
        print(10, 6,'流 水 号:【[6  ]】    新凭证号:【[16]】 ',$FD4 ,#NVOCNUM);
    }"
    </PRINT>
</RESPONSE>
<IMPORT>CXHZ.IMP</IMPORT><!---换折--->
<IMPORT>CXHD.IMP</IMPORT><!---换单--->
<LASTWORK>"{
  dim @tota as string;
	dim @file as file;
	dim @line as string;
	dim @tctd_br_no as string;
	if(substr(#NACTNO,0,6) != '621223')
 		{
	if(msgbox('新凭证是否有需要刷磁?'+chr(10)+'------------------','提  示','yes|no')==0){
		if(writemsr(delspace(substr($FD31,0,19)),'')){
			showmsg('写磁成功!');
		}else{
			showmsg('写磁失败!');
		}
	}
	//打印通存通兑行号
	$FD123='select tctd_br_no,br_no from tctd_ktzh where tctd_acno='+chr(39)+
		delspace($FD31)+chr(39)+' and (tc_kt_flag=1 or td_kt_flag=1
                        or cx_kt_flag=1)';
	commsend_001();
	$FD16='9598';
	@tota=callserver();
	if($FD12!='0000'){
		showmsg(geterror());
        	showfooter();
        	return(false);
	}
	if(@tota==''){
		return(true);
	}
	savefiletxt('../tmp/'+$KINBR+$TTYNAME,@tota);
	@file=openfile('../tmp/'+$KINBR+$TTYNAME,'r');
	if(@file &lt; 0){
		showmsg('取附件失败!');
		return(false);
	}
	@line=readline(@file);
	if(@line==''){
		return(true);
	}
	@tctd_br_no=strfld(@line,'|',0);
	link('34101.XML',substr(getitems('$FD31'),0,19)+@tctd_br_no);
	}
}"
</LASTWORK>
</TRANSACTION>

