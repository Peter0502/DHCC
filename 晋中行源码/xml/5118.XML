<TRANSACTION RIGHTS="11110000" TITLE="5118 逾期银行汇票冲回"
xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>
"{
  #CASH_AC_NO = #TR_AC_NO;
  commsend_001();
  commsend_123();
  commsend_hv();
  $FD88 = #PWD;
	$FD67 ='2'; //现金转帐标志--转帐
	$FD66 ='2'; //首笔会计分录的借贷标志--贷
	$FD21 ='01';//币种	
	#CASHFLAG='2';
	commsend_101();
  $FD99='0';//控制循环
  $FD120=getitems('#FD120_1#FD120_2#FD120_3#FD120_4#FD120_5#FD120_6#FD120_7#FD120_8#FD120_9#FD120_10#FD120_11');
//	showmsg('$FD30=='+$FD30+'FD33=='+$FD33);
}"
</COMMSEND>
<COMMRECV>
"{
  commrecv_001();
}"
</COMMRECV>
<VARIABLE>
<ITEM LINE="3"  COL="3" TYPE="%-50s" FUNCTIONS=
"T(5118                    逾 期 银 行 汇 票 冲回)"/>
<ITEM LINE="4"  COL="3"  TYPE="%-70s" FUNCTIONS=
"T(───────────────────────────────────)"/>

<ITEM NAME="#MSGTYPE"    TYPE="%-5s"     FUNCTIONS="T($MSGTYPE=03001)"/>
<ITEM NAME="#TXNO"       TYPE="%-4s"     FUNCTIONS="T($TXNO=5818)"/>

<ITEM NAME="#CMTNO"      TYPE="%-3s"    FUNCTIONS=""/>
<ITEM NAME="#O_CMTNO"    TYPE="%-3s"    FUNCTIONS=""/>
<ITEM NAME="#PAY_QS_NO"  TYPE="%-12s"    FUNCTIONS=""/>
<ITEM NAME="#PAY_ADDR"   TYPE="%-60s"    FUNCTIONS=""/>
<ITEM NAME="#OR_BR_NO"   TYPE="%-12s"    FUNCTIONS=""/>
<ITEM NAME="#SENDCO"     TYPE="%-4s"     FUNCTIONS=""/>
<ITEM NAME="#CASH_QS_NO" TYPE="%-12s"    FUNCTIONS=""/>
<ITEM NAME="#AC_BR_NO"   TYPE="%-12s"    FUNCTIONS=""/>
<ITEM NAME="#RECECO"     TYPE="%-4s"     FUNCTIONS=""/>
<ITEM NAME="#CASH_ADDR"         TYPE="%-60s"      FUNCTIONS=""/>
<ITEM NAME="#YW_TYPE"           TYPE="%-2s"       FUNCTIONS=""/>
<ITEM NAME="#ORDERNO"           TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#CONTENT"           TYPE="%-60s"      FUNCTIONS=""/>
<ITEM NAME="#RATE"              TYPE="%-7s"       FUNCTIONS=""/>
<ITEM NAME="#RATEDATE"          TYPE="%-5s"       FUNCTIONS=""/>
<ITEM NAME="#OORDERNO"          TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#PROCODE"           TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#CR_DATE"           TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#CR_BR_NO"          TYPE="%-12s"      FUNCTIONS=""/>
<ITEM NAME="#CR_TX_NUM"         TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#QR_BR_NO"          TYPE="%-12s"      FUNCTIONS=""/>
<ITEM NAME="#QR_TX_NUM"         TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#TX_TYPE"           TYPE="%-1s"       FUNCTIONS=""/>
<ITEM NAME="#NOTPAY_CONTENT"   TYPE="%-255s"     FUNCTIONS=""/>
<ITEM NAME="#NOTPAY_ORDERNO"    TYPE="%-3s"       FUNCTIONS=""/>
<ITEM NAME="#O_NOTPAY_ORDERNO"  TYPE="%-3s"       FUNCTIONS=""/>
<ITEM NAME="#RESP1"             TYPE="%-1s"       FUNCTIONS=""/>
<ITEM NAME="#OPERLEVEL"         TYPE="%-1s"       FUNCTIONS=""/><!--优先级别-->
<ITEM NAME="#PROC_STS"          TYPE="%-1s"       FUNCTIONS=""/><!--处理状态-->
<ITEM NAME="#OPCD"          TYPE="%-2s"  FUNCTIONS="T(10)"/>
<ITEM NAME="#NOTE_NO"       TYPE="%-16s" FUNCTIONS=""/>
<ITEM NAME="#LW_IND"        TYPE="%-1s" FUNCTIONS="T(1)"/>
<ITEM NAME="#HP_ADD_PWD"    TYPE="%-1s" FUNCTIONS="T(A)"/>
<ITEM NAME="#PACKID"        TYPE="%8d"  FUNCTIONS="T()"/>
<ITEM NAME="#O_PACKID"      TYPE="%8d"  FUNCTIONS="T()"/>
<ITEM NAME="#PACK_DATE"     TYPE="%8d"  FUNCTIONS="T()"/>
<ITEM NAME="#O_PACK_DATE"   TYPE="%8d"  FUNCTIONS="T()"/>
<ITEM NAME="#TXNUM"         TYPE="%5d"  FUNCTIONS="T()"/>
<ITEM NAME="#O_TXNUM"       TYPE="%5d"  FUNCTIONS="T()"/>
<ITEM NAME="#LV_YW_IND"     TYPE="%12s" FUNCTIONS="T()"/>
<ITEM NAME="#RESP_DATE"     TYPE="%8d"  FUNCTIONS="T()"/>
<ITEM NAME="#RCP_STS"       TYPE="%2d"  FUNCTIONS="T()"/>
<ITEM NAME="#RESP2"             TYPE="%8s"       FUNCTIONS="T()"/>
<ITEM NAME="#RETCODE"           TYPE="%2d"       FUNCTIONS="T()"/>
<ITEM NAME="#YW_DTL_ID"         TYPE="%8d"       FUNCTIONS="T()"/>
<ITEM NAME="#ACC_IND"           TYPE="%1d"       FUNCTIONS="T()"/>
<ITEM NAME="#REQ_TYPE"          TYPE="%1d"       FUNCTIONS="T()"/>
<ITEM NAME="#DF_FREEAMT"        TYPE="%16s"      FUNCTIONS="T()"/>
<ITEM NAME="#PROTNO"            TYPE="%60s"      FUNCTIONS="T()"/>
<ITEM NAME="#OTYPE"             TYPE="%1d"       FUNCTIONS="T(1)"/><!-- 表示大额 -->

<ITEM NAME="#WT_DAY"            TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#O_WT_DAY"          TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#NOTPAY_DATE"       TYPE="%-8s"       FUNCTIONS=""/>
<ITEM NAME="#CUR_NO"            TYPE="%-2s"       FUNCTIONS=""/>
<ITEM NAME="#NOTE_TYPE"         TYPE="%-3s"       FUNCTIONS=""/>

<!-- 一下是 101域的变量集合  --->
  <ITEM NAME="#ACTNO24"    TYPE="%-24s"  FUNCTIONS=""/>  
  <ITEM NAME="#ACTSEQ"     TYPE="%4d"    FUNCTIONS=""/>
  <ITEM NAME="#TXAMT"      TYPE="%17.2f" FUNCTIONS=""/>
  <ITEM NAME="#VOCTYPE"    TYPE="%-3s"   FUNCTIONS=""/>
  <ITEM NAME="#VOCNUM"     TYPE="%16d"   FUNCTIONS=""/>
  <ITEM NAME="#DESC10"     TYPE="%-10s"  FUNCTIONS=""/>
  <ITEM NAME="#NBFLAG"     TYPE="%-1s"   FUNCTIONS=""/>
  <ITEM NAME="#CUSTNAME"   TYPE="%-60s"  FUNCTIONS=""/>
  <ITEM NAME="#AVBAL"      TYPE="%17.2f" FUNCTIONS=""/>
  <ITEM NAME="#CURCD"      TYPE="%-2s"   FUNCTIONS=""/>
  <ITEM NAME="#CASHFLAG"   TYPE="%-1s"   FUNCTIONS=""/>
  <ITEM NAME="#DSCPT"      TYPE="%-3s"   FUNCTIONS=""/>
  <ITEM NAME="#ACTTYPE"    TYPE="%-1s"   FUNCTIONS=""/>
  <ITEM NAME="#ACTSEQ_2"   TYPE="%-4s"   FUNCTIONS=""/>
  <ITEM NAME="#PRODNAME"   TYPE="%-30s"  FUNCTIONS=""/>
<!-- 101到这里结束 -->

  
<ITEM LINE="5"   COL="03" TYPE="%-9s"    FUNCTIONS="T(汇 票 号:)"/>
<ITEM LINE="6"   COL="03" TYPE="%-9s"    FUNCTIONS="T(出票行号:)"/>
<ITEM LINE="6"   COL="47" TYPE="%-9s"    FUNCTIONS="T(汇票密押:)"/>
<ITEM LINE="7"   COL="03" TYPE="%-9s"    FUNCTIONS="T(提入帐号:)"/>
<ITEM LINE="8"   COL="03" TYPE="%-9s"    FUNCTIONS="T(帐号户名:)"/>



<ITEM LINE="9"   COL="3" TYPE="%-60s"    FUNCTIONS="T(--------------------【汇票信息】--------------------)"/>


<ITEM LINE="10"   COL="03" TYPE="%-12s"    FUNCTIONS="T(汇票类型:)"/>
<ITEM LINE="10"   COL="47" TYPE="%-12s"    FUNCTIONS="T(出票日期:)"/>
<ITEM LINE="11"   COL="03" TYPE="%-12s"    FUNCTIONS="T(录入日期:)"/>
<ITEM LINE="11"   COL="47" TYPE="%-12s"    FUNCTIONS="T(录入机构:)"/>
<ITEM LINE="12"   COL="03" TYPE="%-12s"    FUNCTIONS="T(申请帐号:)"/>
<ITEM LINE="13"   COL="03" TYPE="%-12s"    FUNCTIONS="T(用户户名:)"/>
<ITEM LINE="14"   COL="03" TYPE="%-12s"    FUNCTIONS="T(出票金额:)"/>
<ITEM LINE="15"   COL="03" TYPE="%-12s"    FUNCTIONS="T(收款帐号:)"/>
<ITEM LINE="16"   COL="03" TYPE="%-12s"    FUNCTIONS="T(收款人名称:)"/>
<ITEM LINE="17"   COL="03" TYPE="%-12s"    FUNCTIONS="T(代理付款行:)"/>
<ITEM LINE="18"   COL="03" TYPE="%-12s"    FUNCTIONS="T(代理行行名:)"/>

<!--定义前台输入变量-->
<ITEM LINE="5"   COL="12" NAME="#PO_NO"    TYPE="%8d"   INPUT="TEXT" FUNCTIONS="V(NB)T()">
<ONLOSTFOCUS>
"{
	dim @name as string;
	dim @avbal as string;
	initfd();
	commsend_001();
	commsend_123();
	$FD16 = '9560';
	callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return (false);
	}
  setitems('#CMTNO#O_CMTNO#PAY_QS_NO#OR_BR_NO#SENDCO#PAY_OPN_BR_NO#PAY_AC_NO#PAY_NAME#PAY_ADDR#CASH_QS_NO#AC_BR_NO#RECECO#CASH_OPN_BR_NO#CASH_AC_NO#CASH_NAME#CASH_ADDR#YW_TYPE#ORDERNO#CONTENT#RATE#RATEDATE#OORDERNO#PROCODE#CR_DATE#CR_BR_NO#CR_TX_NUM#QR_BR_NO#QR_TX_NUM#TX_TYPE#NOTPAY_CONTENT#NOTPAY_ORDERNO#O_NOTPAY_ORDERNO#RESP1#OPERLEVEL#PROC_STS#OPCD#LW_IND#HP_ADD_PWD#PACKID#O_PACKID#PACK_DATE#O_PACK_DATE#TXNUM#O_TXNUM#LV_YW_IND#RESP_DATE#RCP_STS#RESP2#RETCODE#YW_DTL_ID#ACC_IND#REQ_TYPE#DF_FREEAMT#PROTNO#PO_NO#PO_TYPE#OTYPE',$FD123);
	#REG_DATE = $FD45;
	#SIGN_DATE = $FD46;
	#TX_AMT = val($FD39,0.01);
  #TX_BR_NO = $FD3;

	initfd();
	commsend_001();
	$FD32 = #CASH_OPN_BR_NO;
	$FD16 = '9553';
	callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return (false);
	}
	#CASH_BR_NAME = substr($FD96,0,60);	
	show(#CASH_BR_NAME,true);
	show(#PO_TYPE,true);
	show(#PAY_AC_NO,true);
	show(#PAY_NAME,true);
	show(#TX_AMT,true);
	show(#CASH_AC_NO,true);
	show(#CASH_NAME,true);
	show(#CASH_OPN_BR_NO,true);
	show(#SIGN_DATE,true);
	show(#REG_DATE,true);
	show(#TX_BR_NO,true);
	#TR_AC_NO=#PAY_AC_NO;
	enable(#TR_AC_NO,true);
	enable(#PAY_OPN_BR_NO,true);

	initfd();
	commsend_001();
	//这个交易应该先调用9405交易得到帐户类型，
	//然后判断到底应该是调用对公活期存款还是调用储蓄存款交易的短交易填充102域
	$FD16 = '9405';
	$FD32 = #TR_AC_NO;
	callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return (false);
	}
	if($FD68=='1'){
		//储蓄
//		showmsg('FD16==='+$FD16);
		if(substr($FD33,0,1)=='5'){
			$FD16 = '9954';
		}	else {
			$FD16 = '9951';
		}
	}	else {
		//对公
		$FD16 = '9954';
	}
	$FD30 = $FD33;
//	showmsg('$FD30=='+$FD30);
	$FD101 = #TR_AC_NO;
	callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return (false);
	}
	commrecv_101();
	#CASHFLAG='2';	
	#TXAMT=#TX_AMT;
	showhelp(4,58,5,20,'帐户信息','户名:'+#CUSTNAME+' 余额:'+itoa(#AVBAL,'%16.2f'));
	#TR_NAME = #CUSTNAME;
	show(#TR_NAME,true);
	goitem(#PWD);
}"
</ONLOSTFOCUS>
</ITEM>

<ITEM LINE="6"   COL="12" NAME="#PAY_OPN_BR_NO"     TYPE="%-12s"  INPUT="TEXT" FUNCTIONS="T()"/>

<ITEM LINE="6"   COL="56" NAME="#PWD"   TYPE="%10d"  INPUT="TEXT" FUNCTIONS="V(NB)">
<ONLOSTFOCUS>"{
	// 得到本机构的退回户并设置相关１２１域
	commsend_001();
	$FD48 = '0003';
	$FD16 = '9406';
	callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return (false);
	}
	#FD120_1=substr($FD120,0,20);$FD120='';
	#FD120_5='2';
	#FD120_7=#PO_NO;
	#FD120_8=itoa(#TX_AMT*100,'%016.0f');
	#FD120_10='逾期冲回';
	goitem(#OK);
}"
</ONLOSTFOCUS>
</ITEM>

<ITEM LINE="7"   COL="12" NAME="#TR_AC_NO" TYPE="%-32s" INPUT="TEXT" FUNCTIONS=""/>

<ITEM LINE="8"   COL="12" NAME="#TR_NAME"      TYPE="%-60s"  INPUT="TEXT" FUNCTIONS="T()V(NB)"/>

<!------返回信息部分-------->
<ITEM LINE="10"  COL="12" NAME="#PO_TYPE"  TYPE="%-1s"   INPUT="SELECT" FUNCTIONS="T(0)">
  <SELECT LINE="14" COL="17">
     <OPTION VALUE="2 现 金"   TITLE="0.现金"/>
     <OPTION VALUE="1 不可转"  TITLE="1.不可转"/>
     <OPTION VALUE="0 可转"    TITLE="2.可转"/>
  </SELECT>
 </ITEM>
<ITEM LINE="10"   COL="57" NAME="#SIGN_DATE"     TYPE="%-8s"  INPUT="TEXT" FUNCTIONS=""/>
<ITEM LINE="11"   COL="12" NAME="#REG_DATE"      TYPE="%-8s"  INPUT="TEXT" FUNCTIONS=""/>
<ITEM LINE="11"   COL="57" NAME="#TX_BR_NO"       TYPE="%-7s"   INPUT="TEXT" FUNCTIONS=""/>
<ITEM LINE="12"   COL="12" NAME="#PAY_AC_NO"   TYPE="%-32s"   INPUT="TEXT" FUNCTIONS=""/>
<ITEM LINE="13"  COL="12" NAME="#PAY_NAME"     TYPE="%-60s"   INPUT="TEXT" FUNCTIONS="V(NB)"/>
<ITEM LINE="14"  COL="12" NAME="#TX_AMT"    TYPE="%16.2f"  INPUT="TEXT" FUNCTIONS=""/>
<ITEM LINE="15"  COL="12" NAME="#CASH_AC_NO"    TYPE="%-32s"   INPUT="TEXT" FUNCTIONS="T()"/>
<ITEM LINE="16"  COL="15" NAME="#CASH_NAME"     TYPE="%-60s"   INPUT="TEXT" FUNCTIONS="T()"/>
<ITEM LINE="17"  COL="15" NAME="#CASH_OPN_BR_NO"  TYPE="%-12s"   INPUT="TEXT" FUNCTIONS="V(NB)"/>
<ITEM LINE="18"  COL="15" NAME="#CASH_BR_NAME"     TYPE="%-60s"   INPUT="TEXT" FUNCTIONS="V(NB)"/>

<!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
<ITEM NAME="#PASSWD"   TYPE="%-6s" FUNCTIONS="T()"/>
<ITEM NAME="#FD120_1"   TYPE="%-20s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_2"   TYPE="%-50s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_3"   TYPE="%-16s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_4"   TYPE="%-2s"   FUNCTIONS=""/>
<ITEM NAME="#FD120_5"   TYPE="%-1s"   FUNCTIONS=""/>
<ITEM NAME="#FD120_6"   TYPE="%-3s"   FUNCTIONS=""/>
<ITEM NAME="#FD120_7"   TYPE="%-16s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_8"   TYPE="%-16s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_9"   TYPE="%-2s"   FUNCTIONS=""/>
<ITEM NAME="#FD120_10"  TYPE="%-20s"  FUNCTIONS=""/>
<ITEM NAME="#FD120_11"  TYPE="%-2s"   FUNCTIONS=""/>



<ITEM LINE="21"  COL="65"  TYPE="%-6s" NAME="#OK"  FUNCTIONS="T(确  定)" INPUT="SUBMIT" />
 </VARIABLE>
<!--发送信息包-->
<REQUEST>
</REQUEST>

<!--接收信息包-->
<RESPONSE>
<PACKAGE DEVICE="SCREEN" DESC="按任意键退出">
NOTHING
</PACKAGE>
    <PRINT>"{
   print(3,25,'逾期银行汇票冲回');
   print(5,15,'汇票号码 :[20]',#PO_NO);
        print(6,15,'签发金额 :[12]',ltrim(comma(itoa(#TX_AMT,'%17.2f'),16)));
        print(7,15,'付款帐号 :[32]',#PAY_AC_NO);
        print(8,15,'付款名称 :[60]',#PAY_NAME);
        print(9,15,'流水号码 :[ 6]',$FD4);
}"
</PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="PRINTER"  LINESPACE="27" DESC="请打印业务专用凭证" >
NOTHING  
</PACKAGE>
<PRINT>
"{
   dim @txtime  as string;
   @txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
 	print( 5,20,'机构名称:[30]',$BRNAME);  
	print( 5,2,'代码:5116');
	print( 5,13,'交易:逾期汇票解付');
	
	print( 7,20,'汇票号码 :[20] [8]',#PO_NO,@txtime);
        print( 8,20,'签发金额 :[12]',ltrim(comma(itoa(#TX_AMT,'%17.2f'),16)));
        print( 9,20,'付款帐号 :[32]',#PAY_AC_NO);
        print(10,20,'付款名称 :[60]',#PAY_NAME);
        
        print( 24,20,'备注:');
	print( 24,27,'交易日期:[8] [8]',$HDATE,@txtime);
	print( 24,5,'柜员:[4]',$FD7);
	print( 24,5,'流水号:[6]',$FD4);
}"
</PRINT>
</RESPONSE>
<OUTPUT>
</OUTPUT>
</TRANSACTION>



