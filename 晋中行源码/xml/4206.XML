<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11110000" TITLE="4206  销介质业务"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{

    //2010-3-2 zxp 往神码发
	if(substr(#ACTNO,0,6) == '621223')
	{
		initfd();
		commsend_001();
		$FD16='7003';
		$FD30=#ACTNO;
		$FD79=#PASSWD;
		callagn();
	    if($FD12!='0000')
			{
				showmsg(geterror());
				return (false);
			}
		 #CARD_TRACENO=delspace(itoa(val($FD43),'%16d'));
		}
		
 	    //核心;
		commsend_001();
		$FD105 = getitems('#STR1#PASSWD#STR2');
		$FD102=space(28)+getitems('#AUTHTYPE#AUTHNO');
}"
</COMMSEND>
<COMMRECV>"{
		commrecv_001();
		//核心返回错误代码,
	  if(($FD12!='0000') and (substr(#ACTNO,0,6)=='621223'))
	  {
	   //showmsg('#RESP_CODE='+$FD12);
		$FD12=#RESP_CODE;
		showmsg(geterror());
		initfd();
		commsend_001();
		$FD16='7777';
		$FD12=#RESP_CODE;
		$FD30=#ACTNO;
		$FD43=#CARD_TRACENO;
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror());
			//return (false);
		}
		showmsg('卡销介质失败!');
		rerun(); 
	}
}"
</COMMRECV>
<FIRSTWORK>
"{
  #PIC='';
  #PIC1='';
  show(#PIC,false);
  show(#PIC1,false);
  show(#LBLPIC,false);
  show(#LBLPIC1,false);
  enable(#SETPIC,false);
  enable(#SETPIC1,false);
}"
</FIRSTWORK>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(4206                           销介质业务)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO"    TYPE="%-4s" FUNCTIONS="T($TXNO=2210)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  <ITEM NAME="#TXCD"    TYPE="%4s"  FUNCTIONS="T(4206)"/>  <!---交易代码--->
 
  <ITEM NAME="#RESP_CODE" TYPE="%-4s" FUNCTIONS=""/>
  <ITEM NAME="#CARD_TRACENO" TYPE="%-16s" FUNCTIONS=""/>
 
  <ITEM LINE="7" COL="12" TYPE="%-9s" FUNCTIONS="T(帐/卡 号:)"/>

  <ITEM LINE="9"     COL="12"  NAME="#LBLPIC" TYPE="%-10s" FUNCTIONS="T(照    片:)"/>
   <ITEM LINE="9"     COL="35"  NAME="#LBLPIC1" TYPE="%-10s" FUNCTIONS="T(印    件:)"/>
  <ITEM LINE="10" COL="12" TYPE="%-60s" FUNCTIONS="T(------------------------------------------------)"/>


  <BLOCK NAME="ACTNOINFO1"  LINE="12" COL="12" VISABLE="FALSE">
  <ITEM LINE="1" COL="0"  TYPE="%-10s" FUNCTIONS="T(户    名:)"/>

  <ITEM LINE="3" COL="0"  TYPE="%-10s" FUNCTIONS="T(凭证种类:!)"/>
  <ITEM LINE="3" COL="35" TYPE="%-10s" FUNCTIONS="T(凭证号码:)"/>

  <ITEM LINE="5" COL="0" TYPE="%-10s"  FUNCTIONS="T(凭密支取:!)"/>
  <ITEM NAME="#LPPSW"    LINE="5" COL="35" TYPE="%-10s" FUNCTIONS="T(支取密码:)"/>
  <ITEM LINE="6" COL="0" TYPE="%-10s"  FUNCTIONS="T(证件支取:!)"/>
  <ITEM NAME="#LBCERTYP" LINE="7" COL="0"  TYPE="%-10s" FUNCTIONS="T(证件类型:!)"/>
  <ITEM NAME="#LBCERNO"  LINE="7" COL="35" TYPE="%-10s" FUNCTIONS="T(证件号码:)"/>
  </BLOCK>


  <ITEM NAME="#ACTNO" LINE="7" COL="21" INPUT="TEXT"  TYPE="%-19s" FUNCTIONS="T()V(NB)">
  <ONLOSTFOCUS>
  "{
  	//增加查询2320，查看该账户是否签约亲子关联 add by lq 20151013
  	initfd();
		commsend_001();
		$FD16='2320';//校验是否签约亲子关联
		$FD30=#ACTNO;
		$FD68='2';
		callserver(); 
		if($FD12!='0000')
		{
	    showmsg(geterror());
	    return(false);
		}
		if($FD69 == '1')
		{
	    showmsg('此账户已签约亲子关联，销户请先解约亲子关联！');
	    return(false);
		}
		//end lq 20151013
		
		showblock('ACTNOINFO1',true,true);
		showblock('ACTNOINFO2',true,true);
		initfd();
		commsend_001();
		$FD16 = '9733';
		$FD105= #ACTNO;
		callserver();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return (false);
        }
        
		#AUTHNO            =     substr($FD102,31,16);
		#AUTHTYPE          =     substr($FD102,28,3);
		#USERNAME          =     substr($FD105,64,60);
                #CHOOSEPASSWORD	   =     substr($FD105,28,1);
		#CHOOSECERTIFICATE =     substr($FD105,41,1);
			 
  	    if(#CHOOSECERTIFICATE=='Y')
        {
       		 #CERTIFYTYPE = substr($FD105,63,1);
		 showmsg(#CERTIFYTYPE);
	         #CERTIFICATE = substr($FD105,42,20);
        }
		 show(#USERNAME,true);
		 show(#AUTHTYPE,true);
		 enable(#AUTHTYPE,false);
		 show(#AUTHNO,true);
		 show(#CHOOSEPASSWORD,true);
		 show(#CHOOSECERTIFICATE,true);
		 show(#CERTIFYTYPE,true);
		 show(#CERTIFICATE,true);

	    if(#CHOOSEPASSWORD=='N')
  	    {
        	 show(#PASSWD,false);
			 show(#LPPSW,false);
		}
	   if(#CHOOSECERTIFICATE=='N')
		{	
			 show(#CERTIFICATE,false);
			 show(#CERTIFYTYPE,false);
			 show(#LBCERTYP,false);
			 show(#LBCERNO,false);		
		}
         #STR1 = substr($FD105,0,35);
         #STR2 = substr($FD105,41,75);

		
    }"
   </ONLOSTFOCUS>
   </ITEM>
   <!--added by liuyong 2009-9-15 显示图片信息 start-->
   <ITEM  NAME="#CHECKACNO"  TYPE="%10s" FUNCTIONS="">
 <ONLOSTFOCUS>
 "{
     dim @txnobak as string;
     dim @len as number;
     @len = len(rtrim(#ACTNO));
     if(@len != 0 and @len != 3 and @len != 5 and @len != 7)
     {
       @txnobak = $TXNO;
       $TXNO = '9663';
       $FD30 = #ACTNO;
       commsend_001();
       callserver();
       if($FD12 !='0000')
       {
         show(#PIC,false);
         show(#PIC1,false);
         show(#LBLPIC,false);
         show(#LBLPIC1,false);
         enable(#SETPIC,false);
         enable(#SETPIC1,false);
       }
       else
       {
         show(#PIC,true);
         show(#PIC1,true);
         show(#LBLPIC,true);
         show(#LBLPIC1,true);
         enable(#SETPIC,true);
         enable(#SETPIC1,true);
       }
       $TXNO = @txnobak;
     }
     
 }"
 </ONLOSTFOCUS>
 </ITEM>
 <ITEM NAME="#LYACNO" TYPE="%-19s" FUNCTIONS="" />
  <ITEM LINE="9" COL="21" LINES="160" COLS="120" NAME="#PIC" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/>
  <ITEM NAME="#SETPIC" TYPE="%-10s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
      #LYACNO=#ACTNO;
      call_96641();
  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="9" COL="45" LINES="220" COLS="160" NAME="#PIC1" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/>
  <ITEM NAME="#SETPIC1" TYPE="%-10s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
      #LYACNO=#ACTNO;
      call_96642();
  }"
  </ONLOSTFOCUS>
  </ITEM>
  <!--added by liuyong 2009-9-15 显示图片信息 end-->
  <BLOCK NAME="ACTNOINFO2" LINE="12" COL="23" VISABLE="FALSE">
  <ITEM NAME="#USERNAME"    LINE="1" COL="0"  INPUT="LABEL"TYPE="%50s" FUNCTIONS=""/>
  <ITEM NAME="#AUTHTYPE"   INPUT="SELECT" LINE="3" COL="0" TYPE="%-3s" FUNCTIONS="G(#CHOOSEPASSWORD=Y,#PASSWD)">
  <SELECT>
		<OPTION VALUE="010" TITLE="储蓄活期折"/>
		<OPTION VALUE="016" TITLE="一本通存折"/>
		<OPTION VALUE="020" TITLE="储蓄卡"/>
  </SELECT>
  </ITEM>
  <ITEM NAME="#SAUTHTYPE" TYPE="%-10s" FUNCTIONS="S(#AUTHTYPE,#AUTHTYPE)"/>
  <ITEM NAME="#AUTHNO"   INPUT="LABEL" LINE="3" COL="35" TYPE="%16s" FUNCTIONS=""/>
  <ITEM NAME="#CHOOSEPASSWORD"   INPUT="LABEL"  LINE="5" COL="0" TYPE="%1s" FUNCTIONS="G(N,#CHOOSECERTIFICATE)j(#CHOOSEPASSWORD=N,T{N}T{Y})"/>
  <!--
	<SELECT>
		 <OPTION VALUE="N" TITLE="0.否"/>
		 <OPTION VALUE="Y" TITLE="1.是"/>
     </SELECT>
  </ITEM>
  --->
  <ITEM NAME="#PASSWD"   INPUT="TEXT"  LINE="5" COL="35" TYPE="%-6s" DEVICE="PINPAD"  FUNCTIONS="i()V(NB)"/>
  <ITEM NAME="#CHOOSECERTIFICATE" INPUT="LABEL"  LINE="6" COL="0" TYPE="%1s" FUNCTIONS="j(#CHOOSECERTIFICATE=N,T{N}T{Y})"/>
  <ITEM NAME="#CERTIFYTYPE"   INPUT="SELECT"  LINE="7"  COL="0" TYPE="%1s"  FUNCTIONS="">
    <SELECT>
   		<OPTION VALUE ="1" TITLE="0.身份证" />
			<OPTION VALUE ="2" TITLE="1.户口簿" />
			<OPTION VALUE ="3" TITLE="2.护照" />
			<OPTION VALUE ="4" TITLE="3.军官证" />
			<OPTION VALUE ="5" TITLE="4.回乡证" />
			<OPTION VALUE ="8" TITLE="7.企业代码证" />
			<OPTION VALUE ="9" TITLE="8.组织机构号" />
			<OPTION VALUE ="A" TITLE="9.营业执照" />
			<OPTION VALUE ="B" TITLE="A.经营许可证" />
			<OPTION VALUE ="C" TITLE="B.事业法人证书" />
  </SELECT>
  </ITEM>
  <!-- 为核查结果中文传值的变量 wudawei 20131101 -->
  <ITEM NAME="#HCJGBL"  TYPE="%-60s" />
  <ITEM NAME="#CERTIFICATE"   INPUT="TEXT"  LINE="7" COL="35" TYPE="%-20s" FUNCTIONS="V(NB)">
  	<ONLOSTFOCUS>
  	"{
  	//add 20131030 wudawei start 调用身份核查
  		  dim @res as string;
				if(#CERTIFYTYPE=='1' or #CERTIFYTYPE=='2')
				{
					@res = idcheck(#CERTIFICATE,#USERNAME);
					#HCJGBL = strfld(@res,'|',1);
					@res =  strfld(@res,'|',0);
					if(@res=='02' or @res=='03' or @res=='04' or @res=='05' or @res=='06')
					{
							showmsg('身份核查结果不通过，不能继续办理！');
							return(false);
					}
				}
				//add 20131030 end
  	}"
  	</ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#TAUTHTYPE"     TYPE="%1s"    FUNCTIONS="j(#AUTHTYPE=010,T{1})j(#AUTHTYPE=016,T{1})j(#AUTHTYPE=020,T{2})"/><!---打印标志--->
  </BLOCK>

  <ITEM NAME="#STR1"   TYPE="%35s" FUNCTIONS=""/>
  <ITEM NAME="#STR2"   TYPE="%75s" FUNCTIONS=""/>

  <ITEM NAME="#CONFIRM"  LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE>
NOTHING
</PACKAGE>
	<PRINT> "{
				print(8,25,'销介质交易成功!');
				print(9,21,'销户帐户:[19]',#ACTNO);
			}"
	</PRINT>
</RESPONSE>
<RESPONSE> <!---销卡打印--->
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="普通凭证">
	NOTHING
	</PACKAGE>
	<PRINT>
	"{
		$KINDNO='00';
 		dim @txtime  as string;
		@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 3, 25,'[5]',$KINBR);
		print( 3, 10,'[20]',$BRNAME);
		print( 3, 5,'交易日期:[8  ]  [8]',$HDATE,@txtime);
		print( 4,36,'4206卡折销户');
		print( 5,10,'帐/卡 号 :[19                 ]   户    名 :[60]',#ACTNO,#USERNAME);
		print( 6,10,'凭证种类 :[10        ]            凭证号码 :[16]',#SAUTHTYPE,#AUTHNO);
		print( 7,10,'身份核查结果:[60] ',#HCJGBL);
		print( 8,10,'操作员号 :[4   ]                  流 水 号 :[6]',$FD7,$FD4);
	}"
	</PRINT>
</RESPONSE>
<RESPONSE> <!---销折打印--->
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="存折首页" CHECK="#TAUTHTYPE=1">
	NOTHING
	</PACKAGE>
	<PRINT>
	"{
		print( 9,30,'\Z0注销\Z1');
	}"
	</PRINT>
</RESPONSE>
<RESPONSE> <!---销卡打印--->
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="卡注销申请凭证" CHECK="#TAUTHTYPE=2">
	CZFY|@tmpactno||||||@custno|||||||||||||||||||||@cardno|@brf|
	</PACKAGE>
	<PRINT>
	"{
			print( 3,50,'[ 8]',@custno);
			print( 5,24,'[19]',@tmpactno);
			print(10, 9,'业务  类型:[ 4]',@brf);
			print(11, 9,'原帐(卡)号:[19]',@cardno);
			print(11,21,'更换后帐(卡)号:[19]',@tmpactno);
			print(12,9,'身份核查结果:[60] ',#HCJGBL);
			print(13,17,'[ 7]',$TLRNO);
			print(13,80,'流水号:[ 5]',$FD4);
	}"
	</PRINT>
</RESPONSE>
<OUTPUT>
</OUTPUT>
</TRANSACTION>
