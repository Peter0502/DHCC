<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111011000000000000000000000" TITLE="3708   待结算电子现金结清"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>
 "{
							initfd();
							commsend_001();
							$FD16='7770';
							$FD30=#CARD_NO;
							$FD25=#CUSTNAME;
							$FD22=#ZJLX;
							$FD62=#ZJHM;
							$FD40=itoa(atoi(#AVAILABLE_BAL)*100,'%012.0f');
							$FD21=#JQFS;
							if(#JQFS=='02')
							{
							$FD31=#CARD_NO_IN;
							}
							callagn();
							//showmsg('$FD12='+$FD12);
							//$FD12 = '0000';
							if($FD12 == '7114')
							{		
								showmsg('持卡人的证件信息校验未通过，拒绝交易!');
								return(false);
							}
							if($FD12 == '7115')
							{		
								showmsg('持卡人的姓名校验未通过，拒绝交易!');
								return(false);
							}
							if($FD12 == 'CE93')
							{		
								showmsg('未到结清日期!');
								return(false);
							}
							if($FD12 != '0000')
							{		
								showmsg(geterror());
								return(false);
							}
							#CARD_TRACENO_TRAN=$FD75;
							//showmsg('结清交易卡系统成功！');
							<!--往核心记账-->
							<!--    进核心   -->
							initfd();
							commsend_001();
							$FD16='3708';
							$FD30=#CARD_NO;
							$FD40=atoi(#AVAILABLE_BAL);   // 交易金额  
							<!--若下方被注起，表示在测试-->   
							$FD64=#ACCNO;  //电子钱包账户记账科目
							if(#JQFS=='01')
							{               
							$FD67='0';  //销卡现金结清
							}
							if(#JQFS=='02')
							{               
							$FD67='1';  //换卡转账结清
							$FD31=delspace(#CARD_NO_IN);
							}
							$FD32=#IN_AC_NO;
   }"
</COMMSEND>
<COMMRECV>
  "{ 
  //撤销时，解决交易不成功时打印空凭证的问题
   dim @tmpFD12 as string; 
   @tmpFD12=$FD12;         
	if($FD12=='0000')
	{
		//showmsg('核心处理成功!');
	}
	else
	{
		//showmsg('核心处理失败，发起撤销交易!');
		initfd();
		commsend_001();
		$FD16='7111';
		//$FD30=#CARD_NO_IN;
		$FD21='156';  //$FD21=substr($FD101,140,2);  当前默认只识别RMB
		$FD30=#CARD_NO;
		$FD39=itoa(atoi(#AVAILABLE_BAL)*100,'%012.0f');  // 交易金额
		//showmsg('交易金额$FD39='+ $FD39);
		$FD43=#CARD_TRACENO_TRAN;   // 原交易流水
		//showmsg('原交易流水='+ $FD43);

		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror()+'，撤销失败');
			return (false);
		}
		$FD12=@tmpFD12; 
   }
  }"
</COMMRECV>
<VARIABLE UPLOOP="TRUE">
		<ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
		"T(3708                             待结算电子现金结清)"/>
		<ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
		"T(─────────────────────────────────────)"/>
		<ITEM NAME="#TXNO"    TYPE="%-4s"  FUNCTIONS="T($TXNO=3708)"/>
		<ITEM NAME="#MSGTYPE" TYPE="%-5s"  FUNCTIONS="T($MSGTYPE=03001)"/>
		<ITEM NAME="#TXCD"    TYPE="%4s"   FUNCTIONS="T(3708)"/>      <!---交易代码--->
		<ITEM NAME="#L_JQFS" LINE="7"  COL="17"  TYPE="%-10s"  FUNCTIONS="T(结清方式: )"/>
		<!--输出变量--->
		<ITEM  LINE="9"  COL="17"  TYPE="%-10s" FUNCTIONS="T(原  卡号:)"/>		
		<ITEM LINE="10"  COL="17"  TYPE="%-10s" FUNCTIONS="T(客户姓名:)"/>
		<ITEM LINE="11"  COL="17"  TYPE="%-10s" FUNCTIONS="T(证件类型:)"/>
		<ITEM LINE="12"  COL="17"  TYPE="%-10s" FUNCTIONS="T(证件号码:)"/>
		<ITEM LINE="15"  COL="17"  TYPE="%-10s" FUNCTIONS="T(结清金额:)"/>
		<ITEM NAME="#CARD_TRACENO_TRAN" TYPE="%-16s" FUNCTIONS=""/>          <!--卡系统返回交易流水号-->
		<ITEM NAME="#CARD_NO_IN_FLAG" LINE="16"  COL="17"  TYPE="%-10s" VISABLE="FALSE" FUNCTIONS="T(转入卡号:)"/>
		<ITEM LINE="7 "  COL="25" TYPE="%-2s"  NAME="#JQFS" INPUT="SELECT"   FUNCTIONS="V(NB)T(01)">
			<SELECT>
				<OPTION VALUE="01" TITLE="销卡现金结清"/>
				<OPTION VALUE="02" TITLE="换卡转账结清"/>
			</SELECT>
				<ONLOSTFOCUS>
					  "{
					   if(#JQFS=='01')
					   {
					   show(#CARD_NO_IN_FLAG,false);
					   show(#CARD_NO_IN,false);
						 enable(#CARD_NO_IN,false);
					   }
					   if(#JQFS=='02')
					   {
					   show(#CARD_NO_IN_FLAG,true);
					   show(#CARD_NO_IN,true);
						 enable(#CARD_NO_IN,false);
					   }
					   }"
				</ONLOSTFOCUS>
			</ITEM>
		<ITEM NAME="#CARD_NO"   INPUT="TEXT" LINE="9" COL="25" TYPE="%-20s"  FUNCTIONS="V(NB)">			
			  <ONLOSTFOCUS>
					  "{
						if(len(rtrim(#CARD_NO))!=19)
						{
						   showmsg('卡号长度不正确，请重新输入!');
						   return(false);
						}                       
						if(substr(#CARD_NO,0,6)!= '621780')
						{
							showmsg('卡号的前6位必须为621780');
							return(false);
						}						
						dim @baktxno as string;
						initfd();
						@baktxno=$TXNO;
						//因和销卡业务复用9959查询交易，所以设68域与此交易区分
						$FD68='1';
						//因和销卡业务复用9959查询交易，所以设68域与此交易区分
						$TXNO='9959';
						$FD102=#CARD_NO;						
						commsend_001();
						callserver();
						//$FD12='P245';
						$TXNO=@baktxno;
						if(#JQFS=='01')
						 {
						  if($FD12!='P245')
						    {
								showmsg('该卡非销卡状态，请确认结清方式是否选择正确！');
								return(false);
								}    
						 } 
						
						if(#JQFS=='02')
						{ 
							if($FD12!='M022' and  $FD12!='P171')
						 		{
								showmsg('该卡非换卡状态，请确认结清方式是否选择正确！');
								return(false);
								} 
								initfd();
								commsend_001();
								$FD16='6000';
								$FD30=#CARD_NO;
								callserver();
								if($FD12!='0000')
								{
								
								showmsg(geterror());
								return(false);
				        }
				        #CARD_NO_IN= delspace($FD31);
				        //showmsg('#CARD_NO_IN='+#CARD_NO_IN);
						}   
					 }"
		</ONLOSTFOCUS>
		</ITEM>
		<ITEM NAME="#IN_AC_NO"        TYPE="%-20s"  FUNCTIONS=""/>  <!---IC卡电子现金内部账户--->
		<ITEM NAME="#ACCNO"           TYPE="%-7s"   FUNCTIONS="">
		<ONLOSTFOCUS>
		"{
			initfd();
			commsend_001();
			$FD31=#CARD_NO;
			$FD16='9162';
			callserver();
			if($FD12!='0000')
			{
			  showmsg(geterror());
			  return(false);
			}
			#ACCNO=$FD64;//电子钱包账户记账科目 
			#IN_AC_NO=$FD30;
		}"
		</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="10" COL="25" TYPE="%-40s" NAME="#CUSTNAME" 	DEVICE="KEYBOARD"  FUNCTIONS="V(NB)"/>
		<ITEM LINE="11" COL="25" TYPE="%-1s" NAME="#ZJLX" DEVICE="KEYBOARD" FUNCTIONS="V(NB)T(00)" INPUT="SELECT" ">
		<SELECT>
			<OPTION VALUE="1" TITLE="身份证"/>
			<OPTION VALUE="2" TITLE="户口薄"/>
			<OPTION VALUE="3" TITLE="护照  "/>
			<OPTION VALUE="4" TITLE="军官证"/>
			<OPTION VALUE="5" TITLE="回乡证"/>
			<OPTION VALUE="6" TITLE="士兵证"/>
			<OPTION VALUE="7" TITLE="港澳居民来往通行证"/>
			<OPTION VALUE="E" TITLE="临时身份证"/>
			<OPTION VALUE="F" TITLE="外国人居留证"/>
			<OPTION VALUE="G" TITLE="警官证"/>
			<OPTION VALUE="H" TITLE="其他证件"/>
			<OPTION VALUE="I" TITLE="台湾同胞来往通行证"/>
		</SELECT>
		</ITEM>
		<!-- 为核查结果中文传值的变量 wudawei 20131101 -->
  		<ITEM NAME="#HCJGBL"  TYPE="%-60s" />
		<ITEM LINE="12"  COL="25" TYPE="%-20s"  NAME="#ZJHM" DEVICE="KEYBOARD" FUNCTIONS="V(NB)" INPUT="TEXT" >
		<ONLOSTFOCUS>
					  "{
					  //add 20131030 wudawei start 调用身份核查
		  		  dim @res as string;
						if(#ZJLX=='1' or #ZJLX=='2')
						{
							@res = idcheck(#ZJHM,#CUSTNAME);
							#HCJGBL = strfld(@res,'|',1);
							@res =  strfld(@res,'|',0);
							if(@res=='02' or @res=='03' or @res=='04' or @res=='05' or @res=='06')
							{
									showmsg('身份核查结果不通过，不能继续办理！');
									return(false);
							}
						}
						//add 20131030 end
							
							
					  <!--必须在销卡状态下调此交易，否则会卡死的-->
							initfd();
							commsend_001();
							$FD16='7769';
							$FD30=#CARD_NO;
							callagn();
							if($FD12 != '0000')
							{		
								showmsg(geterror());
								return(false);
							}
							#AVAILABLE_BAL=delspace(itoa(val($FD40,0.01),'%17.2f'));
							show(#AVAILABLE_BAL,true);
					  }"
		</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="15"  COL="25" NAME="#AVAILABLE_BAL" INPUT="LABEL" VISABLE="FALSE" TYPE="%-17s" FUNCTIONS=""/>		
		<ITEM NAME="#CARD_NO_IN"  INPUT="TEXT" LINE="16" COL="25" TYPE="%-20s" VISABLE="FALSE" FUNCTIONS="V(NB)"/>			  
		<ITEM NAME="#TEMP"  TYPE="%-13s"  FUNCTIONS="">
		<ONLOSTFOCUS>
					  "{
					  if(#JQFS=='02')
						{
						if(len(rtrim(#CARD_NO_IN))!=19)
						{
						   showmsg('卡号长度不正确，请重新输入!');
						   return(false);
						}                       
						if(substr(#CARD_NO_IN,0,6)!= '621780' and substr(#CARD_NO_IN,0,6)!= '621223')
						{
							showmsg('卡号的前6位必须为621780或者621223');
							return(false);
						}	
						initfd();
						commsend_001();
						$FD16='9959';
						$FD102=#CARD_NO_IN;
						//因和销卡业务复用9959查询交易，所以设67，68两个标志域来与此交易区分
						$FD68='1';
						//因和销卡业务复用9959查询交易，所以设67，68两个标志域来与此交易区分
						callserver();
						if($FD12!='0000'){
						showmsg(geterror());
						return(false);
						}
						#ZR_NAME=substr($FD102,125,35);//户名	
						#AC_BAL = val(delspace(substr($FD102,185,16)),0.01);//账户余额				
					//showmsg('#ZR_NAME='+#ZR_NAME);
					//showmsg('#AC_BAL='+#AC_BAL);
					<!--
						initfd();
						commsend_001();
						$FD32=rtrim(#CARD_NO_IN);
						$FD16='9405' ;
						callserver();
						if($FD12!='0000'){
						  showmsg(geterror());
						  return(false);
						}
						#ZR_NAME = $FD25 ;//户名
						#AC_BAL = val(delspace($FD39),0.01);//账户余额
						-->
						 enable(#ZR_NAME,false);
							enable(#AC_BAL,false);
							show(#L_ZR_NAME,true);
							show(#ZR_NAME,true);
							show(#L_AC_BAL,true);
							show(#AC_BAL,true);   
						}
						#I_AVAILABLE_BAL=atoi(#AVAILABLE_BAL);
								 }"
		</ONLOSTFOCUS>
		</ITEM>	
		<ITEM NAME="#L_ZR_NAME" LINE="17"  COL="17"  TYPE="%-13s"  VISABLE="FALSE" FUNCTIONS="T(客户姓名:)"/>
		<ITEM NAME="#ZR_NAME"   LINE="17"  COL="25" TYPE="%-20s"  VISABLE="FALSE" INPUT="TEXT" FUNCTIONS=""/>
		<ITEM NAME="#L_AC_BAL"  LINE="18"  COL="17" TYPE="%-13s" VISABLE="FALSE" FUNCTIONS="T(账户余额:)"/> 
		<ITEM NAME="#AC_BAL"    LINE="18"  COL="25" TYPE="%17.2f"  INPUT="TEXT" VISABLE="FALSE" FUNCTIONS="V(0000000000000001,9999999999999999)"/>
		<ITEM NAME="#I_AVAILABLE_BAL"  TYPE="%17.2f"   FUNCTIONS=""/>
		<ITEM NAME="#SUM_BAL"    TYPE="%17.2f"   FUNCTIONS="E(#AC_BAL+#I_AVAILABLE_BAL)"/>
		<ITEM LINE="21"  COL="59" TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT" />
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
	<PACKAGE DEVICE="SCREEN"  DESC="交易完成">
		NOTHING
	</PACKAGE>
	<PRINT>
	"{
		print(8,25,'操 作 成 功!');
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(电子现金现金结清)" CHECK="#JQFS=01">
		NOTHING
	</PACKAGE>
	<PRINT>
	"{
		dim @txday  as string;
		dim @txtime as string;
		dim @amt    as string;
		dim @ltxamt1    as string;
		@amt       ='￥'+ltrim(comma(#AMT));
		@ltxamt1   ='￥'+ltrim(comma(#LTXAMT1));
		@txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 5, 20,'机构名称:[30]',$BRNAME);
		print( 5,  2,'代码:3708');
		print(5,13,'交易:电子现金现金结清');	
		
		print( 7,30,'\L0电子现金现金结清凭条\L1');  
    print(10, 20,'IC卡 号:[20                    ]    户    名:[20                    ]',#CARD_NO,#CUSTNAME);
    print(11, 20,'账户类型:[20                    ]   交易类型:[20                    ]','电子现金账户','电子现金结清');
    print(13, 20,'交易金额:[20                    ]   电子现金余额:[20                    ]',atoi(#AVAILABLE_BAL),'0.00');
    print(14, 20,'身份核查结果:[60] ',#HCJGBL);
    print_sq(); 
    print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
    print(21,80,'客户签名:_____________________'); 
	
    print(23,20,'备注:');
    print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
    print(23,5,'柜员:[4]',$FD7);
    print(23,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(电子现金结清转取)" CHECK="#JQFS=02">
	CKPT|@actno|@custname|@txamt|@prodname|@opn_day|@brno|@custno|||||@avbal||||||@tx_type|||@sv_type||||||||||@id_type|@id_no|@br_name||@note_no||@acc_no|@tx_brno|@term|@term_type|@rate|
	</PACKAGE>
	<PRINT>
	"{
		dim @txday  as string;
		dim @txtime as string;
		dim @amt    as string;
		dim @ltxamt1    as string;
		@amt       ='￥'+ltrim(comma(#AMT));
		@ltxamt1   ='￥'+ltrim(comma(#LTXAMT1));
		@txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 5, 20,'机构名称:[30]',$BRNAME);
		print( 5,  2,'代码:3708');
		print(5,13,'交易:电子现金转账结清');	
		
		print( 7,30,'\L0电子现金转账结清凭条\L1'); 
		print( 9,20,'开 户 行:[5    ]                  交 易 行:[7]',@brno,$FD3);
		print(10, 20,'转出账号:[20                    ]   户    名:[20                    ]',#CARD_NO,#CUSTNAME);
    print(11, 20,'账户类型:[20                    ]   交易类型:[20                    ]','电子现金账户','电子现金结清转取');
    print(12, 20,'交易金额:[21  ]  电子现金余额:[21                       ]',#AVAILABLE_BAL,'0.00');
    print(13, 20,'身份核查结果:[60] ',#HCJGBL);
    print_sq(); 
    print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
    print(21,80,'客户签名:_____________________'); 
	
    print(23,20,'备注:');
    print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
    print(23,5,'柜员:[4]',$FD7);
    print(23,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(电子现金结清转存)" CHECK="#JQFS=02">
	CKPT|@actno|@custname|@txamt|@prodname|@opn_day|@brno|@custno|||||@avbal||||||@tx_type|||@sv_type||||||||||@id_type|@id_no|@br_name||@note_no||@acc_no|@tx_brno|@term|@term_type|@rate|
	</PACKAGE>
	<PRINT>
	"{
		dim @txday  as string;
		dim @txtime as string;
		dim @amt    as string;
		dim @ltxamt1    as string;
		@amt       ='￥'+ltrim(comma(#AMT));
		@ltxamt1   ='￥'+ltrim(comma(#LTXAMT1));
		@txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 5, 20,'机构名称:[30]',$BRNAME);
		print( 5,  2,'代码:3708');
		print(5,13,'交易:电子现金转账结清');	
		
		print( 7,30,'\L0电子现金转账结清凭条\L1'); 
		print( 9,20,'开 户 行:[5    ]                  交 易 行:[7]',@brno,$FD3);
		print(10, 20,'账/卡 号:[20                    ]   户    名:[20                    ]',#CARD_NO_IN,#ZR_NAME);
		print(11, 20,'账户类型:[20                    ]   交易类型:[20                    ]','IC借记卡账户','电子现金结清转存');
		print(13, 20,'交易金额:[21  ]  余    额:[21                       ]',#AVAILABLE_BAL,#SUM_BAL);
		print(14, 20,'身份核查结果:[60] ',#HCJGBL);
    print_sq(); 
    print(19,80,'\H0本人已确认银行打印记录正确无误.\H1');
    print(21,80,'客户签名:_____________________'); 
	
    print(23,20,'备注:');
    print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
    print(23,5,'柜员:[4]',$FD7);
    print(23,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>



<OUTPUT>
</OUTPUT>

</TRANSACTION>
