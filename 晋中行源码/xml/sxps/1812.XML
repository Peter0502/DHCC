<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111011100000000000001100010" TITLE="1812       通存业务)"
	xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
	<COMMSEND>
		"{
		}"
	</COMMSEND>
	<COMMRECV>
		"{
		}"
	</COMMRECV>

	<VARIABLE>
		<ITEM TYPE="%-30s" NAME="#TXNAME" FUNCTIONS="T(通存业务)"/>
		<ITEM LINE="2" TYPE="%-3s" NAME="#PayerAcctType" FUNCTIONS="T()"/>
		<ITEM LINE="3" COL="1" TYPE="%-46s" FUNCTIONS="T(1812                               通 存 业 务)"/>
		<ITEM LINE="4" COL="1" TYPE="%-77s" FUNCTIONS="T(────────────────────────────────────────────────────────────────────────────)"/>
		<ITEM NAME="#TXCODE" TYPE="%-30s" FUNCTIONS="T(1812)"/>
		<ITEM NAME="#TXNAME" TYPE="%-30s" FUNCTIONS="T(通 存 业 务)"/>
		<BLOCK NAME="block_head" LINE="5" VISABLE="TRUE">
			<ITEM LINE="0" COL="3"  TYPE="%-11s" FUNCTIONS="T(通存 方式 :)"/>
			<ITEM LINE="0" COL="15" TYPE="%-1s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#DepositWay" FUNCTIONS="V(NB)T(2)">
				<SELECT>
					<OPTION VALUE="1" TITLE="1.现金"/>
					<OPTION VALUE="2" TITLE="2.转账"/>
				</SELECT>
				<ONLOSTFOCUS>
					"{
						if(#DepositWay=='1')
						{
							showblock('block_pay0',false,false);
							showblock('block_pay1',false, false);
							showblock('block_pay2',false,false);
							showblock('block_pay4',false,false);
							showblock('Block_ID',true,true);
							#PayerAcct='10101';
							#PayerName='科目号';
						}
						else
						{
							showblock('block_pay0',true,true);
							showblock('block_pay1',true,true);
							showblock('block_pay2',true,true);
							showblock('block_pay4',true,true);
							showblock('Block_ID',false,false);
						}
						refresh();
					}"
				</ONLOSTFOCUS>
			</ITEM>
		</BLOCK>
		<ITEM NAME="#ciftype" TYPE="%-3s" FUNCTIONS="T()"/>
		<BLOCK NAME="block_pay0" LINE="6" VISABLE="FALSE">
			<ITEM LINE="0" COL="3"  TYPE="%-11s" FUNCTIONS="T(付款人介质:)"/>
			<ITEM LINE="0" COL="15" TYPE="%-1s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#PayerCardFlag" FUNCTIONS="V(NB)T(0)">
				<SELECT>
					<OPTION VALUE="0" TITLE="0.磁条卡"/>
					<OPTION VALUE="1" TITLE="1.存折"/>
					<OPTION VALUE="2" TITLE="2.IC卡"/>
				</SELECT>
			</ITEM>
			<ITEM LINE="0" COL="37"  TYPE="%-11s"  FUNCTIONS="T(付款人账号:)"/>
			<ITEM LINE="0" COL="50" NAME="#PayerAcct" INPUT="TEXT" TYPE="%-26s" FUNCTIONS="T()V(NB)">
				<ONLOSTFOCUS>
					"{
					//需要callserver 调用核心

					if(substr(#PayerAcct,0,1) == '9')
					{
					
						showmsg(#PayerAcct);
						#PayerAcctType='3';
						showblock('block_pay3', true, true);
						showblock('block_pay2', false, false);
					}
					else
					{
						
						#PayerAcctType='1';
						showblock('block_pay2', true, true);
						showblock('block_pay3', false, false);
					}

					initfd();
					commsend_001();
					$FD16='1404';
					$FD18='pbp';
					$FD30=#PayerAcct;
					$FD73='00001000';
					callagnpbp();
					if($FD12 != '0000')
					{
					showmsg(geterror());
					return(false);
					}
					#PayerName=$FD25;
					#Balamt=$FD82;
					#ciftype=$FD67;

					}"
				</ONLOSTFOCUS>
			</ITEM>
		</BLOCK>
		<BLOCK NAME="block_pay1" LINE="7" VISABLE="FALSE">
			<ITEM LINE="0" COL="3"  TYPE="%-11s"  NAME="#LabelPayerName" FUNCTIONS="T(付款人名称:)"/>
			<ITEM LINE="0" COL="15" NAME="#PayerName"  INPUT="TEXT" TYPE="%-20s" FUNCTIONS="T()V(NB)"/>
		</BLOCK>
		<BLOCK NAME="block_pay4" LINE="7" VISABLE="FALSE">
			<ITEM LINE="0" COL="37"  TYPE="%-11s"   FUNCTIONS="T(账户  余额:)"/>
			<ITEM LINE="0" COL="50" NAME="#Balamt"  INPUT="TEXT" TYPE="%-26s" FUNCTIONS="T()V(NB)"/>
		</BLOCK>
		<BLOCK NAME="block_pay2" LINE="8" VISABLE="FALSE">
			<ITEM LINE="0" COL="3" TYPE="%-11s" FUNCTIONS="T(密      码:)"/>
			<ITEM LINE="0" COL="15" NAME="#PayPasswd" INPUT="TEXT" TYPE="%-6s" FUNCTIONS="i()V(NB)">
				<ONLOSTFOCUS>
				"{
					initfd();
					commsend_001();
					$FD16='9317';
					$FD30=#PayerAcct;
					$FD79=#PayPasswd;
					callserver();
					if($FD12 != '0000')
					{
						showmsg(geterror());
						return(false);
					}
					showmsg('密码校验成功');
		  		}"
		  		</ONLOSTFOCUS>
			</ITEM>
		</BLOCK>
		<BLOCK NAME="block_pay3" LINE="8" VISABLE="FALSE">
			<ITEM LINE="0" COL="3" TYPE="%-11s" FUNCTIONS="T(协 议 号  :)"/>
			<ITEM LINE="0" COL="15" NAME="#ContractNo" INPUT="TEXT" TYPE="%-20s" FUNCTIONS="T()"/>
		</BLOCK>
		<BLOCK NAME="Block_ID" LINE="8"  COL="3" VISABLE="FALSE">
		<ITEM LINE="0" COL="0" TYPE="%-11s" FUNCTIONS="T(证件  类型:)"/>
		<ITEM NAME="#IDType" LINE="0" COL="11" INPUT="SELECT"  TYPE="%-1s"  FUNCTIONS="T(0)V(NB)">
		<SELECT>
			<OPTION VALUE="0" TITLE="身份证"/>
			<OPTION VALUE="1" TITLE="学生证"/>
			<OPTION VALUE="2" TITLE="其他证"/>
		</SELECT>
		</ITEM>
		<ITEM LINE="0" COL="40" TYPE="%-11s" FUNCTIONS="T(证件  号码:)"/>
		<ITEM NAME="#IDNo" LINE="0" COL="51" INPUT="TEXT"  TYPE="%-18s"  FUNCTIONS="T()V(NB)">
			<ONLOSTFOCUS>
			"{
				initfd();
				commsend_001();
				$FD16='1201';
				$FD18='app';
				$FD31=#IDNo;
				callagnpbp();
				if($FD12 != '0000')
				{
					showmsg(geterror());
					return(false);
				}
				showmsg('身份证校验成功');
	  		}"
	  		</ONLOSTFOCUS>
		</ITEM>
		</BLOCK>
		<BLOCK NAME="block_payee" LINE="10" VISABLE="TRUE">
			<!--ITEM LINE="0" COL="3"  TYPE="%-14s" FUNCTIONS="T(收款人介质:)"/>
			<ITEM LINE="0" COL="15" TYPE="%-1s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#PayeeCardFlag" FUNCTIONS="V(NB)T(0)">
			<SELECT>
			<OPTION VALUE="0" TITLE="0.磁条卡"/>
			<OPTION VALUE="1" TITLE="1.折"/>
			<OPTION VALUE="2" TITLE="2.IC卡"/>
			</SELECT>
		</ITEM-->

		<ITEM LINE="0" COL="3"  TYPE="%-15s" FUNCTIONS="T(收款人账户类型:)"/>
		<ITEM LINE="0" COL="19" TYPE="%-1s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#PayeeAcctType" FUNCTIONS="V(NB)T(1)">
			<SELECT>
				<OPTION VALUE="1" TITLE="1.个人"/>
				<OPTION VALUE="2" TITLE="2.对公"/>
				<OPTION VALUE="3" TITLE="3.外币"/>
			</SELECT>
		</ITEM>

		<ITEM LINE="1" COL="3"   TYPE="%-11s" FUNCTIONS="T(收款行行号:)"/>
		<ITEM LINE="1" COL="15"  TYPE="%-20s" INPUT="TEXT" DEVICE="KEYBOARD" NAME="#InBankNo" FUNCTIONS="V(NB)T()">
			<ONLOSTFOCUS>
				"{
				//调用平台交易,根据行号查询行名
				// #InBankNoName='晋中商业银行';
				initfd();
				commsend_001();
				$FD16='1101';
				$FD18='pbp';
				$FD59=#InBankNo;
				callagnpbp();
				if($FD12!='0000')
				{
				showmsg(geterror());
				return(false);
				}
				#InBankNoName=$FD76;
				}"
			</ONLOSTFOCUS>
		</ITEM>

		<ITEM LINE="1" COL="37"   TYPE="%-11s" FUNCTIONS="T(收款行名称:)"/>
		<ITEM LINE="1" COL="50"  TYPE="%-50s" INPUT="TEXT" DEVICE="KEYBOARD" NAME="#InBankNoName" FUNCTIONS="V(NB)T()"/>

		<ITEM LINE="2" COL="3"    TYPE="%-11s" FUNCTIONS="T(收款人账号:)"/>
		<ITEM LINE="2" COL="15"   NAME="#PayeeAcct" INPUT="TEXT" TYPE="%-20s" FUNCTIONS="T()V(NB)">
			<ONLOSTFOCUS>
				"{
					if (len(#PayeeAcct) &lt; 11)
					{
						showmsg('账号错误，请重新输入');
						return(false);
					}
					
					initfd();
					commsend_001();
					$FD16='6232';
					$FD30=#PayeeAcct;
					$FD73='00001000';
					callserver();
					if($FD12 != 'C114')
					{
						showmsg('收款人账号不能为行内账号');
						return(false);
					}
					
				}"
			</ONLOSTFOCUS>
		</ITEM>

		<ITEM LINE="2" COL="37"    TYPE="%-11s" FUNCTIONS="T(收款人名称:)"/>
		<ITEM LINE="2" COL="50"   NAME="#PayeeName" INPUT="TEXT" TYPE="%-26s" FUNCTIONS="T()V(NB)"/>

		<ITEM LINE="3" COL="3" TYPE="%-11s" FUNCTIONS="T(交易  金额:)"/>
		<ITEM LINE="3" COL="15" NAME="#TradeAmt" INPUT="TEXT" TYPE="%16.2f" FUNCTIONS="T()V(0000000000000001,9999999999999999)">
			<ONLOSTFOCUS>
				"{
				}"
			</ONLOSTFOCUS>
		</ITEM>

		<ITEM LINE="4" COL="3" TYPE="%-11s" FUNCTIONS="T(手续费标志:)"/>
		<ITEM LINE="4" COL="15" TYPE="%-1s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#FeeWay" FUNCTIONS="T(2)V(NB)">
			<SELECT>
				<OPTION VALUE="0" TITLE="0.现金"/>
				<OPTION VALUE="1" TITLE="1.账户"/>
				<OPTION VALUE="2" TITLE="2.不收"/>
			</SELECT>
			<ONLOSTFOCUS>
				"{
				if(#FeeWay=='2')
				{
					show(#LabelFeeAmt,false);
					show(#FeeAmt,false);
				}
				else
				{
					show(#LabelFeeAmt,true);
					show(#FeeAmt,true);
					
					initfd();
					commsend_001();
					$FD16='1104';
					$FD18='app';
					$FD39=itoa(#TradeAmt,'%.2f');
					$FD64='1201';
					$FD65='P_PBP';
					callagnpbp();
					if($FD12 != '0000')
					{
						showmsg(geterror());
						return(false);
					}
					#FeeAmt=ltrim(itoa($FD39,'%.2f'));
					enable(#FeeAmt,false);
				}
				}"
			</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="4" COL="37" NAME="#LabelFeeAmt" TYPE="%-11s"    INPUT="LABEL" VISABLE="FALSE" FUNCTIONS="T(手  续  费:)V(0000000000000001,9999999999999999)"/>
		<ITEM LINE="4" COL="50" NAME="#FeeAmt" INPUT="TEXT" VISABLE="FALSE" TYPE="%16.2f" FUNCTIONS="T()V(NB)"/>
	</BLOCK>


	<BLOCK NAME="block_tx" LINE="16" VISABLE="TRUE">
		<ITEM LINE="0" COL="3" TYPE="%-11s" FUNCTIONS="T(货币代码  :)"/>
		<ITEM LINE="0" COL="15"  TYPE="%-3s"  INPUT="SELECT" DEVICE="KEYBOARD" NAME="#CurrCode" FUNCTIONS="V(NB)T(CNY)">
			<SELECT>
				<OPTION VALUE ="CNY" TITLE="1.人民币" />
				<OPTION VALUE ="USD" TITLE="2.美元 " />
				<OPTION VALUE ="HKD" TITLE="3.港币" />
				<OPTION VALUE ="EUR" TITLE="4.欧元" />
				<OPTION VALUE ="GBP" TITLE="5.英镑 " />
				<OPTION VALUE ="JPY" TITLE="6.日元" />
			</SELECT>

		</ITEM>

		<ITEM LINE="0" COL="37" TYPE="%-11s" FUNCTIONS="T(钞汇类型  :)"/>
		<ITEM LINE="0" COL="50"  TYPE="%-1s"  INPUT="SELECT" DEVICE="KEYBOARD" NAME="#CurrType" FUNCTIONS="V(NB)T(0)">
			<SELECT>
				<OPTION VALUE="0" TITLE="丙钞"/>
				<OPTION VALUE="2" TITLE="甲汇"/>
				<OPTION VALUE="3" TITLE="乙钞"/>
				<OPTION VALUE="4" TITLE="乙汇"/>
				<OPTION VALUE="6" TITLE="丙汇"/>
			</SELECT>
			<ONLOSTFOCUS>
				"{
				dim @tota as string;
				dim @actp as string;

				//if(substr(#PayerAcct,0,1) == '9')
				//{
				//	@actp='3';
				//}
				//else
				//{
				//	@actp='1';
				//}

				initfd();
				commsend_001();
				$FD16='1104';
				$FD18='pbp';
				$FD20=#PayeeAcctType;
				$FD35='1210';
				$FD51='01';
				$FD22=#DepositWay;
				$FD59=#InBankNo;
				$FD67=#ciftype;
				@tota=callagnpbp();
				if($FD12!='0000')
				{
				showmsg(geterror());
				return(false);
				}
				@tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
				setsel(#BusyType,@tota,'v4o1t32o1');
				refresh();
				}"
			</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="1" COL="3" TYPE="%-11s" FUNCTIONS="T(业务类型  :)"/>
		<ITEM NAME="#BusyType" LINE="1" COL="15" INPUT="SELECT"  TYPE="%-4s" FUNCTIONS="T()V(NB)">
			<SELECT>
			</SELECT>
			<ONLOSTFOCUS>
				"{
				initfd();
				dim @tota as string;
				commsend_001();
				$FD16='1105';
				$FD18='pbp';
				$FD34=#BusyType;
				@tota=callagnpbp();
				if($FD12!='0000')
				{
				showmsg(geterror());
				return(false);
				}
				@tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
				setsel(#BusyKind,@tota,'v5o1t32o1');
				refresh();
				}"
			</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="1" COL="37" TYPE="%-11s" FUNCTIONS="T(业务种类  :)"/>
		<ITEM NAME="#BusyKind" LINE="1" COL="50" INPUT="SELECT"  TYPE="%-5s"  FUNCTIONS="T()V(NB)">
			<SELECT>
			</SELECT>
			<ONLOSTFOCUS>
				"{
				initfd();
				dim @tota as string;
				commsend_001();
				$FD16='1109';
				$FD18='pbp';
				$FD19='P_PBP';
				$FD28='sxps';
				$FD35='1210';
				//业务种类
				$FD64='09001';
				//业务类型
				$FD34='C100';
				//交易类型
				$FD65='01';
				//现转标志
				$FD23=#DepositWay;
				//借贷标志
				$FD36='2';
				//客户类型
				$FD67=#PayeeAcctType;

				@tota=callagnpbp();
				if($FD12 != '0000')
				{
				showmsg(geterror());
				return(false);
				}
				@tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
				setsel(#BillType,@tota,'v2o1t60o1');

				refresh();
				}"
			</ONLOSTFOCUS>
		</ITEM>
		<ITEM LINE="2" COL="3" TYPE="%-11s"  FUNCTIONS="T(票据种类  :)"/>

		<ITEM LINE="2" COL="15" TYPE="%-2s" INPUT="SELECT" DEVICE="KEYBOARD" NAME="#BillType" FUNCTIONS="V(NB)T()">
			<SELECT>
			</SELECT>
		</ITEM>
		<ITEM LINE="3" COL="3" TYPE="%-11s" FUNCTIONS="T(票据号码  :)"/>
		<ITEM LINE="3" COL="15" NAME="#CertNo" INPUT="TEXT" TYPE="%-20s" FUNCTIONS="T()V(NB)"/>

		<ITEM LINE="3" COL="37" TYPE="%-11s" FUNCTIONS="T(票据日期  :)"/>
		<ITEM LINE="3" COL="50" NAME="#IssueDate" INPUT="TEXT" TYPE="%-8d" FUNCTIONS="D()V(NB)D()">
		</ITEM>
</BLOCK>


<BLOCK NAME="block_ps" LINE="20" VISABLE="TRUE">
	<ITEM LINE="0" COL="3" TYPE="%-11s" FUNCTIONS="T(附    言  :)"/>
	<ITEM LINE="0" COL="15" NAME="#Ps" INPUT="TEXT" TYPE="%-62s" FUNCTIONS="T()V(NB)">
		<ONLOSTFOCUS>
			"{
				initfd();
				commsend_001();
				
				$FD16='1202';
				$FD18='app';
				$FD25=#PayerName;
				$FD26=#PayeeName;
				$FD103=#Ps;
				$FD112='';    //无地址信息输入空
				$FD116='';
				callagnpbp();
				if($FD12!='0000')
				{
					showmsg(geterror());
					return(false);
				}
				showmsg('中文字符校验通过');
			}"
		</ONLOSTFOCUS>
	</ITEM>
</BLOCK>


<ITEM  NAME="#OK" LINE="21"  COL="63"  TYPE="%-6s"   FUNCTIONS="T(确  定)" INPUT="BUTTON">
	<ONCLICK>
		"{
		initfd();
		commsend_001();	
		$FD16='1210';
		$FD18='pbp';
		$FD28='sxps';
		$FD34= #BusyType;  //业务类型,和二代一样
		$FD64= #BusyKind; //业务种类,和二代一样
		$FD70 = #DepositWay;
		$FD48 = #CurrCode;
		$FD49 = #CurrType;
		$FD71 = #PayerCardFlag;
		// $FD72 = #PayeeCardFlag;
		$FD30 = #PayerAcct;
		$FD31 = #PayeeAcct;
		$FD25 = #PayerName;
		$FD26 = #PayeeName;
		$FD57 = #PayPasswd;
		$FD81 = #ContractNo;
		$FD59 = #InBankNo;
		$FD39 = itoa(#TradeAmt*100,'%.2f');
		$FD92 = #BillType;
		$FD60 = #CertNo;
		$FD44 = #IssueDate;
		// $FD105= #Purp;
		// $FD89 = #Priority;
		$FD67 = #FeeWay;
		$FD40 = itoa(#FeeAmt*100,'%.2f');
		$FD103= #Ps;
		//  $FD61 = #AddOriOutBankNo;
		//  $FD102= #AddPs;
		$FD77 = #PayeeAcctType;
		$FD78 =#IDType;
		$FD82 =#IDNo;

	//	if(authcheckagnpbp())
	//	{
	//		showmsg('授权处理完成，请继续!');
	//	}
	//	else
	//	{
	//		return (false);
	//	}

		callagnpbp();
		if($FD12!='0000')
		{
			//重账增加授权
			//if( delspace($FD34) == 'Z11K')
			if($FD12=='6350')
			{
				if(authcheckagnpbp())
				{
					showmsg('授权处理完成，请继续!');
					$FD68 = '1';//1表示重账已授权
					callagnpbp();//授权之后再次发往平台
				}
				else
				{
					return (false);
				}
			}
			else
			{
				showmsg(geterror());
				return(false);
			}
		}

		runoutput();
		rerun();
		refresh();
		}"
	</ONCLICK>
</ITEM>
</VARIABLE>

<REQUEST>
</REQUEST>

<RESPONSE>
	<PACKAGE DEVICE="SCREEN" DESC="按任意键退出">
		NOTHING
	</PACKAGE>
	<PRINT>
		"{
			PrintTxHead();
			if (#DepositWay == '2')
			{
				print(3, 11,'付款人账号:[20]',#PayerAcct);
				print(4, 11,'付款人姓名:[60]',#PayerName);
			}
			print(5,11,'收款人账号:[20]',#PayeeAcct);
			print(6,11,'收款人姓名:[60]',#PayeeName);
			print(7,11,'交易金额  :[20]',ltrim(itoa(#TradeAmt,'%.2f')));
			print(9,11,'交易序号:[10]',itoa(atoi($FD41)));
			print(9,41,'交易日期:[8]',$FD45);
			PrintTxTail();
		}"
	</PRINT>
</RESPONSE>

<RESPONSE>
<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证" >
NOTHING
</PACKAGE>
<PRINT>"{
		$KINDNO='00';
		dim @txtime as string;
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		
		print( 3, 10,'机构名称:[30]',$BRNAME);
		print( 3, 0,'代码:1210');
		print( 3, 5,'交易:通存交易');
		
		if (#DepositWay == '2')
		{
			print( 5, 10,'付款人账号:[20]',#PayerAcct);
   			print(5, 10,'付款人姓名:[60]',#PayerName);
   		}
   		print(7,10,'收款人账号:[20]',#PayeeAcct);
   		print(7,10,'收款人姓名:[60]',#PayeeName);
   		print(9,10,'交易金额:[20]',ltrim(itoa(#TradeAmt,'%.2f')));
		print( 11, 10,'交易序号:[10]',itoa(atoi($FD41)));
		print(11,20,'交易日期:[8]',$FD45);
		
		$FD4=itoa(atoi($FD41));
		printacdtl_1();
		print(23,10,'交易日期:[8] [8]',$HDATE,@txtime);
		print(23,5,'柜员:[4]',$FD7);
		print(23,5,'流水号:[6]',itoa(atoi($FD56)));	
	}"
	</PRINT>
</RESPONSE>
</TRANSACTION>
