<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111" TITLE="3712    IC¿¨Ïú»§ÉêÇë"
  xmlns="http://www.org.otd/MENU"  xmlns:W3CNS="http://www.w3c.org">
  <COMMSEND>
	"{    
	
	      <!--È¥¿¨ÏµÍ³Ç°²éÑ¯ÕË»§¶³½áÇé¿ö-->
        
        $FD31=#CARDNO;
        $FD34='1';//1Îª»îÆÚÕË»§0Îª¶¨ÆÚÕË»§
        commsend_001();
        $FD16='9702';
        callserver();
        if($FD12!='0000')
        {
        showmsg(geterror());
        return(false);
        }
        setitems('#AVBAL#HOLD_AMT#SPACE96',$FD100);  // Óà¶î
        //showmsg('#HOLD_AMT='+itoa(#HOLD_AMT));
        if(#HOLD_AMT &gt; 0)
        {
        showmsg('¸ÃÕË»§ÓÐ×Ê½ð¶³½á£¬²»ÄÜ×öÏú¿¨ÉêÇë£¡');
        return(false);
        }
        <!--È¥¿¨ÏµÍ³Ç°²éÑ¯ÕË»§¶³½áÇé¿öend-->
        //return(false);
	
	      dim @tx as string;
        dim @update as string;
        dim @shuju as string;
        dim @shuju1 as string;
        dim @cb as string;
        dim @kahao as string;
        dim @tagvalue1 as string;
        initfd();
        @tx=$TXNO;
        commsend_001();
        $FD16='7118';
        
        $FD30=#CARDNO;
        $FD79=#PASSWORD;
        $FD75=#MSR2BAK;
        $FD76=#MSR3BAK;
       
        $FD25=#Pinyin;
        $FD67=#ZJLX;
        $FD62=#ZJHM;
        $FD95=#SQYY;
        //$FD39=itoa(val(#LAVBAL,100),'%016.2f');  // ½»Ò×½ð¶î
        
        callagn();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }
        //showmsg('¿¨ÏµÍ³·µ»Ø³É¹¦£¡');
        #CARD_TRACENO = delspace(itoa(val($FD43),'%16d'));
        
        <!--½øºËÐÄ¶³½áÖ÷ÕË»§-->
       
        initfd();
        commsend_001();
        $FD16='2406';
        $FD31=#CARDNO;
        $FD34='1';//1Îª»îÆÚÕË»§0Îª¶¨ÆÚÕË»§
        //$FD41 = itoa(val(#LAVBAL,100),'%016.2f');   //Êµ¼Ê¶³½áµÄ½ð¶î
        $FD67='1';//´¦ÀíÀàÐÍ£¬1ÊÇ¶³½á2ÊÇ½â¶³
        $FD68='2';//¶³½á·½Ê½£¬´Ë´¦Ñ¡2Ö»½ø²»³ö·½Ê½
        $FD81='IC¿¨Ïú»§ÉêÇë¶³½á';
        
       
	}"
  </COMMSEND>
  <COMMRECV>
	"{ 
	      
        //³·ÏúÊ±£¬½â¾ö½»Ò×²»³É¹¦Ê±´òÓ¡¿ÕÆ¾Ö¤µÄÎÊÌâ
        dim @tmpFD12 as string; 
        @tmpFD12=$FD12;         
        //showmsg('$FD12='+$FD12);
	if($FD12=='0000')
	   {
		    commrecv_001();
        setitems('#HOLD_SEQN_RET',$FD49);
        //showmsg('#HOLD_SEQN_RET='+#HOLD_SEQN_RET);
	   }
	else
	   {
	       
	       if(($FD12!='0000') and ($FD12!='Z003'))
			   {
			   #RESP_CODE_TRAN=$FD12;
			   
			   }
			  else
			   {
			  #RESP_CODE_TRAN='0000';
			  
			   }
	      if(($FD12 != '0000') and ($FD12 != 'Z003') and (substr(#CARDNO,0,6)=='621223' or substr(#CARDNO,0,6)=='621780'))
	       {
	        
		       initfd();
				   commsend_001();
				   $FD16='7777';
				   $FD12=#RESP_CODE_TRAN;
				   $FD30=#CARDNO;
				   //$FD39=itoa(val(#LAVBAL,100),'%016.2f');;
				   $FD43=#CARD_TRACENO;
				  callagn();
				  if($FD12!='0000')
				  {
					showmsg('³·ÏúÏú¿¨ÉêÇëÊ§°Ü:['+geterror()+']');
				  }
				  
	       }
	       
		  }
	$FD12=@tmpFD12;
	}"
</COMMRECV>
  <VARIABLE>
    <ITEM LINE="3" COL="3" TYPE="%-44s" FUNCTIONS=
    "T(3712                           IC¿¨Ïú»§ÉêÇë)"/>
    <ITEM LINE="4" COL="3" TYPE="%-74s" FUNCTIONS=
    "T(©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©)"/>
    <ITEM NAME="#TXNO"       TYPE="%-4s"   FUNCTIONS="T($TXNO=2406)"/>
    <ITEM NAME="#MSGTYPE"    TYPE="%-5s"   FUNCTIONS="T($MSGTYPE=03001)"/>
    <ITEM NAME="#TXCD"       TYPE="%4s"    FUNCTIONS="T(7118)"/>
    <ITEM NAME="#TXNAME"     TYPE="%-14s"  FUNCTIONS="T(IC¿¨Ïú»§ÉêÇë)"/>
    <ITEM NAME="#HM"         TYPE="%-20s"  FUNCTIONS=""/>
    <ITEM NAME="#LX"         TYPE="%-1s"   FUNCTIONS=""/>
    <ITEM NAME="#KH_HM"      TYPE="%-10s"   FUNCTIONS=""/>
    <ITEM NAME="#MSR2BAK"    TYPE="%-37s"  FUNCTIONS=""/>
    <ITEM NAME="#MSR3BAK"    TYPE="%-104s" FUNCTIONS=""/>
    <ITEM NAME="#ICJSQ"      TYPE="%-4s"   FUNCTIONS=""/><!--Ó¦ÓÃ½»Ò×¼ÆÊýÆ÷-->
    <ITEM NAME="#ICMW"       TYPE="%-20s"  FUNCTIONS=""/><!--Ó¦ÓÃ½»Ò×ÃÜÎÄ-->
    <ITEM NAME="#ORIG_SEQNO" TYPE="%-16s"  FUNCTIONS=""/>
    <ITEM NAME="#RESP_CODE"  TYPE="%-6s"   FUNCTIONS=""/>
    <ITEM NAME="#HOLD_SEQN_RET" TYPE="%-4s" FUNCTIONS="T()"/><!--¶³½áÐòºÅ-->
    <ITEM NAME="#CARD_TRACENO"      TYPE="%-16s"  FUNCTIONS=""/>
    <ITEM NAME="#RESP_CODE_TRAN"    TYPE="%-4s"   FUNCTIONS=""/>
    <ITEM NAME="#AVBAL" TYPE="%17.2f" FUNCTIONS=""/>
    <ITEM NAME="#HOLD_AMT" TYPE="%17.2f" FUNCTIONS=""/>
    <ITEM NAME="#SPACE96" TYPE="%-80s" FUNCTIONS=""/>
    <ITEM LINE="6" COL="9"   TYPE="%-10s"  FUNCTIONS="T( IC ¿¨ ºÅ:)"/>
    <ITEM LINE="8" COL="9"   TYPE="%-12s"  FUNCTIONS="T(¡¾²úÆ·ÐÅÏ¢¡¿)"/>
    <ITEM LINE="9" COL="5"   TYPE="%70s"   FUNCTIONS=
    "T(----------------------------------------------------------------------)"/>
    <ITEM LINE="6" COL="19"  TYPE="%-19s"  NAME="#CARDNO"  INPUT="TEXT"    FUNCTIONS="V(NB)">
      <ONLOSTFOCUS>
       "{
        dim @baktxno as string;
        dim @tagvalue as string;
        @baktxno=$TXNO;
        if(substr(#CARDNO,0,6)!='621780')
        {
          showmsg('²»ÊÇIC¿¨£¬²»ÄÜÓÃ´Ë½»Ò××öÏú»§ÉêÇë!');
          return(false);
        }
        <!--@tagvalue= ictagvalue('9f79');
        showmsg(@tagvalue);
        if(strfld(@tagvalue,'|',0)!='9000')
        {
            showmsg('º¯ÊýictagvalueµÄ·µ»ØÖµÓÐÎó!');
            return(false);
        }
        #ICLAVBAL=strfld(@tagvalue,'|',1);
        showmsg('µç×ÓÏÖ½ð#ICLAVBAL='+delspace(#ICLAVBAL));
        #ICAVBAL=val(#ICLAVBAL,0.01);
        #MSR2BAK=$MSR2;
        showmsg('#MSR2BAK='+#MSR2BAK);
        #MSR3BAK=$MSR3;
        showmsg('#MSR3BAK='+#MSR3BAK);   -->
        $MSR2='';
        $MSR3='';
        initfd();
        @baktxno=$TXNO;
        commsend_001();
        $FD30=#CARDNO;
        $FD16='9961'; //ÊäÈë¿¨ºÅ£¬»ØÏÔÖ¤¼þÐÅÏ¢
        callserver();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }
        $TXNO=@baktxno;
        //showmsg('Ö¤¼þÀàÐÍ'+$FD67);
        //showmsg('Ö¤¼þºÅÂë'+$FD62);
        //showmsg($FD25);
        #NAME=delspace($FD25);
        //#Pinyin=getpinyin(#NAME);
        #ZJLX=delspace($FD67);
        #LX=delspace($FD67);
        #HM=delspace($FD62);
        show(#NAME,true);
        show(#Pinyin,true);

        @baktxno=$TXNO;
        initfd();
        commsend_001();
        $FD16='9951'; //¸ù¾ÝÕÊºÅ»ØÏÔÕË»§ÐòºÅ¼°ÐÅÏ¢[´¢Ðî´æ¿î½»Ò×]
        $FD101=#CARDNO;
        callserver();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }
        $TXNO=@baktxno;
        #AVBAL=val(substr($FD101,134,16),0.01);
        //showmsg('¿¨Óà¶î#AVBAL='+delspace(#AVBAL));
        enable(#NAME,false);
        //enable(#ZJLX,false);
        showblock('BOX',true,true);
        
            initfd();
            commsend_001();
            $FD62=rtrim(#CARDNO) ;
            $FD16='1717' ;//²éÑ¯ÕË»§ÐÅÏ¢
            callserver();
            if($FD12!='0000')
            {
                showmsg(geterror());
                return(false);
            }
            #KH_HM = $FD54 ;//¿Í»§ºÅ
            #OPEN_AC_ID = substr($FD44,3,5);//»§Ãû
        }"
      </ONLOSTFOCUS>
    </ITEM>
      <ITEM NAME="#OPEN_AC_ID"   LINE="4" COL="49" TYPE="%-5s"  VISABLE="false"  FUNCTIONS=""/>
      <BLOCK  LINE="0" COL="0"   NAME="BOX"    VISABLE="FALSE">
      <ITEM LINE="11" COL="9"  TYPE="%-10s"  NAME="#KHM"     FUNCTIONS="T(¿Í»§Ãû³Æ:)"/>
      <ITEM LINE="12" COL="9"  TYPE="%-10s"                  FUNCTIONS="T(Æ´ÒôÃû×Ö:)"/>
      <ITEM LINE="13" COL="9"  TYPE="%-10s"  NAME="#YE"      FUNCTIONS="T(¿¨ Óà ¶î:)"/>
      <ITEM LINE="14" COL="9"  TYPE="%-14s"  NAME="#DZXJ"    VISABLE="FALSE" FUNCTIONS="T(µç×ÓÏÖ½ðÓà¶î:)"/>
      <ITEM LINE="15" COL="9"  TYPE="%-10s"  NAME="#KLX"     FUNCTIONS="T(Ö¤¼þÀàÐÍ:!)"/>
      <ITEM LINE="16" COL="9"  TYPE="%-10s"  NAME="#ZJH"     FUNCTIONS="T(Ö¤¼þºÅÂë:)"/>
      <ITEM LINE="18" COL="9"  TYPE="%-10s"                  FUNCTIONS="T(ÃÜ    Âë:)"/>
      <ITEM LINE="19" COL="9"  TYPE="%-10s"  NAME="#YY"      FUNCTIONS="T(ÉêÇëÔ­Òò:)"/>
      <ITEM LINE="11" COL="19" TYPE="%-30s"  NAME="#NAME"    FUNCTIONS=""/>
      <ITEM LINE="12" COL="19" TYPE="%-30s"  NAME="#Pinyin"  INPUT="TEXT"  FUNCTIONS="V(NB)"/>
      <ITEM LINE="13" COL="19" TYPE="%-16s"  NAME="#LAVBAL"  FUNCTIONS="X(#AVBAL)"/>
      <ITEM                    TYPE="%17.2f" NAME="#AVBAL"   FUNCTIONS="J(#LAVBAL)"/>
      <ITEM LINE="14" COL="23" TYPE="%17.2f" NAME="#ICAVBAL" FUNCTIONS="X(#ICLAVBAL)"/>
      <ITEM                    TYPE="%17s"   NAME="#ICLAVBAL" FUNCTIONS="J(#ICAVBAL)"/>
      <!--ITEM LINE="14" COL="23" TYPE="%-16s" NAME="#ICLAVBAL" FUNCTIONS="X(#ICAVBAL)"/>
      <ITEM NAME="#ICAVBAL" TYPE="%17.2f" FUNCTIONS="J(#ICLAVBAL)"/-->
      <ITEM LINE="15" COL="19" TYPE="%-1s"   NAME="#ZJLX"    FUNCTIONS="" INPUT="SELECT">
        <SELECT>
          <OPTION VALUE="1" TITLE="0.Éí·ÝÖ¤      " />
          <OPTION VALUE="2" TITLE="1.»§¿Ú²¾      " />
          <OPTION VALUE="3" TITLE="2.»¤ÕÕ        " />
          <OPTION VALUE="4" TITLE="3.¾ü¹ÙÖ¤      " />
          <OPTION VALUE="5" TITLE="4.»ØÏçÖ¤      " />
          <OPTION VALUE="8" TITLE="7.ÆóÒµ´úÂëÖ¤  " />
          <OPTION VALUE="9" TITLE="8.×éÖ¯»ú¹¹ºÅ  " />
          <OPTION VALUE="A" TITLE="9.ÓªÒµÖ´ÕÕ    " />
          <OPTION VALUE="B" TITLE="a.¾­ÓªÐí¿ÉÖ¤  " />
          <OPTION VALUE="C" TITLE="b.ÊÂÒµ·¨ÈËÖ¤Êé" />
          <OPTION VALUE="G" TITLE="g.¾¯¹ÙÖ¤" />
        </SELECT>
        <ONLOSTFOCUS>
         "{
          if(#ZJLX!=#LX)
          {
            showmsg('Ö¤¼þÀàÐÍ²»·û!');
            return(false);
          }
         }"
        </ONLOSTFOCUS>
      </ITEM>
      <ITEM LINE="16" COL="19" TYPE="%-20s" NAME="#ZJHM"   INPUT="TEXT" FUNCTIONS="">
        <ONLOSTFOCUS>
         "{
          if(#ZJHM!=#HM)
          {
            showmsg('Ö¤¼þºÅÂë²»·û!');
            return(false);
          }
         }"
        </ONLOSTFOCUS>
      </ITEM>
      <ITEM LINE="18" COL="19" TYPE="%-6s" NAME="#PASSWORD" INPUT="TEXT" DEVICE="PINPAD" FUNCTIONS="V(NB)i()">
        <ONLOSTFOCUS>
         "{
          dim  @txname as string;
          if(substr(#CARDNO,0,6) == '621780')
          {
            @txname=$TXNO;
            initfd();
            commsend_001();
            $FD16='7007';
            $FD30=#CARDNO;
            $FD68='4';   //#OPTION ='04'
            $FD79=#PASSWORD;
            callagn();
            if( $FD12 != '0000')
            {
              showmsg(geterror());
              //return(false);
            }
            $TXNO=@txname;
            //showmsg('ÃÜÂëÐ£Ñé³É¹¦£¡');
          }
         }"
        </ONLOSTFOCUS>
      </ITEM>
      <ITEM LINE="19" COL="19" TYPE="%-50s" NAME="#SQYY" INPUT="TEXT" FUNCTIONS="V(NB)"/>
    </BLOCK>
  <ITEM LINE="21"  COL="59"  TYPE="%-10s" INPUT="SUBMIT" FUNCTIONS="T(È·   ¶¨)"/>
  </VARIABLE>
  <REQUEST>
  </REQUEST>
  <RESPONSE>
    <PACKAGE DEVICE="SCREEN" DESC="IC¿¨Ïú»§ÉêÇë">
      NOTHING
    </PACKAGE>
    <PRINT>
    "{
        print(8,25,'²Ù ×÷ ³É ¹¦!');
    }"
    </PRINT>
  </RESPONSE>
  <RESPONSE>
    <PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="Çë´òÓ¡ÒµÎñ×¨ÓÃÆ¾Ö¤(IC¿¨Ïú»§ÉêÇë)">
      NOTHING
    </PACKAGE>
    <PRINT>
     "{
        dim @txtime  as string;
        @txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
        print( 5, 20,'»ú¹¹Ãû³Æ:[30]',$BRNAME);
        print( 5,  2,'´úÂë:[4 ]','3712');
        print( 5, 13,'½»Ò×:[20]',#TXNAME);
        print( 7,30,'\L0Ïú¿¨ÉêÇëÆ¾Ìõ\L1'); 
        print( 9,20,'¿ª »§ ÐÐ:[5    ]                  ½» Ò× ÐÐ:[7]',#OPEN_AC_ID,$FD3);
        print(10, 20,'ÕË/¿¨ ºÅ:[20                    ]   »§    Ãû:[20                    ]',#CARDNO,#NAME);
        print(11, 20,'´æ    ÆÚ:[20                    ]   ½»Ò×ÀàÐÍ:[20                    ]','',#TXNAME);
        print(12, 20,'½»Ò×½ð¶î:[21  ]  ÕË»§Óà¶î:[21                       ]','0.00',#AVBAL);
        print(13, 20,'Ïú»§Ô­Òò:[21  ]  ÉêÇëÐòºÅ:[21                       ]',#SQYY,#HOLD_SEQN_RET); 
        print_sq(); 
        print(19,80,'\H0±¾ÈËÒÑÈ·ÈÏÒøÐÐ´òÓ¡¼ÇÂ¼ÕýÈ·ÎÞÎó.\H1');
        print(21,80,'¿Í»§Ç©Ãû:_____________________');     
        print(23,20,'±¸×¢:');
        print(23,27,'½»Ò×ÈÕÆÚ:[8] [8]',$HDATE,@txtime);
        print(23,5,'¹ñÔ±:[4]',$FD7);
        
     }"
    </PRINT>
  </RESPONSE>
</TRANSACTION>


