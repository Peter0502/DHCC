<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111000000000000000000000000000" TITLE="4542 抵押物品入库"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
	initfd();
	commsend_001();
	$FD16='4542';//抵质押入库
	$FD37=#HTH;
	$FD42=getitems('#TMP_AMT');//抵质押总金额
	$FD43=getitems('#TMP_VALUE');//抵质押总价值
	$FD64='70400';//抵质押分录
}"
</COMMSEND>
<COMMRECV>"{
	commrecv_001();
}"
</COMMRECV>
<FIRSTWORK>
"{
	list_init(11,70,8,5);
	list_setcolcnt(5);
	list_setcol(0,'抵质押品编号',20);
	list_setcol(1,'抵质押品名称',60);
	list_setcol(2,'他项金额',17);
	list_setcol(3,'评估值',17);
	list_setcol(4,'抵押物状态',20);
	if(#FROZEN=='1')
	{
		enable(#HTH,false);
	}
}"
</FIRSTWORK>

<VARIABLE>

  <ITEM LINE="3"  COL="3" TYPE="%-60s" FUNCTIONS=
   "T(4542                            抵押物品入库)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=4542)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  <!--输入变量-->
  <ITEM LINE="5"   COL="5" TYPE="%-7s" FUNCTIONS="T(合同号:)"/>
  <ITEM LINE="7"  COL="5" TYPE="%-70s" NAME="#IN_FO" FUNCTIONS="T(------------------------------抵押品信息------------------------------)"/>

  <ITEM NAME="#HTH" 	INPUT="TEXT" 	LINE="5"   COL="12" TYPE="%-20s" 	FUNCTIONS="V(NB)"/>
  <ITEM NAME="#A1" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
  	//showmsg('#HTH=='+#HTH);
  	dim @tota as string;
	dim @line as string;
  	dim @f as file;
  	dim @gaga_id as string;
  	dim @gaga_type as string;
  	dim @tot_amt as string;
	dim @tot_value as string;
	dim @name as string;
	dim @gaga_sts as string;
	dim @sts_name as string;
	dim @filename as string;
	dim @amt1 as number;
	dim @amt2 as number;

	list_clear();

	commsend_001();
	$FD16='4541';
	$FD37=#HTH;
	@tota=callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return(false);
	}
	if($FD67 == '1')// 银承质押存单入库去质押存单做
	{
		open('5614.XML','#ZYNUM='+#HTH+';');
		return (false);
	}
	#S_CPTYPE=delspace($FD65);

	@filename='../tmp/'+$KINBR+$TTYNAME;
	@f=openfile(@filename,'w');
	if(@f &lt; 0)
	{
		showmsg('打开回传文件错误');
		return(false);
	}
	writestr(@f,@tota);
	closefile(@f);
	@f=openfile(@filename,'r');
	if(@f &lt; 0)
	{
		showmsg('打开回传文件错误');
		return(false);
	}

	while(true)
	{
		@line=readline(@f);
		if(@line!='')
		{
			@gaga_id=strfld(@line,'|',0);
			@name=strfld(@line,'|',1);
			@amt1=val(strfld(@line,'|',2));
			@amt2=val(strfld(@line,'|',3));
			@sts_name=strfld(@line,'|',4);
		}else
		{
			break;
		}
		@tot_amt=ltrim(itoa(@amt1,'%17.2f'));  //认定价值
		@tot_value=ltrim(itoa(@amt2,'%17.2f'));//评估价值
		list_additem('',@gaga_id,@name,@tot_amt,@tot_value,@sts_name);
	}
	closefile(@f);
  	list_work();

  	#TMP_AMT = val($FD42,0.01);
  	#TMP_VALUE = val($FD43,0.01);

  	list_show();
  }"
  </ONLOSTFOCUS>
  </ITEM>
  
  <ITEM LINE="19"   COL="5" TYPE="%-13s" FUNCTIONS="T(总他项金额:)"/>
  <ITEM LINE="19"   COL="42" TYPE="%-13s" FUNCTIONS="T(总评估值:)"/>
  <ITEM NAME="#TOT_AMT" 	INPUT="TEXT" 	LINE="19"    COL="19" TYPE="%17.2f"  FUNCTIONS="T()">
  <ONLOSTFOCUS>
  "{
  	dim @totamt as string;
  	dim @tmpamt as string;
  	@totamt = itoa( #TOT_AMT,'%17.2f' );
  	@tmpamt = itoa( #TMP_AMT,'%17.2f' );
	delspace(@totamt);
	delspace(@tmpamt);
  	if(#TOT_AMT != #TMP_AMT)
  	{
  		showmsg('输入总抵押金额与信贷审批金额'+'【'+@tmpamt+'】'+'不符!!');
  		return(false);
  	}
  	if(#TOT_AMT &lt;= 0)
  	{
  		showmsg('抵质押品总金额不能为零!!');
  		return(false);
  	}
  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#TOT_VALUE" 	INPUT="TEXT" 	LINE="19"    COL="56" TYPE="%17.2f" 	FUNCTIONS="T()">
  <ONLOSTFOCUS>
  "{
	dim @tmpvalue as string;
  	@tmpvalue = itoa( #TMP_VALUE,'%17.2f' );
  	if(#TOT_VALUE != #TMP_VALUE)
  	{
  		showmsg('输入总评估值与信贷审批值'+'【'+@tmpvalue+'】'+'不符!!');
  		return(false);
  	}
  	if(#TOT_VALUE &lt; #TOT_AMT)
  	{
  		showmsg('抵质押总评估值不能小于他项总金额！！');
  		return(false);
  	}
  }"
  </ONLOSTFOCUS>
  </ITEM>


  <ITEM NAME="#TMP_AMT" TYPE="%17.2f" FUNCTIONS=""/>
  <ITEM NAME="#TMP_VALUE" TYPE="%17.2f" FUNCTIONS=""/>
  <ITEM NAME="#S_CPTYPE" TYPE="%-8s" FUNCTIONS=""/>
  <ITEM NAME="#PASSWD"  TYPE="%-6s" />
  <ITEM NAME="#FROZEN"  TYPE="%-1s"/>

  <ITEM LINE="21" COL="59" NAME="#OKEXIT" TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="SCREEN" LINESPACE="38" DESC="显示内容">
NOTHING
</PACKAGE>
<PRINT>"{
print(7,27,'    ★操作成功★ ');
}"
</PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="PRINTER" DESC="打印业务专用凭证">
NOTHING
</PACKAGE>
<PRINT>
"{
	$KINDNO = '00';
	dim @txtime  as string;
	dim @f as file;
	dim @line as string;
  	dim @gaga_id as string;
  	dim @gaga_type as string;
	dim @name as string;
	dim @filename as string;
	dim @amt1 as string;
	dim @amt2 as string;
	dim @sts_name as string;
	@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
	@filename='../tmp/'+$KINBR+$TTYNAME;
	print( 4,12,'机构名称:[30]',$BRNAME);
	print( 4, 5,'交易代码:4542');
	print( 4, 5,'交易:抵质押物品入库');
	print( 5,12,'合 同 号:[20]',#HTH);
	print( 6,12,'他项总金额:[17]评估总价值:[17]',ltrim(comma(itoa(#TOT_AMT,'%17.2f'))),ltrim(comma(itoa(#TOT_VALUE,'%17.2f'))));
	

	@f=openfile(@filename,'r');
	if(@f &lt; 0)
	{
		showmsg('打开回传文件错误');
		return(false);
	}

	while(true)
	{
		@line=readline(@f);
		if(@line!='')
		{
			@gaga_id=strfld(@line,'|',0);
			@name=strfld(@line,'|',1);
			@amt1=val(strfld(@line,'|',2));
			@amt2=val(strfld(@line,'|',3));
			@sts_name=strfld(@line,'|',4);
		}else
		{
			break;
		}
		print(lineno()+1,12,'描述:[60]',@name);
		print(lineno()+1,12,'编号:([17])    他项金额:[17] 价值:[17]',@gaga_id,itoa(@amt1,'%17.2f'),itoa(@amt2,'%17.2f'),'%.2f'));
	}
	closefile(@f);
	printacdtl_1();
        print( 24,20,'备注:')
        print( 24,27,'交易日期:[8] [8]',$HDATE,@txtime);
        print( 24,5,'柜员:[4]',$FD7);
        print( 24,5,'流水号:[6]',$FD4);


}"
</PRINT>
</RESPONSE>
</TRANSACTION>

