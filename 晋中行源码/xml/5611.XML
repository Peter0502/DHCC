<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11110000" TITLE="5611 保证金取款"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{

    $TXNO='9986';
    $MSGTYPE='03001';
    $FD12 = '4373'; 
    $FD31 = #RATEACCT;
    $FD32 = #SAFEMONEYACCT;
    $FD33 = #PROTOCOL;
    $FD67 = #RATE;
    $FD68 = #SAFEMONEYTYPE;
    $FD39 =itoa(#MONEY*100,'%016.0f');
    commsend_001();
    callserver();
    if($FD12!='0000'){
        showmsg(geterror());
        return(false);
    }
    $FD16 = '4373';
    $MSGTYPE='03001';

}"
</COMMSEND>
<COMMRECV>"{
	commrecv_001();
}"
</COMMRECV>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-50s" FUNCTIONS=
    "T(5611                        保证金取款)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=4373)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>

  
  <!--输入变量-->
  <ITEM LINE="6" COL="12"  TYPE="%-12s" FUNCTIONS="T(保证金类型:)"/>
  <ITEM LINE="7" COL="12"  TYPE="%-15s" FUNCTIONS="T(是否已参与保证:)"/>
  <ITEM LINE="10" COL="12" TYPE="%-14s" FUNCTIONS="T(保证金帐号:)"/>
  <ITEM LINE="12" COL="12" TYPE="%-14s" FUNCTIONS="T(转存/收息帐号:)"/>
  <ITEM LINE="14" COL="12" TYPE="%-14s" FUNCTIONS="T(金       额:)"/>
  <ITEM LINE="16" COL="12" TYPE="%-14s" FUNCTIONS="T(是 否 计 息:!)"/>
  <ITEM NAME="#BZJXY" TYPE="%-20s"/>
  <ITEM NAME="#BZJJE" TYPE="%-17.2f"/>
  <ITEM NAME="#B_AC_NO" TYPE="%27s"/>
  <!--add by gong 20110901 晋中商行-->
  <ITEM NAME="#SAFEMONEYTYPE" INPUT="SELECT" LINE="6" COL="27" TYPE="%-1s" FUNCTIONS="T(Q)J(#TYPENAME)">
  <SELECT>
		<OPTION VALUE="Q" TITLE="请选择"/>
		<OPTION VALUE="1" TITLE="承兑保证金"/>
		<OPTION VALUE="2" TITLE="担保保证金"/>
  </SELECT>
	<ONLOSTFOCUS>
	"{
		if(#SAFEMONEYTYPE=='2') {
			show(#PROTOCOL,true);
			show(#LBZJXY,false);
			show(#DKHHT,true);
   		}else{
			show(#PROTOCOL,true);
			show(#DKHHT,false);
			show(#LBZJXY,true);
   		}
	 }"
	</ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#ZQTYPE" INPUT="SELECT" LINE="7" COL="27" TYPE="%-6s" FUNCTIONS="T(Q)">
  <SELECT>
		<OPTION VALUE="Q" TITLE="请选择"/>
		<OPTION VALUE="1" TITLE="否"/>
		<OPTION VALUE="2" TITLE="是"/>
  </SELECT>
	<ONLOSTFOCUS>
	"{
		if(#ZQTYPE =='Q')
		{
			showmsg('请选择一项');
			return(false);
		}
		else if(#ZQTYPE =='2')
		{
			#BZJXY='';	
			show(#LBZJXY,false);
			show(#DKHHT,false);
			show(#PROTOCOL,false);
			enable(#PROTOCOL,false);
			#RATE='N';
			enable(#RATE,false);
		}
	 }"
	</ONLOSTFOCUS>
  </ITEM>
  <ITEM  NAME="#TYPENAME" TYPE="%-10s" FUNCTIONS="j(#SAFEMONEYTYPE=1,T{承兑保证金})j(#SAFEMONEYTYPE=2,T{担保保证金})"/>

  <ITEM LINE="8"  COL="12" TYPE="%-14s" NAME="#LBZJXY" INPUT="LABEL"   FUNCTIONS="T(承兑协议编号:)"/>
  <ITEM LINE="8"  COL="12" TYPE="%-14s" NAME="#DKHHT" INPUT="LABEL"   FUNCTIONS="T(贷款合同编号:)"/>
  <ITEM NAME="#PROTOCOL" INPUT="TEXT"  LINE="8" COL="27" TYPE="%-20s" FUNCTIONS="V()">
  	
  	<!--modify by gong 20110901
  	<ONLOSTFOCUS>"{
  		if(delspace(#PROTOCOL) != delspace(#BZJXY)){
  		  showmsg('保证金协议号与审批不一致');
  		  return(false);
  		}
  	}"
  	</ONLOSTFOCUS>
  		end by gong 20110902-->
  	<ONLOSTFOCUS>
  	"{
			dim @tota as string;
			dim @rate as string;
			dim @money as string;
			// begin add by chenchao 2011-8-7 15:49:13 增加审批控制 
			initfd();
			commsend_001();
			$TXNO='9598';
			$FD16='9598';
			$FD123 = 'select pay_ac_no,amt from ln_auth where type='+chr(39)+'13'+chr(39)+' and sts='+chr(39)+'X'+chr(39)+' and pact_no='+chr(39)+#PROTOCOL+chr(39)+'';
			commsend_001();
			@tota = callserver();
			if($FD12!='0000')
			{
				showmsg(geterror());
				return(false);
			}
			if(@tota!='')
			{
				#B_AC_NO = strfld(@tota,'|',0);
				@money = strfld(@tota,'|',1);
				#BZJJE=val(@money);
			}else{
				showmsg('该编号未通过信贷审批！');
				return(false);
			}
			// end add by chenchao 2011-8-7 15:49:13 增加审批控制
  	}"
  	</ONLOSTFOCUS>
  </ITEM>
  <!--end by gong 20110901 晋中商行-->

  <ITEM NAME="#SAFEMONEYACCT" INPUT="TEXT" LINE="10" COL="27" TYPE="%-20s" FUNCTIONS="V(NB)"> 
    	<ONLOSTFOCUS>"{
		if(delspace(#B_AC_NO)!=delspace(#SAFEMONEYACCT) and len(delspace(#PROTOCOL))>0)
		{
			showmsg('保证金账号与审批不一致');
			return(false);
  		}
  		
		dim @tota as string;
		dim @rate as string;
		dim @money as string;
		
		initfd();
		commsend_001();
		$TXNO='9598';
		$FD16='9598';
		$FD123 = 'select amt from ln_auth where type='+chr(39)+'13'+chr(39)+' and sts='+chr(39)+'X'+chr(39)+' and (pact_no is null or pact_no = '+chr(39)+''+chr(39)+') and pay_ac_no='+chr(39)+#SAFEMONEYACCT+chr(39)+'';
		commsend_001();
		@tota = callserver();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return(false);
		}
		if(@tota!='')
		{
			@money = strfld(@tota,'|',0);
			#BZJJE=val(@money);
		}else{
			showmsg('该编号未通过信贷审批！');
			return(false);
		}
  	}"
  	</ONLOSTFOCUS>
  </ITEM>
  
  <ITEM NAME="#RATEACCT" INPUT="TEXT" LINE="12" COL="27" TYPE="%-20s" FUNCTIONS="T()V(NB)"/>
  
  <ITEM NAME="#MONEY" INPUT="TEXT" LINE="14" COL="27" TYPE="%17.2f" FUNCTIONS="J(#XMONEY)">
  	<ONLOSTFOCUS>"{
  		if(len(delspace(#PROTOCOL))>0){
			if(#MONEY !=#BZJJE){
				showmsg('保证金金额与审批不一致');
				return(false);
			}
  		}
  	}"
  	</ONLOSTFOCUS>
  </ITEM>
  
  <ITEM NAME="#XMONEY" TYPE="%-16s" FUNCTIONS="X(#MONEY)"/>
  <ITEM NAME="#RATE" INPUT="SELECT" LINE="16" COL="27" TYPE="%-1s" FUNCTIONS="V(NB)T(Q)">
  <SELECT>
		<OPTION VALUE="Q" TITLE="请选择"/>
		<OPTION VALUE="N" TITLE="否"/>
		<OPTION VALUE="Y" TITLE="是"/>
  </SELECT>
  </ITEM>
  <ITEM NAME="#RATENAME" TYPE="%4s" FUNCTIONS="S(#RATE,#RATE)"/>
   
  <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
  <ITEM NAME="#PASSWD" TYPE="%-6s" FUNCTIONS="T()"/>
  <ITEM NAME="#YEAR"  TYPE="%-4s" FUNCTIONS="T($FD5,1,4)"/>
  <ITEM NAME="#MON"  TYPE="%-2s" FUNCTIONS="T($FD5,5,2)"/>
  <ITEM NAME="#DAY"  TYPE="%-2s" FUNCTIONS="T($FD5,7,2)"/>

  <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>

</VARIABLE>
<REQUEST>
</REQUEST>

<RESPONSE>
    <PACKAGE DEVICE="SCREEN"  LINESPACE="38" DESC="显示内容">
    QKPT|@acno|@name
    </PACKAGE>
    <PRINT>"{
    	  if(#BZJXY!='')
    	  {
        print( 8, 26,'承兑协议编号: [20]',#PROTOCOL);
        }
        print(10, 26,'保 证 金帐号: [20]',#SAFEMONEYACCT);
        print(11, 26,'转存/收息帐号:[20]',#RATEACCT);
        print(12, 26,'金       额:  [16]',#XMONEY);
        print(13, 26,'计息标志:     [4]',#RATENAME);
        $FD82 = @name;
    }"
    </PRINT>
</RESPONSE>

<RESPONSE>
    <PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证">
        CKPT|@acno|@name
    </PACKAGE>
    <PRINT>"{
 $KINDNO='00';
 dim @txtime  as string;
@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
	print( 5,20,'机构名称:[30]',$BRNAME);  
	print( 5,2,'代码:5611');
	print( 5,13,'交易:保证金取款');
  if(#BZJXY!='')
  {
  print( 8,26,'承兑协议编号: [20]',#PROTOCOL);
  }
	print(08,20,'保 证 金 帐号: [20]',#SAFEMONEYACCT);
	print(09,20,'保 证 金 户名: [50]',$FD82);
	print(10,20,'转存/收息帐号: [20]',#RATEACCT);
	print(11,20,'转存/收息户名: [20]',@name);
	print(12,20,'金         额: [16]',#XMONEY);
	print(13,20,'计 息   标 志: [4]',#RATENAME);
	
	print(24,20,'备注:');
	print(24,27,'交易日期:[8] [8]',$HDATE,@txtime);
	print(24,5,'柜员:[4]',$FD7);
	print(24,5,'流水号:[6]',$FD4);
    }"
    </PRINT>
</RESPONSE>
<RESPONSE>
 <PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证">
    NOTHING
 </PACKAGE>
 <PRINT>
  "{
 $KINDNO='00';
 dim @txtime  as string;
@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
	print( 5,20,'机构名称:[30]',$BRNAME);  
	print( 5,2,'代码:5611');
	print( 5,13,'交易:保证金取款');

	printacdtl_1();  
	print(24,20,'备注:');
	print(24,27,'交易日期:[8] [8]',$HDATE,@txtime);
	print(24,5,'柜员:[4]',$FD7);
	print(24,5,'流水号:[6]',$FD4);
}"
 </PRINT>
</RESPONSE>
</TRANSACTION>
