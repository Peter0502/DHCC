<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111" TITLE="3712    IC卡销卡申请"
  xmlns="http://www.org.otd/MENU"  xmlns:W3CNS="http://www.w3c.org">
  <VARIABLE>
    <ITEM LINE="3" COL="3" TYPE="%-44s" FUNCTIONS=
    "T(3712                           IC卡销卡申请)"/>
    <ITEM LINE="4" COL="3" TYPE="%-74s" FUNCTIONS=
    "T(─────────────────────────────────────)"/>
    <ITEM NAME="#TXNO"       TYPE="%-4s"   FUNCTIONS="T($TXNO=7118)"/>
    <ITEM NAME="#MSGTYPE"    TYPE="%-5s"   FUNCTIONS="T($MSGTYPE=03001)"/>
    <ITEM NAME="#TXCD"       TYPE="%4s"    FUNCTIONS="T(7118)"/>      
    <ITEM NAME="#TXNAME"     TYPE="%-14s"  FUNCTIONS="T(IC卡销卡申请)"/> 
    <ITEM NAME="#HM"         TYPE="%-20s"  FUNCTIONS=""/> 
    <ITEM NAME="#LX"         TYPE="%-1s"   FUNCTIONS=""/>
    <ITEM NAME="#MSR2BAK"    TYPE="%-37s"  FUNCTIONS=""/>
    <ITEM NAME="#MSR3BAK"    TYPE="%-104s" FUNCTIONS=""/>
    <ITEM NAME="#ICJSQ"      TYPE="%-4s"   FUNCTIONS=""/><!--应用交易计数器-->
    <ITEM NAME="#ICMW"       TYPE="%-20s"  FUNCTIONS=""/><!--应用交易密文--> 
    <ITEM NAME="#ORIG_SEQNO" TYPE="%-16s"  FUNCTIONS=""/> 
    <ITEM NAME="#RESP_CODE"  TYPE="%-6s"   FUNCTIONS=""/>    
    <ITEM LINE="6" COL="9"   TYPE="%-10s"  FUNCTIONS="T( IC 卡 号:)"/>
    <ITEM LINE="8" COL="9"   TYPE="%-12s"  FUNCTIONS="T(【产品信息】)"/>
    <ITEM LINE="9" COL="5"   TYPE="%70s"   FUNCTIONS=
    "T(----------------------------------------------------------------------)"/>  
    <ITEM LINE="6" COL="19"  TYPE="%-19s"  NAME="#CARDNO"  INPUT="TEXT" DEVICE="ICC" FUNCTIONS="V(NB)M($MSR2,1)">
      <ONLOSTFOCUS>
       "{
        dim @baktxno as string;
        dim @tagvalue as string;    
        @baktxno=$TXNO;
        if(substr(#CARDNO,0,6)!='621780')
        {
          showmsg('不是IC卡，不能用此交易做销卡申请!');
          return(false);
        } 
        @tagvalue= ictagvalue('9f79');
        showmsg(@tagvalue);
        if(strfld(@tagvalue,'|',0)!='9000')
        {
        	showmsg('函数ictagvalue的返回值有误!');
        	return(false);
        }       
        showmsg(strfld(@tagvalue,'|',0));
        #ICLAVBAL=strfld(@tagvalue,'|',1);
        showmsg('电子现金#ICLAVBAL='+delspace(#ICLAVBAL));
        #ICAVBAL=val(#ICLAVBAL,0.01);
        #MSR2BAK=$MSR2;
        showmsg('#MSR2BAK='+#MSR2BAK);
        #MSR3BAK=$MSR3;
        showmsg('#MSR3BAK='+#MSR3BAK);
        $MSR2='';
        $MSR3='';
        initfd();
        @baktxno=$TXNO;
        commsend_001();
        $FD30=#CARDNO;
        $FD16='9961'; //输入卡号，回显证件信息
        callserver();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }
        $TXNO=@baktxno;
        showmsg('证件类型'+$FD67);
        showmsg('证件号码'+$FD62);
        showmsg($FD25);
        #NAME=delspace($FD25);
        #ZJLX=delspace($FD67);
        #LX=delspace($FD67);
        #HM=delspace($FD62);
        show(#NAME,true);
  
        @baktxno=$TXNO;
        initfd();
        commsend_001();
        $FD16='9951'; //根据帐号回显账户序号及信息[储蓄存款交易]
        $FD101=#CARDNO;
        callserver();
        if($FD12!='0000')
        {
          showmsg(geterror());
          return(false);
        }
        $TXNO=@baktxno;
        #AVBAL=val(substr($FD101,134,16),0.01);
        enable(#NAME,false);
        //enable(#ZJLX,false);
        showblock('BOX',true,true);   
        }"
      </ONLOSTFOCUS>
    </ITEM>
    <BLOCK  LINE="0" COL="0"   NAME="BOX"    VISABLE="FALSE">
      <ITEM LINE="11" COL="9"  TYPE="%-10s"  NAME="#KHM"     FUNCTIONS="T(客户名称:)"/>
      <ITEM LINE="12" COL="9"  TYPE="%-10s"  NAME="#YE"      FUNCTIONS="T(卡 余 额:)"/>
      <ITEM LINE="14" COL="9"  TYPE="%-14s"  NAME="#DZXJ"    FUNCTIONS="T(电子现金余额:)"/>
      <ITEM LINE="15" COL="9"  TYPE="%-10s"  NAME="#KLX"     FUNCTIONS="T(证件类型:!)"/>
      <ITEM LINE="16" COL="9"  TYPE="%-10s"  NAME="#ZJH"     FUNCTIONS="T(证件号码:)"/>
      <ITEM LINE="18" COL="9"  TYPE="%-10s"                  FUNCTIONS="T(密    码:)"/>
      <ITEM LINE="19" COL="9"  TYPE="%-10s"  NAME="#YY"      FUNCTIONS="T(申请原因:)"/>       
      <ITEM LINE="11" COL="19" TYPE="%-30s"  NAME="#NAME"    FUNCTIONS=""/>
      <ITEM LINE="12" COL="19" TYPE="%-16s"  NAME="#LAVBAL"  FUNCTIONS="X(#AVBAL)"/>
      <ITEM                    TYPE="%17.2f" NAME="#AVBAL"   FUNCTIONS="J(#LAVBAL)"/>
      <ITEM LINE="14" COL="23" TYPE="%17.2f" NAME="#ICAVBAL" FUNCTIONS=""/>
      <ITEM                    TYPE="%17s"  NAME="#ICLAVBAL" FUNCTIONS=""/>
      <!--ITEM LINE="14" COL="23" TYPE="%-16s" NAME="#ICLAVBAL" FUNCTIONS="X(#ICAVBAL)"/>
      <ITEM NAME="#ICAVBAL" TYPE="%17.2f" FUNCTIONS="J(#ICLAVBAL)"/-->
      <ITEM LINE="15" COL="19" TYPE="%-1s"   NAME="#ZJLX"    FUNCTIONS="" INPUT="TEXT">
        <SELECT>
          <OPTION VALUE="1" TITLE="0.身份证      " />
          <OPTION VALUE="2" TITLE="1.户口簿      " />
          <OPTION VALUE="3" TITLE="2.护照        " />
          <OPTION VALUE="4" TITLE="3.军官证      " />
          <OPTION VALUE="5" TITLE="4.回乡证      " />
          <OPTION VALUE="8" TITLE="7.企业代码证  " />
          <OPTION VALUE="9" TITLE="8.组织机构号  " />
          <OPTION VALUE="A" TITLE="9.营业执照    " />
          <OPTION VALUE="B" TITLE="a.经营许可证  " />
          <OPTION VALUE="C" TITLE="b.事业法人证书" />
          <OPTION VALUE="G" TITLE="g.警官证" />
        </SELECT>
        <ONLOSTFOCUS>
         "{
          if(#ZJLX!=#LX)
          {
            showmsg('证件类型不符!');
            return(false);
          }
         }"
        </ONLOSTFOCUS>
      </ITEM> 
      <ITEM LINE="16" COL="19" TYPE="%-20s" NAME="#ZJHM"   INPUT="TEXT" FUNCTIONS="">
        <ONLOSTFOCUS>
         "{
          if(#ZJHM!=#HM)
          {
            showmsg('证件号码不符!');
            return(false);
          } 
         }"
        </ONLOSTFOCUS>
      </ITEM>
      <ITEM LINE="18" COL="19" TYPE="%-6s" NAME="#PASSWORD" INPUT="TEXT" DEVICE="PINPAD" FUNCTIONS="V(NB)i()">
        <ONLOSTFOCUS>
         "{ 
          dim  @txname as string;
          if(substr(#CARDNO,0,6) == '621780')
          {
            @txname=$TXNO;
            initfd();
            commsend_001();
            $FD16='7007';
            $FD30=#CARDNO;
            $FD68='4';   //#OPTION ='04'
            $FD79=#PASSWORD;
            callagn();
            if( $FD12 != '0000')
            {
              showmsg(geterror());
              return(false);
            }
            $TXNO=@txname;
          }
         }"
        </ONLOSTFOCUS>
      </ITEM> 
      <ITEM LINE="19" COL="19" TYPE="%-50s" NAME="#SQYY" INPUT="TEXT" FUNCTIONS="V(NB)"/>
    </BLOCK>
    <ITEM LINE="21"  COL="59"  TYPE="%-10s" INPUT="BUTTON" FUNCTIONS="T(确   定)">
      <ONCLICK>
       "{
        dim @tx as string;
        dim @update as string;
        dim @shuju as string;
        dim @shuju1 as string;
        dim @cb as string;
        dim @kahao as string;
        dim @tagvalue1 as string;
        initfd();
        @tx=$TXNO;
        commsend_001();
        $FD16='7118';
        $FD30=#CARDNO;
        $FD79=#PASSWORD;
        $FD75=#MSR2BAK;
        $FD76=#MSR3BAK;
        $FD25=#NAME;
        $FD67=#ZJLX;
        $FD62=#ZJHM;
        $FD95=#SQYY;
        $FD39=itoa(val(#LAVBAL,100),'%016.2f');  // 交易金额
        @shuju1=ictagvalue('9f79');
        showmsg('ictagvalue'+@shuju1);
        if(strfld(@shuju1,'|',0)!='9000')
        {
        	showmsg('函数ictagvalue的返回值有误!');        	
        	return(false);
        }
        @shuju=initiccard();
        showmsg('initiccard'+@shuju);
        if(strfld(@shuju,'|',0)!='9000')
        {
        	showmsg('函数initiccard的返回值有误!');        	
        	return(false);
        }
        @kahao=strfld(@shuju,'|',1); 
               if(@kahao!=#CARDNO)
        {
        	showmsg('卡号不正确!');
        	return(false);
        }
        #ICJSQ=strfld(@shuju,'|',2); 
        #ICMW=strfld(@shuju,'|',3); 
        showmsg('kahao='+@kahao);
        showmsg('应用JSQ='+#ICJSQ);       
        showmsg('应用密文#ICMW='+#ICMW);
        $FD36=#ICJSQ;
        $FD59=#ICMW;
        @cb=chkiccard();
        if(@cb!='0000')
        {
          showmsg('往神码发交易前，不允许拔卡!');
          //goitem('#CARDNO');
          return(false);
        }
        callagn();
        if($FD12!='0000')
        {
          showmsg(geterror());
          powerdownic();
          return(false);
        }
        @update=updateiccard('04DA9F790a0000000850006F94ABF1,04DC010C42703C9F61123635333132323139383630373135343431349F62010057136217800109002658D30122200004400284000F5F200848414E204348414F9F1F00260D27E7');
        #ORIG_SEQNO=delspace(itoa(val($FD43),'%16d'));
        #RESP_CODE=$FD12;
        if(@update!='0000')
        {
          showmsg('报错...?');
          #RESP_CODE=$FD12;
          showmsg(geterror());
          initfd();
          commsend_001();
          $FD16='7777';
          $FD12=#RESP_CODE;
          $FD30=#ACTNO;
          $FD39=itoa(#TXAMT*100);
          $FD43=#CARD_TRACENO;
          callagn();
          if($FD12!='0000')
          {
            showmsg(geterror());
            return (false);
          }
          showmsg('卡销户失败!!...');
          rerun();
        }
        $TXNO=@tx;
        //#ORIG_SEQNO=delspace(itoa(val($FD43),'%16d'));
        //#RESP_CODE=$FD12;
        //FD
        //FD
        //FD
        //FD
        //FD
        //FD
        //往银联发送交易处理结果通知
        //initfd();
        //commsend_001();
        //$FD16='7767';
        //$FD43=#ORIG_SEQNO;                       //原交易流水
        //$FD21='01';                              //币种
        //$FD39=itoa(val(#LAVBAL,100),'%016.2f');  //交易金额
        //$FD12=#RESP_CODE;                        //响应码
        //callagn();
        //if($FD12!='0000')
        //{
        //  showmsg(geterror());
        //  return(false);
        //}
        showmsg('IC卡销户申请成功!');
       }"
      </ONCLICK>
    </ITEM>
  </VARIABLE>
  <REQUEST>
  </REQUEST>
  <RESPONSE>
    <PACKAGE DEVICE="SCREEN" DESC="IC卡销户申请">
      NOTHING
    </PACKAGE>
    <PRINT>
     "{
     }"
    </PRINT>
  </RESPONSE>
  <RESPONSE>
    <PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(IC卡销户申请)">
      NOTHING
    </PACKAGE>
    <PRINT>
     "{
     }"
    </PRINT>
  </RESPONSE>
</TRANSACTION> 


