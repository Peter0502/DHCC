<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111001" TITLE="2301 客户证件信息维护"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
	//开始与管理平台通信
	//initfd();
	//commsend_001();
	//$FD16='1001';
	//$FD24='mis';
	//$FD28=#KHH;
	//$FD67=#ZJLX;
	//$FD62=#ZJHM;
	//$FD69=#BZJLX;
	//$FD63=#XZJHM;
	//callagn();
	//if($FD12!='0000')
	//{
		//showmsg(geterror());
		//return(false);
	//}
	//initfd();
	//与管理平台通信结束
	//与神码通讯开始
	initfd();
	commsend_001();
	$FD16='7015';
	$FD28=#KHH;
	if(#CZLX=='0')
	{
	$FD67=#ZJLX;
	$FD62=#ZJHM;
	}
	else
	{
	$FD67=#BZJLX;
	$FD62=#XZJHM;
	}
	callagn();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return(false);
	}
	//showmsg('与神码通讯成功结束');
	initfd();
	//与神码通讯结束
	commsend_001();
	$FD28=#KHH;
	$FD72=#KHLX;
	$FD68=#ZJLX;
	$FD62=#ZJHM;
	$FD67=#CZLX;
	$FD69=#BZJLX;
	$FD63=#XZJHM;
	$FD22=#HCJG;
}"
</COMMSEND>
<COMMRECV>"{
		commrecv_001();
		
}"
</COMMRECV>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(2301                        客户证件信息维护)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=1302)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  
  <!--输入变量-->
  <ITEM LINE="6" COL="12" TYPE="%-9s" FUNCTIONS="T(操作类型:)"/>
  <ITEM NAME="#CZLX" INPUT="SELECT" LINE="6" COL="22" TYPE="%-1s" FUNCTIONS="T(1)">
  <SELECT>
		<!--<OPTION VALUE="0" TITLE="增加"/>-->
		<OPTION VALUE="1" TITLE="修改"/>
	</SELECT>
	<ONLOSTFOCUS>
	"{
		if(#CZLX=='1') {
		   show(#LXZJLX,true);
		   show(#BZJLX,true);
		   show(#LXZJHM,true);
		   show(#XZJHM,true);
   		}
		else
		{
		   show(#LXZJLX,false);
		   show(#BZJLX,false);
		   show(#LXZJHM,false);
		   show(#XZJHM,false);
		}
	 }"
	</ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#SCZLX"     TYPE="%-4s"  FUNCTIONS="S(#CZLX,#CZLX)"/>
  
  <ITEM LINE="8"  COL="3" TYPE="%-74s" FUNCTIONS=
   "T(--------------------------------------------------------------------------)"/>
  <ITEM LINE="10" COL="8" TYPE="%-9s" FUNCTIONS="T(客 户 号:)"/>
  <ITEM LINE="11" COL="8" TYPE="%-9s" FUNCTIONS="T(客 户 名:)"/>
  <ITEM LINE="12" COL="8" TYPE="%-9s" FUNCTIONS="T(客户类型!)"/>
  <ITEM LINE="14" COL="8" TYPE="%-9s" FUNCTIONS="T(证件类型!)"/>
  <ITEM LINE="16" COL="8" TYPE="%-9s" FUNCTIONS="T(证件号码:)"/>
  <ITEM NAME="#KHH" INPUT="TEXT" LINE="10" COL="18" TYPE="%-8s" FUNCTIONS="V(NB)">
  <ONLOSTFOCUS>
 "{	initfd();	
    commsend_001();
 		$FD16='9755';
		$FD28=#KHH;
		$FD67=#CZLX;
		callserver();
		if($FD12!='0000'){
			showmsg(geterror());
			return(false);
		}
		if($FD71=='2'){
			showmsg('此客户状态为注销，不能维护！');
			return(false);
		}
		#KHLX=delspace($FD72);
		show(#KHLX,true);
	dim @txno_bak as string;
	dim @tota as string;
	@txno_bak=$TXNO;
	$TXNO='9755';
	commsend_001();
	@tota=callserver();	
	$TXNO=@txno_bak;
	#KHM=$FD26;
	setsel(#ZJLX,@tota,'o5t20o1v1o2'); 
        setsel(#BZJLX,@tota,'o5t20o1v1o2');
	show(#ZJLX,true);
	show(#KHM,true);
	
 }"
 </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#KHM"  ENABLE="FALSE" INPUT="TEXT" LINE="11" COL="18" TYPE="%-60s" FUNCTIONS="V(NB)"/>
  <ITEM NAME="#KHLX" ENABLE="FALSE" LINE="12" COL="18" TYPE="%-1s" FUNCTIONS="">
  <SELECT>
		<OPTION VALUE="1" TITLE="个人"/>
		<OPTION VALUE="2" TITLE="公司"/>
		<OPTION VALUE="3" TITLE="机构"/>
		<OPTION VALUE="4" TITLE="同业"/>
	</SELECT>
  </ITEM>
  <ITEM NAME="#SKHLX" TYPE="%-4s"   FUNCTIONS="S(#KHLX,#KHLX)"/>

  <ITEM NAME="#ZJLX" INPUT="SELECT" LINE="14" COL="18" TYPE="%-1s" FUNCTIONS="V(NB)">
	<ONLOSTFOCUS>
 "{	
 		initfd();	
    commsend_001();
 		$FD16='9756';
		$FD68=#ZJLX;
		$FD28=#KHH;
		$FD67=#CZLX;
		callserver();
		if($FD12!='0000'){
			showmsg(geterror());
			return(false);
		}
		#ZJHM=delspace($FD62);
		if(#CZLX == '0')
		{
			show(#ZJHM,true);
			enable(#ZJHM,true);
		}
		else
		{
			show(#ZJHM,true);
			enable(#ZJHM,false);
		}
}"
 </ONLOSTFOCUS>
 </ITEM>
 <ITEM NAME="#SZJLX" TYPE="%-12s"   FUNCTIONS="S(#ZJLX,#ZJLX)"/>
<!--新增对若是增加证件操作的话判断输入的号码条件代码 -->
<ITEM NAME="#ZJHM" INPUT="TEXT" LINE="16" COL="18" DEVICE="KEYBOARD"  TYPE="%-20s" FUNCTIONS="V(NB)">
	<ONLOSTFOCUS>
 "{
		dim @ll as number;
		@ll = len(#ZJHM);
		if(#CZLX == '0' and #ZJLX == '1')
		{
			if(@ll != 15 and  @ll != 18))
			{
					showmsg('身份证号码位数错误');
        	return(false);
			}
		}
	}"
 </ONLOSTFOCUS>
 </ITEM>
 
<ITEM LINE="14" COL="42" NAME="#LXZJLX" INPUT="LABEL" VISABLE="FALSE" TYPE="%-11s" FUNCTIONS="T(新证件类型!)"/>
  <ITEM NAME="#BZJLX" INPUT="SELECT" VISABLE="FALSE" LINE="14" COL="53" TYPE="%-1s" FUNCTIONS="V(NB)"/>
  <ITEM NAME="#SBZJLX" TYPE="%-12s"   FUNCTIONS="S(#BZJLX,#BZJLX)"/>

  <ITEM LINE="16" COL="42" NAME="#LXZJHM" INPUT="LABEL" VISABLE="FALSE" TYPE="%-11s" FUNCTIONS="T(新证件号码:)"/>
<!------add by 程功勋 增加对新证件的检验 begin--->
<!----  <ITEM NAME="#XZJHM" INPUT="TEXT" VISABLE="FALSE" LINE="16" COL="53" TYPE="%-20s" FUNCTIONS="V(NB)">--->
<!------add by wudawei 20131014 核查结果 begin--->
	<ITEM NAME="#HCJG"  TYPE="%-2s" />
	<!-- 为核查结果中文传值的变量 wudawei 20131101 -->
  <ITEM NAME="#HCJGBL"  TYPE="%-60s" />
  <ITEM NAME="#XZJHM" LINE="16" COL="53" TYPE="%-20s" DEVICE="KEYBOARD" FUNCTIONS="I()">
    <ONLOSTFOCUS>
	"{
		dim @l as number;
		dim @res as string;
		@l = len(#XZJHM);
		if('1' == #BZJLX or '2' == #BZJLX){
    		if(@l == 15 or  @l == 18)
        {
                    if(#KHLX=='1')
                    {                     
                    //第四参数的意思是不去自动登记身份核查结果  交易1321 
                    	//showmsg('#XZJHM='+ #XZJHM+',#KHM='+#KHM+',#KHH='+#KHH);                     
                     @res=idcheck(#XZJHM,#KHM,#KHH,'N');
                     showmsg(' @res='+ @res);
                     #HCJGBL = strfld(@res,'|',1);
										 #HCJG = strfld(@res,'|',0);
                     if(#HCJG == '02' or #HCJG == '03' or #HCJG == '04' or #HCJG == '05' or #HCJG == '06')                
                     {
                      showmsg('核查结果不通过,不能继续交易！');
                      return(false);
                     }
                    }
				}else{
	  		showmsg('身份证号码位数错误');
        return(false);
			}
    	}
	//检查是否该证件已经登记

		dim @txno_bak as string;
		dim @tota as string;
		@txno_bak=$TXNO;
		$TXNO='9797';
		$FD62=#XZJHM;
		$FD68=#BZJLX;
		commsend_001();
		$TXNO=@txno_bak;
		@tota=callserver();	
		if($FD12!='0000'){
			showmsg(geterror());
			return(false);
		}
	}"
	</ONLOSTFOCUS>
</ITEM>
<!----add by 程功勋 增加对新证件的检验 end --------------->
   
  <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
  <ITEM NAME="#PASSWD" TYPE="%-6s" FUNCTIONS="T()"/>
  <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT"/>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="PRINTER" DESC="请打印业务专用凭证">
NOTHING
</PACKAGE>
	<PRINT>
	"{
               $KINDNO='00';
               dim @txtime  as string;
               @txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
               print( 5, 20,'机构名称:[30]',$BRNAME);
               print( 5, 2,'代码:2301');
               print( 5, 13,'交易:客户证件信息维护');
               if(#CZLX == '0')
	       {
			print( 8, 20,'客户证件信息[ 4]',#SCZLX);
			print( 9, 20,'客 户 号: [ 8]',#KHH);
			print( 10,20,'客 户 名: [60]',#KHM);
			print( 11,20,'客户类型: [ 4]',#SKHLX);
			print( 12,20,'证件类型: [12]',#SZJLX);
			print( 13,20,'证件号码: [20]',#ZJHM);
			print( 14,20,'身份核查结果:[60] ',#HCJGBL);
                        print( 24,20,'备注:')
                        print( 24,27,'交易日期:[8] [8]',$HDATE,@txtime);
                        print( 24,5,'柜员:[4]',$FD7);
                        print( 24,5,'流水号:[6]',$FD4);
		}
		else
		{
			print( 8, 20,'客户证件信息[ 4]',#SCZLX);
			print( 9, 20,'客  户  号: [ 8]',#KHH);
			print( 10,20,'客  户  名: [60]',#KHM);
			print( 11,20,'客户  类型: [ 4]',#SKHLX);
			print( 12,20,'证件  类型: [12]',#SZJLX);
			print( 13,20,'证件  号码: [20]',#ZJHM);
			print( 14,20,'新证件类型: [12]',#SBZJLX);
			print( 15,20,'新证件号码: [20]',#XZJHM);
			print( 16,20,'身份核查结果:[60] ',#HCJGBL);
                        print( 24,20,'备注:')
                        print( 24,27,'交易日期:[8] [8]',$HDATE,@txtime);
                        print( 24,5,'柜员:[4]',$FD7);
                        print( 24,5,'流水号:[6]',$FD4);   
		}
	}"
	</PRINT>
</RESPONSE>
</TRANSACTION>
