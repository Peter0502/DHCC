<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11110000" TITLE="4202 对公取款业务"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
	
	//与神码通讯 Begin by hxc
	dim @filename as string;
	@filename='../tmp/'+$FD7+$FD10+'.fds';
	if((substr(#ACTNO,0,6)=='621223') and (#CASHFLAG=='1'))//卡取现金
	{
		showmsg('dfno='+#DFNO);
		showmsg('#ACTNO+='+#ACTNO);
		savefds(@filename);
		
		initfd();
		commsend_001();
		$FD16='7005';
		$FD30=#ACTNO;
		$FD75=#MSR2BAK;
		$FD76=#MSR3BAK;
		
		$FD79=#DRAW_PWD;
		$FD21=#CURCD;
		$FD39=itoa(#TXAMT*100);
		
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return(false);
		}
		#TRAN_FEE=val($FD40);
		#TRAN_FEE1=val($FD40,0.01);
		#CARD_TRACENO=delspace(itoa(val($FD43),'%16d'));
		loadfds(@filename);	
	}
	else if(((substr(#ACTNO,0,6)=='621223') or (substr(#DFNO,0,6)=='621223')or (substr(#DFNO,0,6)=='621780')) and (#CASHFLAG=='2'))//卡卡转账
	{
		savefds(@filename);
	
		initfd();
		commsend_001();
		$FD16='7006';
		$FD30=#ACTNO;    //转出账号
		$FD31=#DFNO;    //转入账号
		$FD79=#DRAW_PWD;
		$FD21=#CURCD;
		$FD39=itoa(#TXAMT*100);
		if(substr(#ACTNO,0,6)=='621223')    //卡折标志： 0 折；1 卡
		{
			$FD67='C';
		}
		else
		{
			$FD67='P';
		}
		if(substr(#DFNO,0,6)=='621223' or substr(#DFNO,0,6)=='621780')    //卡折标志： 0 折；1 卡
		{
			$FD69='C';
		}
		else
		{
			$FD69='P';
		}
		$FD25=#101CNAME;   //转入客户名
		$FD75=#MSR2BAK;
		$FD76=#MSR3BAK;
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return(false);
		}
		#TRAN_FEE=val($FD40);
		#TRAN_FEE1=val($FD40,0.01);
		#CARD_TRACENO=delspace(itoa(val($FD43),'%16d'));
		loadfds(@filename);	
	}
	//与神码通讯 End by hxc
	
	$TXNO='2206';
	commsend_001();
	commsend_102();
	//showmsg('E='+#101DSCPT);
	//showmsg('N='+#101DSCTYPE);
//	showmsg('END='+#DSCPT);
//	showmsg('B='+#DESC10);
	$FD101=getitems('#101ACTNO#101ACSEQ#101AMT#101VOCTYPE#101VOCNUM#101DSCPT#101CARDFLAG#101CNAME#101AVBAL#101CURCD#101CASHFLAG#101DSCTYPE#101ACTYPE#101ACSEQ2#101PNAME');
	$FD102=getitems('#ACTNO24#ACTSEQ#VOCTYPE#VOCNUM#FETCHFLAG#PWDFLAG#QUE_PWD#DRAW_PWD#CERTFLAG#CERTNO#STAMPFLAG#PWDFLAG2#PWD16#PRINTDATE#TXAMT#CERTTYPE#CUSTNAME#AVBAL#CURCD#CASHFLAG#DSCPT#ACTTYPE#ACTSEQ_2#ACCOUNTFLAG#INTEREST1#INTEREST2#INTEREST3#PAYAMOUNT#NEWVOCNUM#SPEFLAG#PRODNAME#ACTNO_24#EDUCREDIT#DESC10');
	$FD112=space(28)+#ZFDBHWB;// add by chenchao 2011-8-1 11:16:41 为后台传值支付协议编号
}"
</COMMSEND>

<COMMRECV>"{
	commrecv_001();
	if(($FD12!='0000') and ($FD12!='Z003') and (substr(#DFNO,0,6)=='621223' or substr(#DFNO,0,6)=='621780') and (len(#DFNO)==19))//卡交易核心处理失败往数码发送取消交易
	{
		#RESP_CODE=$FD12;
		showmsg(geterror());
		initfd();
		commsend_001();
		$FD16='7777';
		$FD12=#RESP_CODE;
		$FD30=#ACTNO;
		$FD39=itoa(#TXAMT*100);
		$FD43=#CARD_TRACENO;
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return (false);
		}
		showmsg('取款失败!!...');
		rerun();
	}
}"
</COMMRECV>
<FIRSTWORK>
"{
  #PIC='';
  #PIC1='';
  show(#PIC,false);
  show(#PIC1,false);
  show(#LBLPIC,false);
  show(#LBLPIC1,false);
  enable(#SETPIC,false);
  enable(#SETPIC1,false);
}"
</FIRSTWORK>
<VARIABLE UPLOOP="TRUE">
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(4202                          对公取款业务)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
   
  <ITEM NAME="#TXNO"      TYPE="%-4s"  FUNCTIONS="T($TXNO=2206)"/>
  <ITEM NAME="#MSGTYPE"   TYPE="%-5s"  FUNCTIONS="T($MSGTYPE=03001)"/>
  <ITEM NAME="#ACT_LX"    TYPE="%-5s"  FUNCTIONS="T(2)"/>
  <ITEM NAME="#ACT_LX_CK" TYPE="%-5s"  FUNCTIONS=""/>
  <ITEM NAME="#TXCD"      TYPE="%-4s"  FUNCTIONS="T(4202)"/>    <!---交易代码--->
  <ITEM NAME="#TXNAME"    TYPE="%-10s" FUNCTIONS="T(对公取款)"/><!---交易名称--->
  
  <ITEM NAME="#MSR2BAK" TYPE="%-37s"  FUNCTIONS=""/>
  <ITEM NAME="#MSR3BAK" TYPE="%-104s"  FUNCTIONS=""/>
  
  <!--输出变量--->
  <ITEM NAME="#TXCNT"   TYPE="%2d"  FUNCTIONS="T($OCCURS=#TXCNT)J(#TOTCNT)" />
  <ITEM NAME="#TOTCNT"  TYPE="%5d"  FUNCTIONS="E(#TOTCNT+#TXCNT)J(#TOTCNTC)"/>
  <ITEM NAME="#TOTCNTC" TYPE="%5d"  FUNCTIONS="T($TOTCNT=#TOTCNT)"/>
  <ITEM NAME="#O_TXDAY" TYPE="%-8s" FUNCTIONS=""/>
  <ITEM NAME="#O_PBDSC" TYPE="%-3s" FUNCTIONS="J(#OL_PBDSC)"/>
  <ITEM NAME="#OL_PBDSC" TYPE="%-2s" FUNCTIONS="T(  )j(#O_PBDSC=001,T{存})j(#O_PBDSC=002,T{取})"/>
  <ITEM NAME="#O_TXAMT" TYPE="%16.2f" FUNCTIONS="J(#OL_TXAMT)"/>
  <ITEM NAME="#OL_TXAMT" TYPE="%-16s" FUNCTIONS="X(#O_TXAMT)"/>
  <ITEM NAME="#O_CRDB" TYPE="%-1s" FUNCTIONS="J(#OL_SIGN)"/>
  <ITEM NAME="#OL_SIGN" TYPE="%-1s" FUNCTIONS="T( )j(#O_CRDB=1,T{-})"/>
  <ITEM NAME="#O_AVBAL" TYPE="%16.2f" FUNCTIONS="J(#OL_AVBAL)"/>
  <ITEM NAME="#OL_AVBAL" TYPE="%-16s" FUNCTIONS="X(#O_AVBAL)"/>
  <ITEM NAME="#O_TLRNO" TYPE="%-4s" FUNCTIONS=""/>
  <ITEM NAME="#TRAN_FEE" TYPE="%16.2f" FUNCTIONS=""/>
  <ITEM NAME="#TRAN_FEE1" TYPE="%16.2f" FUNCTIONS=""/>
  <ITEM NAME="#CARD_TRACENO" TYPE="%-16s" FUNCTIONS=""/>
  <ITEM NAME="#RESP_CODE" TYPE="%-4s" FUNCTIONS=""/>

  <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
  <ITEM NAME="#PASSWD"    TYPE="%-6s"  FUNCTIONS="T()"/>
  <!--<ITEM NAME="#ACTNO24"   TYPE="%-24s" FUNCTIONS="T(#ACTNO)"/>--><!--同名ITEM liangq注-->
  <!--<ITEM NAME="#ACTSEQ"    TYPE="%-4s"  FUNCTIONS=""/>--><!--同名ITEM liangq注--><!--帐户序号-->
 <!-- <ITEM NAME="#VOCNUM"    TYPE="%-16s" FUNCTIONS=""/>-->
 <ITEM NAME="#NBFLAG"    TYPE="%-1s" FUNCTIONS=""/>
<!---
  <ITEM NAME="#DESC10"    TYPE="%-10s" FUNCTIONS="S(#VOCDSCPT,#VOCDSCPT)"/>
  <ITEM NAME="#DSCPT"     TYPE="%-3s" FUNCTIONS=""/>

  <ITEM NAME="#ACTTYPE"   TYPE="%-1s" FUNCTIONS=""/>
--->
  <!--<ITEM NAME="#ACTSEQ_2"  TYPE="%-4s" FUNCTIONS=""/>--><!--同名ITEM liangq注-->
  
  <PAGE NAME="DEFAULT">
	<ITEM NAME="#LACTNO" LINE="6"  COL="5" TYPE="%-10s"  FUNCTIONS="T(帐    号: )"/>
	<ITEM LINE="6" COL="40" NAME="#LBLPIC" TYPE="%-10s" FUNCTIONS="T(照    片:)"/>
	<ITEM LINE="8" COL="40" NAME="#LBLPIC1" TYPE="%-10s" FUNCTIONS="T(印    件:)"/> 
	<ITEM LINE="6" COL="50" LINES="160" COLS="120" NAME="#PIC" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/> 
	<ITEM LINE="8" COL="50" LINES="240" COLS="160" NAME="#PIC1" TYPE="%-10s" VISABLE="FALSE" FUNCTIONS=""/>    
	<ITEM LINE="8"   COL="4" TYPE="%-16s" FUNCTIONS="T(【产品信息】)"/>
	<ITEM LINE="9"   COL="5" TYPE="%-70s" FUNCTIONS="T(-----------------------------------------------------------------------)"/>
	<ITEM NAME="#ACTNO"  LINE="6"  COL="15" TYPE="%-19s"  DEVICE="KEYBOARD" FUNCTIONS="">
	 <ONLOSTFOCUS>
	   "{
		// showmsg(#ACTNO);
		if(substr(#ACTNO,0,6)=='621223' and len(rtrim($MSR2))!=37)
    		{
       			showmsg('刷卡错误,请重试!');
      			// return(false);
    		}
	
		#MSR2BAK=$MSR2;
		#MSR3BAK=$MSR3;
		$MSR2='';
		$MSR3='';
		
		$TXNO='9955';
		if(judgeone(#ACTNO) != true)
           {
	                return (false);
           }
	}"
	 </ONLOSTFOCUS>
	 </ITEM>

	<BLOCK NAME="ACTINFO" LINE="7" COL="0" VISABLE="FALSE">
		<IMPORT>42021.IMP</IMPORT>
	</BLOCK>
	
	<ITEM NAME="#ADDINFO" TYPE="%-1s" FUNCTIONS="">
	<ONLOSTFOCUS>
	"{
			// showmsg('$cashflag---'+#CASHFLAG);
			if(#CASHFLAG=='2')
			{
				show(#NT_PAGE,true);
				goitem(#NT_PAGE);
			}else{
				show(#COMP,true);
				goitem(#COMP);
			}
	}"
	</ONLOSTFOCUS>
	</ITEM>
	
	<ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(下一页)" INPUT="BUTTON" NAME="#NT_PAGE" VISABLE="FALSE">
  <ONCLICK>"{
	loadpage('PAGE2');
  }"
  </ONCLICK>
  </ITEM>
  <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="SUBMIT" NAME="#COMP"    VISABLE="TRUE"/>
	
	</PAGE>
	
	<IMPORT>TRANSINFO.IMP</IMPORT>
	
	<!--
	<PAGE NAME="PAGE1">
		<BLOCK NAME="ACTINFO1" LINE="0" COL="0" >
			<IMPORT>420211.IMP</IMPORT>
			</BLOCK>
		</PAGE>	
  -->
  <ITEM NAME="#SELFYN"    TYPE="%-1s"  FUNCTIONS="T(1)"/><!----因打凭证需要设此变量,意为是否本人---->
  <ITEM NAME="#AGENTNAME" TYPE="%-20s" FUNCTIONS=""/>    <!----因打凭证需要设此变量---->
  <ITEM NAME="#SATCETYPE" TYPE="%-20s" FUNCTIONS=""/>    <!----因打凭证需要设此变量---->
  <ITEM NAME="#ATCENUM"   TYPE="%-1s"  FUNCTIONS=""/>    <!----因打凭证需要设此变量---->

</VARIABLE>
<REQUEST>
</REQUEST>

<RESPONSE>
   <PACKAGE DEVICE="SCREEN" DESC="显示内容">
   NOTHING
   </PACKAGE>
   <PRINT>"{
		print( 3, 32,'对公取款业务');
		print( 5, 22,'取款帐号: [19]',#ACTNO);
		print( 6, 22,'户    名: [60]',#CUSTNAME);
		print( 7, 22,'取款金额: [16]',#UTXAMT);
		print( 8, 22,'流 水 号: [ 6]',$FD4);
	}"
  </PRINT>
</RESPONSE>

<IMPORT>CX_QK_VOC.IMP</IMPORT>
<IMPORT>CX_CK_PZ.IMP</IMPORT>
<!--
<IMPORT>CXCZ.IMP</IMPORT>
-->

</TRANSACTION>
