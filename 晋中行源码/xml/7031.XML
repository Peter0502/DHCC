<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111100000000000000000000000000" TITLE="7031  VTM对账结果查询"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="HTTP://WWW.w3c.org">

<VARIABLE>
	<ITEM LINE="3"  COL="3" TYPE="%-60s" FUNCTIONS=
		"T(7031                            VTM对账结果查询)"/>
	<ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
		"T(─────────────────────────────────────)"/>
	<ITEM NAME="#TXNO"    TYPE="%-4s" FUNCTIONS="T($TXNO=7031)">
			<ONLOSTFOCUS>
		"{
			dim @tota as string;
			
			initfd();
			commsend_001();
			$FD16='9598';
			$FD123='select * from com_tel where csts='+chr(39)+'0'+chr(39)+' and tel='+chr(39)+$TLRNO+chr(39)+' ';
			@tota=callserver();
			if($FD12!='0000')
			{
				showmsg(geterror());
				return(false);
			}
			if(@tota=='')
			{
				showmsg('柜员没有签到');
				closeall();
				return(false);
			}
			
			initfd();
			commsend_001();
			$FD60 = 'VTMC';
			$FD16 = '5098';
			callagnpt();
			if($FD12 != '0000')
			{
				showmsg(geterror());
				return(false);
			}
			@tota = '0|全部                          |' + chr(10);
			@tota = @tota + getfiletxt('../tmp/'+$KINBR+$TTYNAME);
			setsel(#TXTYPE, @tota, 'v1o1t30o2');
			#TXTYPE = strfld(@tota, '|', 0);
			enable(#TXTYPE, true);
		}"
		</ONLOSTFOCUS>
	</ITEM>
	
	<ITEM LINE="9" COL="15" TYPE="%-10s" FUNCTIONS="T(交易日期:)"/>
	<ITEM LINE="9" COL="25" NAME="#BGNDATE" TYPE="%-8s" INPUT="TEXT" DEVICE="KEYBOARD" FUNCTIONS="T()D()">
		<ONLOSTFOCUS>
		"{
				dim @txday as date;
				dim @otxday as date;
				
				@txday = substr($HDATE, 0, 4) + substr($HDATE, 4, 2) + substr($HDATE, 6, 2);
				if ((@txday &lt; #BGNDATE) or (@txday == #BGNDATE))
				{
					showmsg('起始日期必须早于当前日期!');
					return(false);
				}
				
				if (len(delspace(#BGNDATE)) != 0)
				{
					initfd();
					commsend_001();
					$FD60 = 'VTMC';
					$FD16 = '5097';
					callagnpt();
					if($FD12 != '0000')
					{
						showmsg(geterror());
						return(false);
					}
					@otxday = @txday - atoi(delspace($FD62));
					if (#BGNDATE &lt; @otxday)
					{
						showmsg('对账信息保存天数为'+ delspace($FD62) +'天，请确认起始日期!');
						return(false);
					}
				}
				
		}"
		</ONLOSTFOCUS>
	</ITEM>
	
	<ITEM LINE="9" COL="33" TYPE="%-4s" FUNCTIONS="T( → )"/>
	<ITEM LINE="9" COL="37" NAME="#ENDDATE" TYPE="%-8s" INPUT="TEXT" DEVICE="KEYBOARD" FUNCTIONS="T()D()">
		<ONLOSTFOCUS>
		"{
				dim @txday as date;
				
				@txday = substr($HDATE, 0, 4) + substr($HDATE, 4, 2) + substr($HDATE, 6, 2);
				
				if (len(delspace(#BGNDATE)) != 0 and len(delspace(#ENDDATE)) == 0)
				{
					showmsg('请输入终止日期!');
					return(false);
				}
				
				if (len(delspace(#ENDDATE)) != 0 and len(delspace(#BGNDATE)) == 0)
				{
					showmsg('请输入起始日期!');
					return(false);
				}
				
				if ((@txday &lt; #ENDDATE) or (@txday == #ENDDATE))
				{
					showmsg('终止日期必须早于当前日期!');
					return(false);
				}
				
				if (#ENDDATE &lt; #BGNDATE)
				{
					showmsg('起始日期不能晚于终止日期！');
					return(false);
				}
		}"
		</ONLOSTFOCUS>
	</ITEM>
	
	<ITEM LINE="11" COL="15" TYPE="%-10s" FUNCTIONS="T(VTM 柜员:)"/>
	<ITEM LINE="11" COL="25" NAME="#TLRNO" INPUT="TEXT" TYPE="%4d" FUNCTIONS="T()">
		<ONLOSTFOCUS>
		"{
			dim @txno_bak as string;
			
			if (len(delspace(#TLRNO)) != 0)
			{
				show(#GYXMITEM, true);
				show(#GYXM, true);
				
				initfd();
				@txno_bak = $TXNO;
				$TXNO = '9803';
				commsend_001();
				$FD92 = #TLRNO;
				callserver();
				$TXNO = @txno_bak;
				if($FD12 != '0000')
				{
					showmsg(geterror());
					return(false);
				}
				#GYXM = $FD26;
				if (delspace($FD91) != $KINBR)
				{
					showmsg('请输入本机构VTM柜员');
					return(false);
				}
				enable(#GYXM, false);
			}
			else
			{
				show(#GYXMITEM, false);
				show(#GYXM, false);
			}
		}"
		</ONLOSTFOCUS>
	</ITEM>
	
	<ITEM LINE="12" COL="15" TYPE="%-10s" NAME="#GYXMITEM" FUNCTIONS="T(柜员名称:)"/>
	<ITEM LINE="12" COL="25" TYPE="%-30s" NAME="#GYXM" INPUT="TEXT" FUNCTIONS="T()"/>
		
	<ITEM LINE="14" COL="15" TYPE="%-10s" FUNCTIONS="T(交易类型:)"/>
	<ITEM LINE="14" COL="25" TYPE="%1s" NAME="#TXTYPE" INPUT="SELECT" FUNCTIONS="T(0)V(NB)">
		<SELECT>
		</SELECT>
	</ITEM>
	
	<ITEM LINE="16" COL="15" TYPE="%-10s" FUNCTIONS="T(对账状态:)"/>
	<ITEM LINE="16" COL="25" TYPE="%1s" NAME="#STAT" INPUT="SELECT" FUNCTIONS="T(0)V(NB)">
		<SELECT>
			<OPTION VALUE="0"  TITLE="0.全部"/>
			<OPTION VALUE="5"  TITLE="1.对账成功"/>
			<OPTION VALUE="6"  TITLE="2.对账失败"/>
		</SELECT>
	</ITEM>
	
	<ITEM LINE="21" COL="65" TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="BUTTON">
		<ONCLICK>
		"{
				dim @num as number;
				dim @tota as string;
				dim @selid as number;
				
				initfd();
				commsend_001();
				$FD16 = '5099';
				$FD60 = 'VTMC';
				$FD28 = #BGNDATE;
				$FD29 = #ENDDATE;
				$FD67 = #TXTYPE;
				$FD68 = #STAT;
				$FD92 = #TLRNO;
				callagnpt();
				if($FD12!='0000')
				{
					showmsg(geterror());
					return(false);
				}
				
				@tota=getfiletxt('../tmp/'+$KINBR+$TTYNAME);
				autolist(@tota);
				while (true)
				{
					@selid = list_work();
					if (@selid &lt; 0)
					{
						closeall();
						return(true);
					}
					else
					{
						runoutput();
						closeall();
						return(true);
					}
				}
		}"
		</ONCLICK>
	</ITEM>
</VARIABLE>

<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="打印本页记录">
		NOTHING
	</PACKAGE>
	<PRINT>
	"{
		list_print();
	}"
	</PRINT>
</RESPONSE>

</TRANSACTION>
