<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11111111" TITLE="7777 卡单边撤销交易"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<FIRSTWORK>
	"{
			show(#ONE,true);
			show(#TWO,false);
			show(#TRACENO_TRAN,true);
	}"
</FIRSTWORK>
<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(7777                        卡单边撤销交易)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
    <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=7777)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  <ITEM NAME="#CCY"             TYPE="%-3s"   FUNCTIONS="T(156)"/>
  <ITEM NAME="#IC_ATC"          TYPE="%-4s"   FUNCTIONS=""/>           <!--应用交易计数器-->
	<ITEM NAME="#IC_AC"           TYPE="%-16s"  FUNCTIONS=""/> 
	<ITEM NAME="#CARD_SEQ_ID"     TYPE="%-3s"   FUNCTIONS=""/> 
	<ITEM NAME="#CARD_TRACENO_TRAN" TYPE="%-16s" FUNCTIONS=""/>          <!--卡系统返回交易流水号，在脚本处理结果通知中用-->
  <ITEM NAME="#O_TRACE_NAME" TYPE="%-30s" FUNCTIONS=""/>
  <!--输入变量-->
  <BLOCK NAME="COMMON" LINE="7" COL="12">
  <ITEM LINE="0" COL="0" TYPE="%-15s" FUNCTIONS="T(撤销   对象:)"/>
  <ITEM LINE="0" COL="14" TYPE="%-1s"  NAME="#CXDX" INPUT="SELECT"   FUNCTIONS="V(NB)T(0)">
		<SELECT>
			<OPTION VALUE="0" TITLE="撤销借记卡交易"/>
			<OPTION VALUE="1" TITLE="撤销电子现金交易"/>
			<OPTION VALUE="2" TITLE="撤销电子现金结清交易"/>
		</SELECT>
		<ONLOSTFOCUS>"{
  	
     if(#CXDX=='0' or #CXDX=='2')
     {
     enable(#TRAN_AC_NO_IC,false);
     enable(#TRAN_AC_NO,true);
     show(#TRAN_AC_NO,true);
     show(#TRAN_AC_NO_IC,false);
     }
     if(#CXDX=='1')
     {
     enable(#TRAN_AC_NO,false);
     enable(#TRAN_AC_NO_IC,true);
     show(#TRAN_AC_NO_IC,true);
     show(#TRAN_AC_NO,false); 
     }
   }"
  </ONLOSTFOCUS>
	</ITEM>
  <ITEM LINE="2" COL="0" TYPE="%-15s" FUNCTIONS="T(卡       号:)"/>
  <ITEM LINE="4" COL="0" TYPE="%-15s" FUNCTIONS="T(交 易 金 额:)"/>
  <ITEM LINE="6" COL="0" TYPE="%-15s" FUNCTIONS="T( 交易发起方:)"/> 
  <ITEM NAME="#TRAN_AC_NO" INPUT="TEXT" LINE="2" COL="14"  TYPE="%-19s" FUNCTIONS="V(NB)">
  <ONLOSTFOCUS>
    "{
    	if((substr(#TRAN_AC_NO,0,6)!='621223') and (substr(#TRAN_AC_NO,0,6)!='621780'))
    	{
    	 showmsg('此交易只支持本行银行卡!');
    	 return (false);
		  }
		  if(#CXDX!='0' and #CXDX!='2')
    	 {
    	 showmsg('撤销对象选择错误，请重新选择！');
    	 return (false);
    	 }
     }"
     </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#TRAN_AC_NO_IC" INPUT="TEXT" LINE="2" COL="14"  TYPE="%-19s"   DEVICE="FIXICC"  FUNCTIONS="V(NB)M($MSR2,1)">
  <ONLOSTFOCUS>
    "{
    	if(substr(#TRAN_AC_NO_IC,0,6)!='621780')
    	{
    	 showmsg('此交易只支持本行IC卡!');
    	 return (false);
		  }
		  if(#CXDX!='1')
    	 {
    	 showmsg('撤销对象选择错误，请重新选择！');
    	 return (false);
    	 }
     }"
     </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#TXAMT" INPUT="TEXT" LINE="4" COL="14" TYPE="%17.2f" FUNCTIONS="V(NB)"/>
  <ITEM NAME="#ONETWO" INPUT="SELECT" LINE="6" COL="14" TYPE="%-3s" FUNCTIONS="T(001)">
  	<SELECT>
  		<OPTION VALUE="001" TITLE="1.行内柜面"/>
  		<!--OPTION VALUE="002" TITLE="2.西安卡系统"/-->
  	</SELECT>
    <ONLOSTFOCUS>
    "{
    	if(#ONETWO=='001')
    	{
    	 show(#ONE,true);
    	 show(#TWO,false);
    	 show(#TRACENO_TRAN,true);
     }
     if(#ONETWO=='002')
     {
      show(#TWO,true);
      show(#ONE,false);
      show(#TRACENO_TRAN,true);
      }
     }"
     </ONLOSTFOCUS>
     </ITEM>
     <ITEM LINE="8" COL="0" NAME="#ONE" TYPE="%-15s" FUNCTIONS="T(卡系统流水号:)" />
     <ITEM LINE="8" COL="0" NAME="#TWO" TYPE="%-15s"  FUNCTIONS="T(核心流水号:)"/>
     <ITEM NAME="#TRACENO_TRAN" INPUT="TEXT" LINE="8" COL="14" TYPE="%-19s" FUNCTIONS="V(NB)"/>
 </BLOCK>
  <!--输出变量--->
  <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
  <ITEM NAME="#PASSWD" TYPE="%-6s" FUNCTIONS="T()"/>
  <ITEM LINE="21" COL="59"  TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="BUTTON">
	<ONCLICK>"{
		//发往核心调用授权交易
		initfd();
    commsend_001();
	  $FD16='3369';
	  callserver();
	  if($FD12 !='0000')
	  {
	   showmsg(geterror());
	   return(false);
	  }
	   showmsg('撤销授权!!...');
	   if(#CXDX=='0')//借记卡撤销交易
	  {
		initfd();
		commsend_001();
		$FD16='7777';
		$FD12='9999';
		$FD82=#ONETWO;
		$FD30=#TRAN_AC_NO;
		$FD39=itoa(#TXAMT*100);
		$FD43=#TRACENO_TRAN;
		callagn();
		if($FD12!='0000')
		{
			showmsg('撤销卡系统败:['+geterror()+']');
			return (false);  
		}
		#O_TRACE_NAME=$FD25;
		showmsg('原交易名称是：'+#O_TRACE_NAME);
		showmsg('撤销成功!!...');
		}
	if(#CXDX=='1')//电子现金撤销交易
		{
		dim @tagvalue as string;
		dim @shuju as string;
		dim @update as string;
		@tagvalue= ictagvalue('9f79');
		if(strfld(@tagvalue,'|',0)!='9000')
		{
			showmsg('函数ictagvalue的返回值有误!');
			return(false);
		}
		//showmsg(strfld(@tagvalue,'|',0));
		@tagvalue= strfld(@tagvalue,'|',1);
		//showmsg('电子现金@tagvalue='+delspace(val(@tagvalue,0.01)));
		initfd();
		commsend_001();
		$FD16='7111';
		$FD82=#ONETWO;
		$FD75=$MSR2;
		$FD76=$MSR3; //三磁
		$FD21=#CCY;  //  当前默认只识别RMB 156
		$FD30=#TRAN_AC_NO_IC;
		$FD39=itoa(#TXAMT*100);  // 交易金额
		//showmsg('交易金额$FD39='+ $FD39);
		$FD42=itoa(@tagvalue,'%016.2f');    // 电子现金卡上的余额
		//$FD79=#PASSWORD;
		$FD43=#TRACENO_TRAN;   // 原交易流水
		//showmsg('原交易流水='+ $FD43);
		// 应用交易计数器 IC_ATC 和 应用密文 IC_AC
		//@shuju=initiccard();
		<!--银联柜面通上线后改造读卡程序修改 hzh 20130818-->
		@shuju=initiccard('00','000000000000');
		#IC_ATC=strfld(@shuju,'|',2); 
		#IC_AC=strfld(@shuju,'|',3);
		#CARD_SEQ_ID=strfld(@shuju,'|',4); 
		$FD34 =#IC_ATC ; // 应用计数器
		$FD33 =#IC_AC ;// 应用密文
		$FD23 =#CARD_SEQ_ID;//IC卡序列号
		//showmsg('应用JSQ='+$FD34 );       
		//showmsg('应用密文#ICMW='+$FD33);
		//showmsg('IC卡序列号#ICSEQID='+$FD23);
		
		 if (isTxContinue() == false )
		     {
			   return(false);
		     }
    showmsg('请勿拔卡!');
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror()+'，撤销交易失败！');
			return (false);
		}
		#O_TRACE_NAME=$FD25;
		showmsg('原交易名称是：'+#O_TRACE_NAME);
		//showmsg('撤销成功!!...');
		#CARD_TRACENO_TRAN=$FD75;  
		@update=updateiccard($FD108);
		//showmsg('SYS108='+$FD108);
		if (@update != '9000')
		{
			showmsg('失败@update='+@update);
		}
		//showmsg('@update='+@update);
		//showmsg('开始发脚本处理结果通知!');
		<!--    脚本处理结果通知   -->
		initfd();
		commsend_001();
		$FD16='7767';
		$FD21='1';
		$FD12=@update;
		$FD40=itoa(#TXAMT*100);  // 交易金额
		$FD43=#CARD_TRACENO_TRAN;
		//showmsg('$FD43='+$FD43);
		if (isTxContinue() == false )
		{
			showmsg('交易过程中不能拔出IC卡');
			return(false);
		}
		callagn();
		if($FD12!='0000')
		{
			showmsg('脚本执行结果返回错误！！！');
			return (false);
		}
		}
	if(#CXDX=='2')//电子现金结清撤销交易
		{
		initfd();
		commsend_001();
		$FD16='7111';
		$FD82=#ONETWO;
		$FD21=#CCY;  //  当前默认只识别RMB 156
		$FD30=#TRAN_AC_NO;
		$FD39=itoa(#TXAMT*100);  // 交易金额
		$FD43=#TRACENO_TRAN;   // 原交易流水
		//showmsg('原交易流水='+ $FD43);
		// 应用交易计数器 IC_ATC 和 应用密文 IC_AC
		callagn();
		if($FD12!='0000')
		{
			showmsg(geterror()+'，撤销交易失败！');
			return (false);
		}
		#O_TRACE_NAME=$FD25;
		showmsg('原交易名称是：'+#O_TRACE_NAME);
		//showmsg('撤销成功!!...');
		#CXDX='1';  //电子现金结清撤销交易和电子现金撤销交易打印凭证是一样的
		#TRAN_AC_NO_IC=#TRAN_AC_NO;//为了打印撤销凭证显示账号
		}
		//为不去核心的交易补打平台流水做准备
		$FD4=itoa(val($FD37),'%06d');		
		runoutput();
		rerun();
	}"
 	</ONCLICK>
  </ITEM>
</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="SCRREN" DESC="单边撤销成功，按任意键打印">
NOTHING
</PACKAGE>
<PRINT>"{
	print(5,5,'单边撤销成功！');
}"
</PRINT>
</RESPONSE>
<OUTPUT>
</OUTPUT>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(电子现金单边撤销交易)" CHECK="#CXDX=1">
		NOTHING
	</PACKAGE>
	<PRINT>
	"{
		dim @txday  as string;
		dim @txtime as string;
		dim @amt    as string;
		dim @ltxamt1    as string;
		@amt       ='￥'+ltrim(comma(#AMT));
		@ltxamt1   ='￥'+ltrim(comma(#LTXAMT1));
		@txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 5, 20,'机构名称:[30]',$BRNAME);
		print( 5,  2,'代码:7777');
		print(5,13,'交易:电子现金单边撤销交易');	
		
		print( 7,30,'\L0电子现金单边撤销交易凭条\L1');  
		print(10, 20,'原帐/ 卡号:[20                    ]',#TRAN_AC_NO_IC);
    print(11, 20,'原交易名称:[20                    ]',#O_TRACE_NAME);
    print(12, 20,'原交易金额:[21  ]',#TXAMT);
    print(13, 20,'原卡系统流水:[20                    ]',#TRACENO_TRAN);
    print_sq(); 
    <!--
    print(19,80,'\H0相关人员已确认银行打印记录正确无误.\H1');
    -->
    print(21,80,'主管签名:_____________________'); 
	
    print(23,20,'备注:');
    print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
    print(23,5,'柜员:[4]',$FD7);
    print(23,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印业务专用凭证(借记卡单边撤销交易)" CHECK="#CXDX=0">
		NOTHING
	</PACKAGE>
	<PRINT>
	"{
		dim @txday  as string;
		dim @txtime as string;
		dim @amt    as string;
		dim @ltxamt1    as string;
		@amt       ='￥'+ltrim(comma(#AMT));
		@ltxamt1   ='￥'+ltrim(comma(#LTXAMT1));
		@txday  = substr($HDATE,0,4)+'-'+substr($HDATE,4,2)+'-'+substr($HDATE,6,2);
		@txtime = substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		print( 5, 20,'机构名称:[30]',$BRNAME);
		print( 5,  2,'代码:7777');
		print(5,13,'交易:借记卡单边撤销交易');	
		
		print( 7,30,'\L0借记卡单边撤销交易凭条\L1');  
    print(10, 20,'原帐/ 卡号:[20                    ]',#TRAN_AC_NO);
    print(11, 20,'原交易名称:[20                    ]',#O_TRACE_NAME);
    print(12, 20,'原交易金额:[21  ]',#TXAMT);
    print(13, 20,'原卡系统流水:[20                    ]',#TRACENO_TRAN);
    print_sq(); 
    <!--
    print(19,80,'\H0相关人员已确认银行打印记录正确无误.\H1');
    -->
    print(21,80,'主管签名:_____________________'); 
	
    print(23,20,'备注:');
    print(23,27,'交易日期:[8] [8]',$HDATE,@txtime);
    print(23,5,'柜员:[4]',$FD7);
    print(23,5,'流水号:[6]',$FD4);
	}"
	</PRINT>
</RESPONSE>
</TRANSACTION>

