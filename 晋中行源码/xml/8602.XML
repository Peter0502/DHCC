<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11100000" TITLE="8602     批量代收付业务处理"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
	initfd();
	$MSGTYPE='03001';
	dim @baktxno as string;
	@baktxno=$TXNO;
	$FD12='6602';
	$TXNO='9986';
	$FD40=getitems('#TOTAMT');
	$FD21=#AGENTYPE;
	$FD30=#DWACTNO;
	$FD25=#DWNAME;
	$FD39=space(16);
	$FD46=#BATCHSDATE;
	$FD47=#BATCHEDATE;
	$FD55=#TOTNUM;
	$FD61=#AGENNAME;
	$FD70=#PROSTYLE;
	$FD71=#YWTYPE;
	$FD92=#DWID;
	commsend_001();
	 callserver();
	if($FD12!='0000')
	{
		showmsg(geterror());
		return(false);
	}
	$FD16 = '6602';
  	$MSGTYPE='03001';
}"
</COMMSEND>
<COMMRECV>"{
commrecv_001();
if($FD12 == '0000')
	 {
		 showmsg('交易成功!');
	 }
}"
</COMMRECV>

<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-52s" FUNCTIONS=
    "T(8602                            批量代收付业务处理)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=6602)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
 
  <ITEM LINE="7"   COL="5"    TYPE="%-10s"  FUNCTIONS="T(单位编号:)"/>
  <ITEM LINE="7"   COL="23"   TYPE="%-10s"  FUNCTIONS="T(单位名称:)" />
  
  <ITEM LINE="9"   COL="5"    TYPE="%-10s"  FUNCTIONS="T(业务性质:!)" />
  <ITEM LINE="9"   COL="40"   TYPE="%-10s"  FUNCTIONS="T(代理类型:!)" />
  
  <ITEM LINE="11"  COL="5"    TYPE="%-10s"  FUNCTIONS="T(单位账号:)"/>
  
  <ITEM LINE="13"  COL="5"    TYPE="%-14s"  FUNCTIONS="T(信息录入方式:!)"/>
  <ITEM LINE="13"  COL="40"   NAME="#FILE"  VISABLE="FALSE" TYPE="%-14s"  FUNCTIONS="T(代发文件名称:)"/>
  <ITEM LINE="13"  COL="40"   NAME="#LSTNAME" TYPE="%-16s" FUNCTIONS="T(上次发工资时间:)"/>
 
  <ITEM LINE="15"  COL="5"    TYPE="%-10s"  FUNCTIONS="T(总 金 额:)"/>
  <ITEM LINE="15"  COL="40"   TYPE="%-10s"  FUNCTIONS="T(总 笔 数:)"/>
  <ITEM LINE="17"  COL="5"    TYPE="%-12s"  FUNCTIONS="T(批处理日期:)"/>
  <ITEM LINE="17"  COL="26"   TYPE="%-4s"  FUNCTIONS="T(-->)"/>
  <ITEM LINE="7"   COL="15"  NAME="#DWID"         TYPE="%-4s"        INPUT="TEXT"    FUNCTIONS="V(NB)">
   <ONLOSTFOCUS>"{
	commsend_001();		
	$FD16='9841';
	$FD92=#DWID;
	callserver();
	if($FD12!='0000'){
		showmsg(geterror());
		return(false);
	}
	#DWNAME=delspace($FD25);
	#YWTYPE=delspace($FD71);
	#AGENTYPE=delspace($FD21);
	#DWACTNO=delspace($FD30);
	$BUFFER=#DWID;
	}"
	</ONLOSTFOCUS>
  </ITEM> 
  <ITEM LINE="7"  COL="33"  NAME="#DWNAME"      TYPE="%-40s"       INPUT="LABEL" FUNCTIONS="" />
   
  <ITEM LINE="9"  COL="15"  NAME="#YWTYPE"      TYPE="%-1s"        INPUT="SELECT"  FUNCTIONS="T(0)" ENABLE="FALSE">
    <SELECT>
       <OPTION VALUE ="0" TITLE="0.代收" />
       <OPTION VALUE ="1" TITLE="1.代付" />
    </SELECT>
  </ITEM>
  <ITEM LINE="9"  COL="50"  NAME="#AGENTYPE"    TYPE="%-2s"        INPUT="SELECT"  FUNCTIONS="T(30)" ENABLE="FALSE">
   <SELECT>
       <OPTION VALUE ="30" TITLE="30.代发工资       " />
       <OPTION VALUE ="31" TITLE="31.财政工资       " />
       <OPTION VALUE ="32" TITLE="32.代发自来水工资 " />
       <OPTION VALUE ="33" TITLE="33.批量贷记       " />
       <OPTION VALUE ="35" TITLE="35.现金代发       " />
       <OPTION VALUE ="36" TITLE="36.收益代发       " />
       <OPTION VALUE ="37" TITLE="37.代发定活       " />
       <OPTION VALUE ="38" TITLE="38.代发整整       " />
       <OPTION VALUE ="39" TITLE="39.代发零整       " />
       <OPTION VALUE ="40" TITLE="40.代扣费         " />
       <OPTION VALUE ="41" TITLE="41.代收个人所得税 " />
       <OPTION VALUE ="42" TITLE="42.代收罚款       " />
       <OPTION VALUE ="43" TITLE="43.代收水费       " />
       <OPTION VALUE ="44" TITLE="44.代收煤气费     " />
       <OPTION VALUE ="45" TITLE="45.代收电费       " />
       <OPTION VALUE ="46" TITLE="46.代收税款       " />
       <OPTION VALUE ="47" TITLE="47.代收话费       " />
       <OPTION VALUE ="48" TITLE="48.代收移动费    " />
       <OPTION VALUE ="49" TITLE="49.代收理财费    " />
    </SELECT>          
  </ITEM>
  <ITEM LINE="11"  COL="15"  NAME="#DWACTNO"     TYPE="%-24s"       INPUT="LABEL"  FUNCTIONS="" >
   <ONLOSTFOCUS>
  "{
        commsend_001();
        $FD16='9731';
        $FD102=#DWACTNO;
        callserver();
        if($FD12!='0000'){
                showmsg(geterror());
                return(false);
        }
       // showmsg($FD72);
	showmsg('FD72='+$FD72);
        if($FD72!='0' and $FD72!=''){
                //showmsg('帐户被冻结了请做【8102】交易更改单位帐号');
                showmsg('帐户被冻结或没有代收付业务，请做【8102】交易修改');
                return(false);
        }
     }"
    </ONLOSTFOCUS>
  </ITEM>

  <ITEM NAME="#AGENNAME"     TYPE="%-16s"  FUNCTIONS="S(#AGENTYPE,#AGENTYPE)" />
  <ITEM LINE="13"  COL="20"  NAME="#PROSTYLE"     TYPE="%-1s"       INPUT="SELECT"  FUNCTIONS="T(0)">
   <SELECT>
       <OPTION VALUE ="0" TITLE="0.手动" />
       <OPTION VALUE ="1" TITLE="1.导磁盘" />
      <!---
       <OPTION VALUE ="2" TITLE="2.科技部" />
      --->
    </SELECT>
     <ONLOSTFOCUS>
  "{
   			dim @tota as string;
        dim @f as file;
        dim @filename as string;
        dim @str as string;
        dim @i as number;
      if(#PROSTYLE!='0')
      {
      	show(#LSTDATE,false);
       show(#LSTNAME,false);
       show(#FILENAME,true);
       show(#FILE,true);
       
      }
      else
      { 	
       show(#FILENAME,false);
       show(#FILE,false);
       show(#LSTDATE,true);
       show(#LSTNAME,true);
      }
      
   "}
   </ONLOSTFOCUS>
  </ITEM>
	<ITEM LINE="13"  COL="55"  NAME="#FILENAME"     TYPE="%-15s"  INPUT="TEXT"  FUNCTIONS="" VISABLE="FALSE">
  <ONLOSTFOCUS>
  "{
     		dim @txno_bak as string;
        @txno_bak=$TXNO;
		    $TXNO='6610';
		    $FD38=#FILENAME;
		    commsend_001();		
		    callserver();
		    $TXNO=@txno_bak;
		    if($FD12!='0000')
		    {
			    showmsg(geterror());
			    return(false);
		    }
		    
  "}
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="13"  COL="55"  NAME="#LSTDATE"  TYPE="%8d"  INPUT="TEXT"  FUNCTIONS="D()">
	<ONLOSTFOCUS>
  "{
  			dim @tota as string;
        dim @f as file;
        dim @filename as string;
        dim @str as string;
		//showmsg('LST='+#LSTDATE);	
  	 if(#PROSTYLE=='0' and len(#LSTDATE)!=0)
      {
				commsend_001();
	 			$FD16='6110';
	 			$FD92=#DWID;
	 			$FD44=#LSTDATE;
	 			@tota=callserver();
  			if($FD12!='0000')
				{
					showmsg(geterror());
					return(false);
				}   //生成的文件加一个日期后缀
				@filename='../tmp/'+$KINBR+#DWID+'_8602_'+#PROSTYLE+'_'+$HDATE;
  			@f=openfile(@filename,'w');
  			@str=substr(@tota,0,len(@tota)-1);
 				writeline(@f,@str);
 				closefile(@f);
 			}
   "}
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="15"   COL="15"  NAME="#TOTAMT"          TYPE="%17.2f"  INPUT="TEXT"    FUNCTIONS="V(0000000000000001,0000009999999999)"/>
  <ITEM LINE="15"   COL="50"  NAME="#TOTNUM"          TYPE="%10d"     INPUT="TEXT"    FUNCTIONS="V(NB)"/>
 <ITEM  TYPE="%-1s" NAME="#AAA" >
 <ONLOSTFOCUS>
 "{
    showmsg('代发业务无需输入终止日期!');
  }"
 </ONLOSTFOCUS>
 </ITEM>
  <ITEM LINE="17"   COL="17"  NAME="#BATCHSDATE"      TYPE="%8s"     INPUT="TEXT"    FUNCTIONS="D()T($HDATE)">
  <ONLOSTFOCUS>
		"{ 
		   
		    if(#BATCHSDATE &lt;$HDATE)
			  { 
				   showmsg('批处理起始日期不能小于当前营业日期!');
				   return(false);
				}
			
			}"
	 </ONLOSTFOCUS>
  </ITEM>
  <ITEM LINE="17"   COL="30"  NAME="#BATCHEDATE"      TYPE="%8s"     INPUT="TEXT"    FUNCTIONS="T($HDATE)D()"/>
<ITEM TYPE="%-1s" NAME="#MODIFY" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
	if(#PROSTYLE=='0') //如果上笔日期输入正确,则调出此以下文件,否则,柜员自己输入
	{
	  editfile('../xml/8602.DLG','../tmp/'+$KINBR+#DWID+'_8602_'+#PROSTYLE+'_'+$HDATE);
	  setvfile(true,true);
        }
  }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM TYPE="%-1s" NAME="#AAAA">
   <ONLOSTFOCUS>
  "{
        dim @filename1 as string;
        dim @filename2 as string;
	if(#PROSTYLE=='0')
	{
         list_init(17,78,5,1);
	 list_setcolcnt(8);
	 
	 list_setcol(0,'编号',5);
	 list_setcol(1,'客户姓名',20);
	 list_setcol(2,'开户金额',17);
	 list_setcol(3,'客户帐号',20);
	 list_setcol(4,'单位编号',8);
	 //list_setcol(5,'证件号码',20);
	 //list_setcol(6,'证件类型',8);
	 list_setcol(5,'证件类型',8);
	 list_setcol(6,'证件号码',20);
	 list_setcol(7,'代收付次数',10);
	 @filename1='../tmp/'+$KINBR+#DWID+'_8602_'+#PROSTYLE+'_'+$HDATE; //此处将文件传入8601.DLG
	 //showmsg(@filename1);
	 list_load(@filename1); 
	 @filename2='../tmp/'+$KINBR+$TTYNAME;
	 //showmsg(@filename2);
         list_save(@filename2);
        }
  }"
  </ONLOSTFOCUS>
  </ITEM>
 <!-- <ITEM NAME="#DOMAN"  TYPE="%1s"  FUNCTIONS="">--><!--手工录入代码-->
 <!-- <ONLOSTFOCUS>"{
	dim @line as string;
	dim @ch as string;
	dim @selid as number;
	list_init(17,78,5,1);
	list_setcolcnt(4);
	list_setcol(0,'代发编号',25);
	list_setcol(1,'姓名',51);
	list_setcol(2,'金额',17);
	list_setcol(3,'身份证号码',20);
	list_load('../tmp/'+$KINBR+$TTYNAME+'_8602');
	while(true){
		if(list_getrowcnt()==0){
			list_show();
			@ch=showmsg('1-增加,0-提交');
		}else{
			list_work();
			@ch=showmsg('1-增加,2-修改,3-删除,0-提交');	
		}
		showfooter();
		if(@ch=='0'){
			break;
		}else if(@ch=='1'){
			//增加
			@line=input('1|30|【批量代发工资手工录入-增加】',
						'2|5|单位编号: '+#DWID,
						'4|5|代发编号: |%-24s',
						'6|5|    姓名: |%-50s',
						'8|5|账[卡]号: '+#DWACTNO,
						'10|5|    金额: |%13.2f',
						'12|5|身份证号: |%-19s');
			if(@line!=''){
				list_additem('','','','','','','');
				@selid=list_getrowcnt()-1;
				list_settext(@selid,0,strfld(@line,'|',0));
				list_settext(@selid,1,strfld(@line,'|',1));
				list_settext(@selid,2,itoa(val(strfld(@line,'|',2),0.01),'%.2f'));
				list_settext(@selid,3,strfld(@line,'|',3));
			}
			list_setselid(@selid);
		}else if(@ch=='2'){
			//修改
			@selid=list_getselid();
			if(@selid &lt; 0){
				continue;
			}
			@line=input('1|30|【批量代发工资手工录入-修改】',
					'2|5|单位编号: '+#DWID,
					'4|5|代发编号: |%-24s'+'|T('+list_gettext(@selid,0)+')',
					'6|5|    姓名: |%-50s'+'|T('+list_gettext(@selid,1)+')',
					'8|5|账[卡]号: '+#DWACTNO,
					'10|5|    金额: |%13.2f'
							+'|T('+itoa(val(list_gettext(@selid,2),100),'%.0f')+')',
					'12|5|身份证号: |%-19s'+'|T('+list_gettext(@selid,3)+')');
			if(@line!=''){
				list_settext(@selid,0,strfld(@line,'|',0));
				list_settext(@selid,1,strfld(@line,'|',1));
				list_settext(@selid,2,itoa(val(strfld(@line,'|',2),0.01),'%.2f'));
				list_settext(@selid,3,strfld(@line,'|',3));
			}
			list_setselid(@selid);

		}else if(@ch=='3'){
			@selid=list_getselid();
			if(@selid &lt; 0){
				continue;
			}
			@ch=showmsg('您确定要删除此记录吗?(y/n)');
			if(@ch=='y' or @ch=='Y'){
				list_rmitem(@selid);
			}
			if(list_getrowcnt() &gt; 0 and @selid &lt; list_getrowcnt()){
				list_setselid(@selid);
			}
		}
	}
	if(list_getrowcnt()!=0){
		//保存文件
		setvfile(true,true);
		list_save('../tmp/'+$KINBR+$TTYNAME);
		list_save('../tmp/'+$KINBR+$TTYNAME+'_8602');
	}
	list_del();
	refresh();
	}"	
  </ONLOSTFOCUS>
  </ITEM>-->
	 <!------------一些没有用的变量,只是为了公共脚本执行时不报错------------>
  <ITEM NAME="#PASSWD" TYPE="%-6s" FUNCTIONS="T()"/>
 
  <ITEM LINE="21"  COL="59" TYPE="%-6s" FUNCTIONS="T(确  定)" INPUT="BUTTON">
  <ONCLICK>
  "{
  	initfd();
	$MSGTYPE='03001';
	dim @baktxno as string;
	dim @f as file;
	dim @tota as string;
	@baktxno=$TXNO;
	$FD12='6602';
	$TXNO='9986';
	$FD40=getitems('#TOTAMT');
	$FD21=#AGENTYPE;
	$FD30=#DWACTNO;
	$FD25=#DWNAME;
	$FD39=space(16);
	$FD46=#BATCHSDATE;
	$FD47=#BATCHEDATE;
	$FD55=#TOTNUM;
	$FD61=#AGENNAME;
	$FD70=#PROSTYLE;
	$FD71=#YWTYPE;
	$FD92=#DWID;
	commsend_001();
	callserver();
	$TXNO=@baktxno;
	if($FD12!='0000')
	{
		showmsg(geterror());
		return(false);
	}
	$FD16 = '6602';
  	$MSGTYPE='03001';
  	$FD40=getitems('#TOTAMT');
	$FD21=#AGENTYPE;
	$FD30=#DWACTNO;
	$FD25=#DWNAME;
	$FD39=space(16);
	$FD46=#BATCHSDATE;
	$FD47=#BATCHEDATE;
	$FD55=#TOTNUM;
	$FD61=#AGENNAME;
	$FD70=#PROSTYLE;
	$FD71=#YWTYPE;
	$FD92=#DWID;
	commsend_001();
  	@tota=callserver();
  	if($FD12!='0000')
	{
		showmsg(geterror());
		return(false);
	}

    	@f=openfile('../tmp/批量代收付业务处理['+#DWID+']','w');
     	writeline(@f,@tota);
     	closefile(@f);
     	call('fview ../tmp/批量代收付业务处理['+#DWID+']');
  }"
  </ONCLICK>
  </ITEM>


</VARIABLE>
<REQUEST>
</REQUEST>
<RESPONSE>
	<PACKAGE DEVICE="SCREEN" DESC="批量代收付业务处理">
 NOTHING
 </PACKAGE>
  <PRINT>"{
          print( 2,  24,'交易名称:批量代收付业务处理');
          
          print( 4,  20,'交易机构:[5]',$FD2);
	  print( 5,  20,'交易日期:[4]年[2]月[2]日',#YEAR,#MON,#DAY);  
	  print( 6,  20,'流水号码:[6]',$FD4);
	  print( 7,  20,'操作员号:[4]',$FD7);
	  
	  print( 8,  20,'单位编号:[20 ]',#DWID);
	  print( 9,  20,'单位名称:[16 ]',#DWNAME);
	  print( 10, 20,'总 金 额:[20 ]',itoa(#TOTAMT,'%17.2f'));
	  print( 11, 20,'总 笔 数:[12 ]',#TOTNUM);
	  
	}"
</PRINT>
</RESPONSE>
<RESPONSE>
	<PACKAGE DEVICE="PRINTER" DESC="打印业务专用凭证">
 NOTHING
 </PACKAGE>
  <PRINT>"{
 $KINDNO='00';
 dim @txtime  as string;
@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
        	print( 5, 20,'机构名称:[30]',$BRNAME);
                print( 5, 2,'代码:8602');
                print( 5, 13,'交易:批量代收付业务处理')
	        print( 7, 20,'单位编号:[20 ]',#DWID);
	        print( 8, 20,'单位名称:[16 ]',#DWNAME);
	        print( 9, 20,'总 金 额:[20 ]',itoa(#TOTAMT,'%17.2f'));
	        print(10, 20,'总 笔 数:[12 ]',#TOTNUM);
	        print_sq();
	        print( 24,20,'备注:')
                print( 24,27,'交易日期:[8] [8]',$HDATE,@txtime);
                print( 24,5,'柜员:[4]',$FD7);
                print( 24,5,'流水号:[6]',$FD4);
 
	}"
</PRINT>
</RESPONSE>


</TRANSACTION>
