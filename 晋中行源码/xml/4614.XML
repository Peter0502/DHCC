<?xml version="1.0" encoding="GBK" ?>
<TRANSACTION RIGHTS="11000000" TITLE="4614	  本代他柜面存款"
  xmlns="http://www.otd.org/MENU" xmlns:W3CNS="http://www.w3c.org">
<COMMSEND>"{
	
}"
</COMMSEND>
<COMMRECV>"{
}"
</COMMRECV>
<USERFUN NAME="saveprint">
"{	
	//用于补打凭证
	dim @file as file;
	dim @swtraceno as string;
	dim @traceno as string;
	dim @line as string;
	dim @txamt as string;
	dim @bal as string;
	dim @bal2 as string;
	dim @txtime  as string;
	dim @txfee as string;
	dim @feeamt as number;
	dim @yz37 as string;  //检索参考号
	@feeamt=val(substr($FD88,1,8),0.01);
	
	//写文件，用于补打流水
	@yz37= #YZ37;
	@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);  	
	@swtraceno = substr($FD52,6,6);
	@traceno = $FD4; 
	@txamt = ltrim(comma(itoa(#TXAMT,'%15.2f'),16));
	@txfee = ltrim(comma(itoa(@feeamt,'%8.2f'),16));
	@bal = ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16));
	@bal2 = ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16));
	@file=openfile('../dat/YYHZ_'+$HDATE+'_'+$TLRNO+'_'+@swtraceno+'.dat','ab');
	@line = '7614';
	writeline(@file, @line);
	@line = @swtraceno + '|' + @traceno + '|' + #SBANKCODE + '|' + #CARDNO + '|' + #CZTYPE + '|' + #CUSTNAME + '|' + @txamt + '|' + @txfee + '|' + @bal + '|' + @bal2 + '|'+ @txtime + '|'+ @yz37 + '|';
	writeline(@file, @line);
	
	closefile(@file);	

}"
</USERFUN>

<VARIABLE>
  <ITEM LINE="3"  COL="3" TYPE="%-44s" FUNCTIONS=
    "T(4614			     本代他柜面存款)"/>
  <ITEM LINE="4"  COL="3"  TYPE="%-74s" FUNCTIONS=
   "T(─────────────────────────────────────)"/>
  <ITEM NAME="#TXNO" TYPE="%-4s" FUNCTIONS="T($TXNO=7614)"/>
  <ITEM NAME="#MSGTYPE" TYPE="%-5s" FUNCTIONS="T($MSGTYPE=03001)"/>
  
  <!-- 本代他卡折存款输入项显示   -->
  
  
  <ITEM LINE="6"   COL="15" TYPE="%-10s" FUNCTIONS="T(卡折标志:!)"/>
  <ITEM LINE="8"  COL="15" TYPE="%-10s" FUNCTIONS="T(开户行号:)"/>
  <ITEM LINE="10"   COL="15" TYPE="%-10s" FUNCTIONS="T(卡折号码:)"/>
  <ITEM LINE="12"  COL="15" TYPE="%-10s" FUNCTIONS="T(存入金额:)"/>
  <ITEM LINE="16"  COL="15" TYPE="%-10s" FUNCTIONS="T(返回户名:)"/>
  <ITEM LINE="18"  COL="15" NAME="#LAB1" INPUT="LABEL" VISABLE="FALSE" TYPE="%-16s" FUNCTIONS="T(存款人身份证号:)"/>

  <ITEM NAME="#TXNUMBER" TYPE="%-4s"  FUNCTIONS="T(4614)"/>	     <!---交易代码--->
  <ITEM NAME="#TXNAME"  TYPE="%-20s" FUNCTIONS="T(本代他柜面存款)"/>	 <!---交易名称--->

  <!-- 本代他卡折存款输入项显示结束 -->
  <!-- 本代他卡折存款输入项输入定义 -->
  <ITEM LINE="6" COL="25" NAME="#CZFLAG" TYPE="%1d" DEVICE="KEYBOARD" FUNCTIONS="T(0)V(NB)">
    <SELECT LINE="6" COL="27">
	<OPTION VALUE="0" TITLE="有卡"/>
	<OPTION VALUE="1" TITLE="有折"/>
	<OPTION VALUE="2" TITLE="无卡"/>
	<OPTION VALUE="3" TITLE="无折"/>
    </SELECT>
  </ITEM>
  <ITEM NAME="#STEP1"  TYPE="%-1s" FUNCTIONS="">
 <ONLOSTFOCUS>
  "{
		dim @txno_bak as string;
		dim @tota as string;
		initfd();
		@txno_bak=$TXNO;
		$TXNO='7605';
		$FD22='08';
		commsend_001();
		@tota=callagn(); 
		if($FD12 != '0000')
		{
			showmsg(geterror());
			return(false);
		}
		$TXNO=@txno_bak;
		setsel(#BANKCODE,@tota,'o5t20o1v8o2');
		show(#SUBMIT,false);
		enable(#SUBMIT,false);
		enable(#CUSTNAME,false);
		show(#YZBUTT,true);
	    
   }"
  </ONLOSTFOCUS>
  </ITEM>
  <ITEM NAME="#CZTYPE" TYPE="%-4s"  FUNCTIONS="S(#CZFLAG,#CZFLAG)"/>

  
  <ITEM LINE="8" COL="25" NAME="#BANKCODE" TYPE="%8d" DEVICE="KEYBOARD" FUNCTIONS="T(03090000)V(NB)">
  <SELECT>
	<OPTION VALUE="03090000" TITLE="兴业银行"/>
	</SELECT>
  </ITEM>
 
  <ITEM LINE="10" COL="25"   NAME="#CARDNO1" DEVICE="MSR" TYPE="%-19s"  FUNCTIONS="V(NB)M($MSR2,1)" >
  <ONLOSTFOCUS>
  "{
  		//showmsg(#CARDNO1);
		dim @txno_bak as string;
		dim @tota as string;
		initfd();
		@txno_bak=$TXNO;
		$FD22='08';
		if( #CZFLAG=='2' or #CZFLAG=='3'   )
		{
			#CARDNO=#CARDNO1;
		}
		else
		{
           if($MSR2=='')
		   {
		     showmsg('请使用读卡器!');
			 return(false);
		   }
			   $FD67=#CZFLAG;
			   $FD47=#BANKCODE;
			   $FD75=$MSR2;
			   $FD76=$MSR3;

			   $TXNO='7606';
			   commsend_001();
			   @tota=callagn(); 
			   if($FD12 != '0000')
			   {
			   	showmsg(geterror());
			   	return(false);
			   }
			   #CARDNO=$FD33;
			   #CARDNO1=$FD33;
			   $TXNO=@txno_bak;
		}
   }"
  </ONLOSTFOCUS>
  </ITEM> 
  <ITEM LINE="10" COL="25" NAME="#CARDNO" TYPE="%-19s" INPUT="TEXT" FUNCTIONS=""/> 
  <ITEM LINE="12" COL="25" NAME="#TXAMT" TYPE="%13.2f" DEVICE="KEYBOARD" FUNCTIONS="V(000000000100,999999999999)"/>
  <ITEM NAME="#XTXAMT"  TYPE="%-16s" FUNCTIONS="X(#TXAMT)"/>

  <ITEM LINE="16"  COL="25" NAME="#CUSTNAME"  INPUT="TEXT" TYPE="%-50s"  FUNCTIONS=""/>
  <!-- 存款交易的送银银37域需要与其嵌套验证的37域一致,在这里保存 -->
  <ITEM NAME="#YZ37"  TYPE="%-12s"  FUNCTIONS=""/>
  

  <ITEM LINE="14"  COL="59" NAME="#YZBUTT" TYPE="%-8s" FUNCTIONS="T(帐户验证)" INPUT="BUTTON" >
  <ONLOSTFOCUS>
   "{
		dim @tota1 as string;
		initfd();
		$TXNO='7613';
		$FD22='08';
		if(#CZFLAG=='0' or #CZFLAG=='2')
		{
		 $FD67='0';  //卡的验证
		}
		else
		{
		$FD67='1';  //折的验证
		}
		
		$FD30=#CARDNO;
		$FD39=itoa(#TXAMT*100,'%012.0f');
		$FD47=#BANKCODE;
		$FD75=$MSR2;
		$FD76=$MSR3;
		
		commsend_001();
    	
		@tota1=callagn();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return(false);
		}
		#CUSTNAME=$FD25;
		#YZ37=$FD52;
		enable(#CUSTNAME,false);
		//showmsg('帐户状态正常, 可以继续做存款交易!');
		$TXNO='7614';
		enable(#SUBMIT,true);
		//show(#YZBUTT,false);
		show(#SUBMIT,true);
   }"
  </ONLOSTFOCUS>
  </ITEM>

  <ITEM NAME="#STEP2"  TYPE="%-1s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
	enable(#SUBMIT,true);
	//show(#YZBUTT,false);
	show(#SUBMIT,true);
   }"
  </ONLOSTFOCUS>
  </ITEM>
  
  <ITEM NAME="#SBANKCODE" TYPE="%-40s"  FUNCTIONS="S(#BANKCODE,#BANKCODE)"/>
  
  <ITEM NAME="#STEP3"  TYPE="%-1s" FUNCTIONS="">
  <ONLOSTFOCUS>
  "{
	dim @txno_bak as string;
	dim @tota as string;
	show(#LAB1,false);
	enable(#CERTNUM,false);
	if(#TXAMT &gt; 49999.99 )
	{
		//show(#LAB1,true);
		//enable(#CERTNUM,true);
	}
   }"
  </ONLOSTFOCUS>
  </ITEM>  
  <ITEM LINE="18" COL="25" NAME="#CERTNUM" VISABLE="FALSE"  TYPE="%-19s" INPUT="TEXT" FUNCTIONS="V(NB)">
	<ONLOSTFOCUS>
	"{
		dim @l as number;
		dim @tota as string;
		@l = len(#CERTNUM);
		initfd();
		commsend_001();

		if(@l == 15 or  @l == 18)
		{
				//showmsg('身份证号码位数正确');
		}
		else
		{
				showmsg('身份证号码位数错误');
				return(false);
		}
		
		if(@l == 18)
		{
				//暂时调用sp9659.c对输入身份证进行验证080222
				commsend_001();
				$FD16='9659';
				$FD62=#CERTNUM;
				@tota=callserver();
				if($FD12!='0000')
				{
					showmsg(geterror());
					return(false);
				}
		}
		
		//新增加将全角转换为半角处理080301
		$FD16='9657';
		$FD63=#CERTNUM;
		callserver();
		if($FD12!='0000')
		{
			showmsg(geterror());
			return(false);
		}
		#CERTNUM=delspace($FD63);
	}"
	</ONLOSTFOCUS>
 </ITEM>
<ITEM LINE="21" COL="59" TYPE="%-6s" NAME="#SUBMIT" FUNCTIONS="T(确  定)" INPUT="BUTTON" >
   	<ONCLICK>
   	"{
		dim @tota as string;
		initfd();
		$TXNO='7614';
		$FD22='08';
		$FD67=#CZFLAG;
		$FD30=#CARDNO;
		$FD39=itoa(#TXAMT*100,'%012.0f');     //平台用
		$FD40=itoa(#TXAMT*100,'%016.0f');     //核心用
		$FD61=#YZ37;
		$FD47=#BANKCODE;
		
		if(#CZFLAG=='0' or #CZFLAG=='1')
		{
		   $FD75=$MSR2;
		   $FD76=$MSR3;
		}
	
		commsend_001();		
		@tota=callagn(); 
		if($FD12!='0000')
		{
			if($FD12=='P124'){ //存款先行内记账 核心返回P124是清算账户余额不足
				showmsg('清算账户余额不足!!');
			}else{
				showmsg(geterror());
			}
			//return(false);
		}
		saveprint();
		runoutput(@tota);
		return(true);
		  }"
   	</ONCLICK>
  </ITEM>
   
  </VARIABLE>

<REQUEST>
</REQUEST>
<RESPONSE>
<PACKAGE DEVICE="SCREEN" DESC="本代他存款"  CHECK="$FD12=0000">
	NOTHING
</PACKAGE>
	<PRINT> 
	"{
	dim @feeamt as number;
	@feeamt=val(substr($FD88,1,8),0.01);
	print( 3,27,'本代他存款成功!');
	print( 5,10,'帐    号:[19]',#CARDNO);
	print( 6,10,'户    名:[50]',#CUSTNAME);
	print( 7,10,'存入金额:[50]',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)));
	if(#CZFLAG=='0' or #CZFLAG=='1' )  //无卡折存款可能是他人存,不显余额
	{
		print( 8,10,'账面余额:[16]',ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16)));
		print( 9,10,'可用余额:[16]',ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%15.2f'),16)));
	}
	print( 10,10,'平台流水号:[12]',substr($FD52,6,6));
	print( 11,10,'存款检索号:[12]',substr(#YZ37,6,6));
	print( 12,10,'核心流水:[10]',$FD4);
   //   print( 13,10,'手续费:[10]',ltrim(comma(itoa(@feeamt,'%8.2f'),16)));
    
	}"
	</PRINT>
</RESPONSE>
<RESPONSE>
<PACKAGE DEVICE="SCREEN" DESC="本代他存款"  CHECK="$FD12?0000">
	NOTHING
</PACKAGE>
	<PRINT> 
	"{
		print( 3,10,'本代他存款异常!请查看核心及平台流水以确认交易状态!');
		print( 4,10,'流水号不存在请联系科技部');
		print( 5,10,'帐    号:[19]',#CARDNO);
		print( 6,10,'户    名:[50]',#CUSTNAME);
		print( 7,10,'存入金额:[50]',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)));
		print( 8,10,'平台流水:[12]',substr($FD52,6,6));
		print( 9,10,'核心流水:[10]',$FD4);
    
	}"
	</PRINT>
</RESPONSE>


<RESPONSE>
  <PACKAGE DEVICE="PRINTER" LINESPACE="24" DESC="请打印储蓄存款凭证" CHECK="$FD12=0000">
  NOTHING
  </PACKAGE>

	<PRINT>
	"{
	$KINDNO='00';
	dim @txtime  as string;
	dim @txtype as string;
	dim @feeamt as number;
	@feeamt=val(substr($FD88,1,8),0.01);
	@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
	if($REPRINT=='true')
	{
		reprint_nx();
	}
	// 给客户的凭单中不打手续费  手 续 费:[10]',#YZ37,ltrim(comma(itoa(@feeamt,'%8.2f'),16)),ltrim(comma(itoa(@feeamt,'%8.2f'),16))
	print( 2, 18,'                     [4]     [2]     [2]                           4614',substr($HDATE,0,4),substr($HDATE,4,2),substr($HDATE,6,2));
	//print( 3,30,'         [40                 ]',$BRNAME);
	print( 4,30,'\L0银银合作本代他存款\L1');
	print( 5, 10,'开户行名:[20]                户    名:[16]                 [20]',#SBANKCODE,#CUSTNAME,#SBANKCODE);
	print( 6, 10,'帐    号:[20]                卡折标志:[10]                       帐    号:[20]',#CARDNO,#CZTYPE,#CARDNO);
	print( 7, 10,'存入金额:[20]                账户金额:[20]             存入金额:[20]',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)),ltrim(comma(itoa(val(substr($FD26,8,12),0.01),'%15.2f'),16)),ltrim(comma(itoa(#TXAMT,'%15.2f'),16)));
	print( 8, 10,'可用金额:[20]                交易日期:[8] [8]                可用金额:[20]',ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16)),$HDATE,@txtime,ltrim(comma(itoa(val(substr($FD26,28,12),0.01),'%-15.2f'),16)));
	print( 9, 10,'存款检索号:[12]                      行内记账手续费:[10]                 平台流水:[12]',substr(#YZ37,6,6),ltrim(comma(itoa(@feeamt,'%8.2f'),16)),substr($FD52,6,6));
	print(10, 10,'平台流水:[12]                        核心流水:[12]                     柜    员:[7]',substr($FD52,6,6),$FD4,$FD7);
	print(11, 10,'柜员流水:[12]                        柜    员:[7]          ',substr($FD126,2,6),$FD7);
	print(12, 10,'受 理 行:[30]                                                交易日期:[8]  [8]',$BRNAME,$HDATE,@txtime);
	}"
	
  </PRINT>
</RESPONSE>

<RESPONSE>
  <PACKAGE DEVICE="PRINTER" LINESPACE="22" DESC="请打印普通凭证" CHECK="$FD12?0000">
  NOTHING
  </PACKAGE>
  	<PRINT>
	"{
		dim @txtime  as string;
		dim @feetype as string;
		@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
		if($REPRINT=='true')
		{
			reprint_nx();
		}

		print_nxywpz1();
		print( 7,10,'本代他存款异常!请查看核心及平台流水以确认交易状态!');
		print( 8,10,'开户行名:[60]',#SBANKCODE);
		print( 9,10,'卡折标志:[4]',#CZTYPE);
		print( 10,10,'帐    号:[19]',#CARDNO);
		print( 11,10,'户    名:[50]',#CUSTNAME);
		print( 12,10,'存入金额:[50]',ltrim(comma(itoa(#TXAMT,'%15.2f'),16)));
		print(13,10,'平台流水号:[12]    存款检索号:[12]    核心流水:[6]',substr($FD52,6,6),#YZ37,$FD4);
		//print(11,10,'交易日期:[8]  [8]           柜员:[7]',$HDATE,@txtime,$FD7);
		print_snywpz2();
  	}"
  </PRINT>
</RESPONSE>
<!------RESPONSE>
<PACKAGE DEVICE="PRINTER"  LINESPACE="22" DESC="请打印专用凭证" CHECK="$FD4?000000">
NOTHING  
</PACKAGE> 
<PRINT> 
"{
	$KINDNO='00';
	dim @txtime  as string;
	@txtime=substr($SYSTIME,0,2)+':'+substr($SYSTIME,2,2)+':'+substr($SYSTIME,4,2);
	if($REPRINT=='true')
	{
		reprint_nx();
	}
	print_nxywpz1();
	printacdtl_1();
	print_snywpz2();
}"
</PRINT>
</RESPONSE----------->

</TRANSACTION>

