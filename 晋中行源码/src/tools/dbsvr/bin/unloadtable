#!/bin/ksh
###################################################################
##  名称:unloadtable                                             ##
##  功能:本shell用于将数据库表导入.dat数据文件中,以备loadtable用.##
##       .dat文件各个字段值用分隔符'|'分开。                     ##
##  编者：Li JunXu                                               ##
##  日期: 2003.01.18                                             ##
###################################################################
if [ $# -ne 3 ]
then
	echo "usage:unloadtable tablename username password."
	exit 0
fi

##准备工作
echo "set heading off   " >/tmp/$1.col
echo "set pagesize 0" >>/tmp/$1.col
echo "set linesize 800  " >>/tmp/$1.col
echo "set feedback off  " >>/tmp/$1.col
echo "set tab off       " >>/tmp/$1.col
echo "select column_name||',' from user_tab_columns where lower(table_name)='$1' order by column_id; " >> /tmp/$1.col

##产生select语句
echo "set heading off   " >/tmp/$1.sel
echo "set pagesize 0" >>/tmp/$1.sel
echo "set linesize 800  " >>/tmp/$1.sel
echo "set feedback off  " >>/tmp/$1.sel
echo "set tab off       " >>/tmp/$1.sel
echo "select " >>/tmp/$1.sel
echo `sqlplus -s $2/$3 < /tmp/$1.col` |sed "s/,/||'|'||/g" |sed "s/||$//g" >>/tmp/$1.sel

##生成dat文件
echo "from $1;" >>/tmp/$1.sel
sqlplus -s $2/$3 < /tmp/$1.sel >$1_tmp.dat
#awk '{if(FNR!=1) print $0}' $1_tmp.dat >$1.dat
#rm -f $1_tmp.dat
mv $1_tmp.dat $1.dat
